<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scanner Emocional - √Ålibis Digital</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tracking.js/1.1.3/tracking-min.js"></script>
  <style>
    body { background: linear-gradient(135deg, #0b1120, #1e3a8a); }
    .hidden { display: none; }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .loading-dots::after { content: '...'; animation: dots 1.5s infinite; }
    @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } }
    .futuristic-btn {
      background: linear-gradient(45deg, #22d3ee, #3b82f6);
      transition: background 0.3s ease;
    }
    .futuristic-btn:hover {
      background: linear-gradient(45deg, #3b82f6, #22d3ee);
    }
    .shine { animation: shine 2s infinite; }
    @keyframes shine {
      0% { text-shadow: 0 0 5px #22d3ee; }
      50% { text-shadow: 0 0 20px #22d3ee, 0 0 30px #3b82f6; }
      100% { text-shadow: 0 0 5px #22d3ee; }
    }
    .neon-box { border: 1px solid #22d3ee; padding: 20px; border-radius: 10px; background: rgba(255, 255, 255, 0.05); }
    .animate-on-scroll.active { animation: slideIn 0.5s ease-out; }
    @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .face-guide { position: absolute; width: 320px; height: 240px; border: 2px dashed #22d3ee; box-sizing: border-box; pointer-events: none; }
    .scanner-container { display: flex; flex-direction: column; align-items: center; }
    .video-container { position: relative; width: 320px; height: 240px; }
    .ppg-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); }
    .ppg-overlay.active { display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .ppg-stay-still { color: #22d3ee; font-size: 1.2rem; margin-bottom: 10px; }
    .ppg-progress-container { width: 80%; height: 10px; background: #333; border-radius: 5px; }
    .ppg-progress-bar { height: 100%; background: #22d3ee; width: 0%; transition: width 0.1s linear; border-radius: 5px; }
    .voice-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); }
    .voice-overlay.active { display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .voice-instruction { color: #22d3ee; font-size: 1.2rem; margin-bottom: 10px; }
    .voice-waveform { width: 80%; height: 50px; background: #111; border-radius: 5px; }
  </style>
</head>
<body class="text-white font-sans">
  <div id="particles-js" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;"></div>
  <div id="particles-fallback" class="hidden text-center text-gray-400 p-4">Particle effect failed to load. Please check your internet connection.</div>

  <!-- Header -->
  <header class="fixed top-0 left-0 w-full z-50 transition-shadow duration-300 bg-opacity-90 bg-gray-900">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center">
        <a href="#" aria-label="P√°gina inicial da √Ålibis Digital">
          <img src="/assets/logo.png" alt="Logo da √Ålibis Digital" class="h-10 w-auto" onerror="this.src='https://via.placeholder.com/100x40?text=Logo'; console.error('Erro ao carregar logo.png')">
        </a>
        <div class="ml-4">
          <select class="bg-transparent text-white p-2 rounded">
            <option value="pt" selected>Portugu√™s</option>
            <option value="en">English</option>
          </select>
        </div>
      </div>
      <div class="flex items-center">
        <div class="md:hidden">
          <button id="hamburger-menu" class="text-white focus:outline-none p-2 rounded" aria-label="Abrir menu de navega√ß√£o">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke="currentColor" stroke-width="2" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </div>
      </div>
      <nav id="navbar" class="hidden md:flex space-x-6 text-sm items-center">
        <div class="dropdown relative">
          <button class="hover:text-[#22d3ee] transition flex items-center" aria-label="Abrir menu de servi√ßos">
            <svg class="http://www.w3.org/2000/svg" class="w-4 h-4 mr-6 mr-1" fill="none" viewBox="0 0 24 24" stroke="none">
              <path stroke-linecap="round" stroke="currentColor" stroke-width="2" stroke-linejoin="round" d="M5 12h14M12 5l-7 7m7 14l7-7"></path stroke-linecap="round">
            </svg>
            <span>Servi√ßos</span>
            <svg class="http://w.w3.org/2000/svg" fill="none" stroke="currentColor" class="w-4 h-4 ml-1" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke="currentColor" stroke-width="2" stroke-linejoin="round" d="M14 9l-7 7-7-7"></path stroke-linecap="round">
            </svg>
          </button>
          <div class="dropdown-menu">
            <a href="#" class="hover:text-[#22d3ee] transition">Scanner com IA</a>
            <a href="#" class="hover:text-[#22d3ee] transition">Avalia√ß√£o Emocional</a>
            <a href="#" class="hover:text-[#22d3ee] transition">Diagn√≥stico M√©dico</a>
            <a href="#" class="hover:text-[#22d3ee] transition">Criar √Ålibi</a>
          </div>
        </div>
        <a href="#" class="hover:text-[#22d3ee] transition">Blog</a>
        <a href="#planos" class="hover:text-[#22d3ee] transition">Planos</a>
        <a href="#" class="hover:text-[#22d3ee] transition">Suporte</a>
        <a href="#" class="futuristic-btn text-white font-semibold py-2 px-4 rounded-full text-sm shine" aria-label="Teste Gr√°tis">üîç Teste Gr√°tis</a>
      </nav>
    </div>
    <div id="mobile-menu" class="md:hidden bg-gray-800 bg-opacity-95 hidden py-4">
      <nav class="flex flex-col items-center">
        <div class="w-full">
          <button id="services-toggle" class="text-white text-center hover:bg-gray-700 py-2 px-4 rounded text-lg w-full flex justify-between items-center">
            <span>Servi√ßos</span>
            <svg class="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="2">
              <p stroke="evenodd" stroke="#fff" stroke-width="2" d="M14 9 7-7"></p>
            </svg>
          </button>
          <div class="dropdown-menu-mobile">
            <a href="#" class="hover:bg-gray-700">Scanner com IA</a>
            <a href="#" class="hover:bg-gray-700">Avalia√ß√£o Emocional</a>
            <a href="#" class="hover:bg-gray-700">Diagn√≥stico M√©dico</a>
            <a href="#" class="hover:bg-gray-700">Cria√ß√£o de √Ålibi</a>
          </div>
        </div>
        <a href="#" class="hover:bg-gray-700 text-white py-2 px-4 rounded text-lg w-full text-center">Blog</a>
        <a href="#planos" class="text-white py-2 px-4 rounded text-lg w-full text-center hover:bg-gray-700">Planos</a>
        <a href="#" class="hover:bg-gray-700 text-white py-2 px-4 rounded text-lg w-full text-center">Suporte</a>
        <a href="#" class="futuristic-btn text-white font-semibold py-2 px-4 rounded text-lg w-full text-center">üîç Teste Gr√°tis</a>
      </nav>
    </div>
  </header>
  <div class="h-20"></div>

  <!-- Main Content -->
  <section class="py-10 px-6 mx-auto text-center animate-on-scroll scanner-container" id="scanner">
    <h2 class="text-4xl font-bold mb-6 text-white shine">Seu rosto carrega sinais. Vamos descobrir o que ele diz?</h2>
    <p class="text-lg mb-8 text-gray-300 fade-in">Ative sua c√¢mera e receba um pr√©-diagn√≥stico emocional como se estivesse diante de um cl√≠nico experiente.</p>
    <div class="flex flex-col items-center mb-4">
      <div class="video-container">
        <video id="video" width="320" height="240" autoplay muted class="rounded-xl shadow-md border border-[#22d3ee]" aria-label="V√≠deo da c√¢mera"></video>
        <div id="face-guide" class="face-guide hidden"></div>
        <div id="ppg-overlay" class="ppg-overlay">
          <span class="ppg-stay-still">Fique parado</span>
          <div class="ppg-progress-container">
            <div id="ppg-progress-bar" class="ppg-progress-bar"></div>
          </div>
        </div>
        <div id="voice-overlay" class="voice-overlay">
          <span class="voice-instruction">Diga: Estou me sentindo bem hoje</span>
          <canvas id="voice-waveform" class="voice-waveform"></canvas>
        </div>
      </div>
      <div class="mt-4">
        <button onclick="startAnalysisWithDelay()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine" aria-label="Analisar Estado Emocional">Analisar Estado Emocional</button>
      </div>
      <div id="scanner-result" class="neon-box mt-6 text-left" style="display: none;"></div>
      <canvas id="canvas" width="320" height="240" style="display: none;"></canvas>
    </div>
  </section>

  <!-- Footer -->
  <footer class="bg-gray-900 bg-opacity-90 text-gray-400 py-12">
    <div class="max-w-6xl mx-auto px-6 grid grid-cols-1 md:grid-cols-3 gap-10 text-sm">
      <div class="fade-in">
        <h3 class="text-white text-2xl font-bold mb-4 shine">√Ålibis Digital</h3>
        <p class="fade-in">Solu√ß√µes de bem-estar com tecnologia avan√ßada.</p>
      </div>
      <div class="fade-in">
        <h4 class="text-white font-semibold mb-4">Navegue</h4>
        <ul class="space-y-2">
          <li><a href="#" class="hover:text-white transition">In√≠cio</a></li>
          <li><a href="#" class="hover:text-white transition">Scanner</a></li>
          <li><a href="#" class="hover:text-white transition">Blog</a></li>
          <li><a href="#" class="hover:text-white transition">Diagn√≥stico M√©dico</a></li>
          <li><a href="#" class="hover:text-white transition">Avalia√ß√£o Emocional</a></li>
          <li><a href="#" class="hover:text-white transition">Criar √Ålibi</a></li>
          <li><a href="#planos" class="hover:text-white transition">Planos</a></li>
          <li><a href="#" class="hover:text-white transition">Suporte</a></li>
          <li><a href="#" class="hover:text-white transition">Privacidade</a></li>
        </ul>
      </div>
      <div class="fade-in">
        <h4 class="text-white font-semibold mb-4">Contato</h4>
        <ul class="space-y-2">
          <li class="fade-in">E-mail: contato@alibisdigital.com</li>
          <li class="fade-in">WhatsApp: (11) 91234-5678</li>
        </ul>
      </div>
    </div>
    <div class="text-center mt-8">
      <p class="text-sm">¬© 2025 √Ålibis Digital. Todos os direitos reservados.</p>
    </div>
  </footer>

  <!-- Scripts -->
  <script>
    console.log('Loading scanner.html at:', new Date().toISOString());

    // Inicializar part√≠culas
    function initializeParticles() {
      if (typeof particlesJS !== 'undefined') {
        particlesJS('particles-js', {
          particles: {
            number: { value: 80, density: { enable: true, value_area: 800 } },
            color: { value: '#22d3ee' },
            shape: { type: 'circle' },
            opacity: { value: 0.5, random: true },
            size: { value: 3, random: true },
            line_linked: { enable: true, distance: 150, color: '#22d3ee', opacity: 0.4, width: 1 },
            move: { enable: true, speed: 2, direction: 'none', random: true }
          },
          interactivity: {
            detect_on: 'canvas',
            events: { onhover: { enable: true, mode: 'repulse' }, onclick: { enable: true, mode: 'push' } }
          },
          retina_detect: true
        });
        console.log('Particles.js loaded successfully');
      } else {
        console.error('particlesJS not loaded - showing fallback');
        document.getElementById('particles-fallback').classList.remove('hidden');
      }
    }

    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      initializeParticles();
    } else {
      window.addEventListener('DOMContentLoaded', initializeParticles);
    }

    // Verificar prefer√™ncia de motion reduzida
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      particlesJS('particles-js', { particles: { number: { value: 0 } } });
      console.log('Reduced motion detected - particles disabled');
    }

    // Verificar se est√° em servidor seguro
    if (window.location.protocol === 'file:') {
      alert('Erro: Este aplicativo requer um servidor local (ex.: http://localhost). Use "python -m http.server 8000" e acesse via http://localhost:8000/scanner.html.');
    }

    // Configurar menu mobile
    document.addEventListener('DOMContentLoaded', () => {
      const hamburger = document.getElementById('hamburger-menu');
      const mobileMenu = document.getElementById('mobile-menu');
      const servicesToggle = document.getElementById('services-toggle');
      const servicesMenu = document.getElementById('services-menu');

      if (hamburger && mobileMenu) {
        hamburger.addEventListener('click', () => {
          mobileMenu.classList.toggle('hidden');
        });
      }

      if (servicesToggle && servicesMenu) {
        servicesToggle.addEventListener('click', () => {
          servicesMenu.classList.toggle('hidden');
        });
      }

      // Anima√ß√µes de scroll
      const elements = document.querySelectorAll('.animate-on-scroll');
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('active');
            observer.unobserve(entry.target);
          }
        });
      }, { threshold: 0.1 });
      elements.forEach(element => observer.observe(element));
    });
  </script>

  <script>
    // Substitua pelas suas chaves reais da Face++ API
    const apiKey = 'SUA_CHAVE_API_AQUI';
    const apiSecret = 'SUA_CHAVE_SECRETA_AQUI';

    // Equaliza√ß√£o de histograma (inspirada pelo artigo)
    function equalizeHistogram(imageData) {
      const data = imageData.data;
      const width = imageData.width;
      const height = imageData.height;
      const histogram = new Array(256).fill(0);
      const cdf = new Array(256).fill(0);

      for (let i = 0; i < data.length; i += 4) {
        const r = data[i], g = data[i + 1], b = data[i + 2];
        const luminance = Math.round(0.299 * r + 0.587 * g + 0.114 * b);
        histogram[luminance]++;
      }

      cdf[0] = histogram[0];
      for (let i = 1; i < 256; i++) {
        cdf[i] = cdf[i - 1] + histogram[i];
      }

      const cdfMin = cdf.find(val => val > 0);
      const totalPixels = width * height;
      for (let i = 0; i < 256; i++) {
        cdf[i] = Math.round(((cdf[i] - cdfMin) / (totalPixels - cdfMin)) * 255);
      }

      for (let i = 0; i < data.length; i += 4) {
        const r = data[i], g = data[i + 1], b = data[i + 2];
        const luminance = Math.round(0.299 * r + 0.587 * g + 0.114 * b);
        const newValue = cdf[luminance];
        data[i] = data[i + 1] = data[i + 2] = newValue;
      }

      return imageData;
    }

    // FFT simples para PPG
    function fft(signal) {
      const n = signal.length;
      if (n <= 1) return signal;
      const even = [], odd = [];
      for (let i = 0; i < n; i++) {
        if (i % 2 === 0) even.push(signal[i]);
        else odd.push(signal[i]);
      }
      const evenFFT = fft(even), oddFFT = fft(odd);
      const result = new Array(n).fill(0);
      for (let i = 0; i < n / 2; i++) {
        const theta = -2 * Math.PI * i / n;
        const t = { re: Math.cos(theta) * oddFFT[i], im: Math.sin(theta) * oddFFT[i] };
        result[i] = evenFFT[i] + t.re;
        result[i + n / 2] = evenFFT[i] - t.re;
      }
      return result;
    }

    function getDominantFrequency(signal, sampleRate) {
      const n = signal.length;
      const fftResult = fft(signal);
      const magnitudes = fftResult.slice(0, n / 2).map(val => Math.sqrt(val * val));
      let maxMag = 0, maxIndex = 0;
      for (let i = 1; i < magnitudes.length; i++) {
        if (magnitudes[i] > maxMag) {
          maxMag = magnitudes[i];
          maxIndex = i;
        }
      }
      return maxIndex * sampleRate / n;
    }

    // Visualizar onda sonora
    function drawWaveform(analyser, canvas, ctx) {
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#22d3ee';
      ctx.lineWidth = 2;
      ctx.beginPath();

      const draw = () => {
        analyser.getByteTimeDomainData(dataArray);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.beginPath();
        const sliceWidth = canvas.width / bufferLength;
        let x = 0;
        for (let i = 0; i < bufferLength; i++) {
          const v = dataArray[i] / 128.0;
          const y = v * canvas.height / 2;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
          x += sliceWidth;
        }
        ctx.lineTo(canvas.width, canvas.height / 2);
        ctx.strokeStyle = '#22d3ee';
        ctx.stroke();
        if (canvas.isConnected) requestAnimationFrame(draw);
      };
      draw();
    }

    // Gerar diagn√≥stico
    function generateDiagnosis(primaryEmotion, heartRate, voiceEmotion, age) {
      const emotionPortuguese = {
        sadness: 'tristeza', anger: 'raiva', happiness: 'felicidade', surprise: 'surpresa',
        neutral: 'neutro', fear: 'medo', disgust: 'nojo'
      };
      const voiceEmotionPortuguese = {
        anxious: 'ansiedade', calm: 'calma', sad: 'tristeza'
      };
      const primaryEmotionInPortuguese = emotionPortuguese[primaryEmotion] || primaryEmotion;
      const voiceEmotionInPortuguese = voiceEmotionPortuguese[voiceEmotion] || voiceEmotion;
      const ageRangeMin = Math.max(18, age - 5);
      const ageRangeMax = age + 5;
      let diagnosis = '', suggestion = '', heartRateStatus = '', combinedAnalysis = '';

      if (heartRate < 60) {
        heartRateStatus = 'abaixo do normal, sugerindo relaxamento ou poss√≠vel bradicardia.';
      } else if (heartRate > 100) {
        heartRateStatus = 'elevada, indicando poss√≠vel estresse ou atividade f√≠sica.';
      } else {
        heartRateStatus = 'normal, refletindo um estado est√°vel.';
      }

      if (heartRate > 100 && voiceEmotion === 'anxious' && ['anger', 'fear', 'surprise'].includes(primaryEmotion)) {
        combinedAnalysis = `Alta frequ√™ncia card√≠aca (${heartRate} bpm), tom de voz ansioso e express√£o facial (${primaryEmotionInPortuguese}) sugerem estresse ou agita√ß√£o.`;
        suggestion = 'Tente exerc√≠cios de respira√ß√£o profunda ou uma pausa relaxante.';
      } else if (primaryEmotion === 'sadness' && voiceEmotion === 'sad' && heartRate < 80) {
        combinedAnalysis = `Express√£o facial de tristeza, tom de voz triste e frequ√™ncia card√≠aca baixa (${heartRate} bpm) indicam um estado de introspec√ß√£o ou melancolia.`;
        suggestion = 'Escreva seus pensamentos ou experimente uma atividade que traga conforto.';
      } else if (primaryEmotion === 'happiness' && voiceEmotion === 'calm' && heartRate >= 60 && heartRate <= 100) {
        combinedAnalysis = `Express√£o facial de felicidade, tom de voz calmo e frequ√™ncia card√≠aca normal (${heartRate} bpm) refletem bem-estar.`;
        suggestion = 'Aproveite essa energia positiva para se conectar com amigos ou realizar algo criativo.';
      } else {
        combinedAnalysis = `Emo√ß√£o facial: ${primaryEmotionInPortuguese}, tom de voz: ${voiceEmotionInPortuguese}, frequ√™ncia card√≠aca: ${heartRate} bpm (${heartRateStatus}). Os sinais n√£o convergem completamente, indicando um estado emocional misto.`;
        suggestion = 'Reflita sobre o que pode estar influenciando seu estado atual.';
      }

      diagnosis = combinedAnalysis;

      return { diagnosis, suggestion, heartRate, voiceEmotionInPortuguese, primaryEmotionInPortuguese, ageRangeMin, ageRangeMax };
    }

    // Iniciar an√°lise
    async function startAnalysisWithDelay() {
      const result = document.getElementById('scanner-result');
      result.style.display = 'block';
      result.innerHTML = '<p class="fade-in">üìñ A an√°lise come√ßar√° em 5 segundos...</p>';
      await new Promise(resolve => setTimeout(resolve, 5000));
      captureAndAnalyze();
    }

    // Capturar e analisar
    async function captureAndAnalyze() {
      console.log('Iniciando an√°lise facial, card√≠aca e vocal...');
      const canvas = document.getElementById('canvas');
      const video = document.getElementById('video');
      const result = document.getElementById('scanner-result');
      const faceGuide = document.getElementById('face-guide');
      const ppgOverlay = document.getElementById('ppg-overlay');
      const ppgProgressBar = document.getElementById('ppg-progress-bar');
      const voiceOverlay = document.getElementById('voice-overlay');
      const voiceWaveform = document.getElementById('voice-waveform');
      let videoStream = null, audioStream = null;

      if (!canvas || !video || !result || !faceGuide || !ppgOverlay || !ppgProgressBar || !voiceOverlay || !voiceWaveform) {
        console.error('Elementos necess√°rios n√£o encontrados');
        result.innerHTML = '<p class="fade-in">üö´ Erro interno: elementos da p√°gina n√£o encontrados.</p>';
        return;
      }

      // Inicializar c√¢mera
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        video.srcObject = videoStream;
        video.classList.remove('hidden');
        console.log('C√¢mera inicializada com sucesso');
      } catch (error) {
        console.error('Erro ao acessar a c√¢mera:', error);
        result.innerHTML = '<p class="fade-in">üö´ Erro: n√£o foi poss√≠vel acessar a c√¢mera. Permita o acesso e tente novamente.</p><div class="mt-4"><button onclick="startAnalysisWithDelay()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine">Tentar Novamente</button></div>';
        return;
      }

      // Verificar brilho
      const context = canvas.getContext('2d');
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      let imageData = context.getImageData(0, 0, canvas.width, canvas.height);
      imageData = equalizeHistogram(imageData);
      context.putImageData(imageData, 0, 0);

      let brightnessSum = 0;
      for (let i = 0; i < imageData.data.length; i += 4) {
        const r = imageData.data[i], g = imageData.data[i + 1], b = imageData.data[i + 2];
        brightnessSum += (0.299 * r + 0.587 * g + 0.114 * b);
      }
      const averageBrightness = brightnessSum / (imageData.data.length / 4);
      if (averageBrightness < 30) {
        result.innerHTML = '<p class="fade-in">üåô A ilumina√ß√£o est√° muito baixa. Ajuste a luz e tente novamente.</p><div class="mt-4"><button onclick="startAnalysisWithDelay()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine">Tentar Novamente</button></div>';
        if (videoStream) videoStream.getTracks().forEach(track => track.stop());
        video.classList.add('hidden');
        return;
      }

      // Detectar rosto
      let faceRect = null;
      const tracker = new tracking.ObjectTracker('face');
      tracker.setInitialScale(4);
      tracker.setStepSize(2);
      tracker.setEdgesDensity(0.1);
      tracking.track('#video', tracker);
      faceGuide.classList.remove('hidden');

      tracker.on('track', event => {
        if (event.data.length > 0) {
          faceRect = event.data[0];
          const guide = document.getElementById('face-guide');
          if (faceRect) {
            const centerX = faceRect.x + faceRect.width / 2;
            const centerY = faceRect.y + faceRect.height / 2;
            const offsetX = (canvas.width / 2 - centerX) / canvas.width * 100;
            const offsetY = (canvas.height / 2 - centerY) / canvas.height * 100;
            guide.style.transform = `translate(${offsetX}%, ${offsetY}%)`;
            if (Math.abs(offsetX) > 20 || Math.abs(offsetY) > 20) {
              result.innerHTML = '<p class="fade-in">ü§î Ajuste seu rosto para o centro do quadro.</p><div class="mt-4"><button onclick="startAnalysisWithDelay()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine">Tentar novamente</button></div>';
              tracker.stop();
              faceGuide.classList.add('hidden');
              if (videoStream) videoStream.getTracks().forEach(track => track.stop());
              video.classList.add('hidden');
            }
          }
        }
      });

      let faceDetected = false;
      for (let i = 0; i < 50; i++) {
        if (faceRect) {
          faceDetected = true;
          console.log('Rosto detectado com sucesso');
          break;
        }
        await new Promise(resolve => setTimeout(resolve, 100));
      }

      if (!faceDetected) {
        result.innerHTML = '<p class="fade-in">ü§î N√£o foi poss√≠vel detectar seu rosto. Centralize-se na c√¢mera.</p><div class="mt-4"><button onclick="startAnalysisWithDelay()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine">Tentar novamente</button></div>';
        tracker.stop();
        faceGuide.classList.add('hidden');
        if (videoStream) videoStream.getTracks().forEach(track => track.stop());
        video.classList.add('hidden');
        return;
      }

      // Medi√ß√£o PPG
      const PPG_DURATION = 15;
      const FRAME_RATE = 30;
      const greenValues = [];
      let startTime = Date.now();
      result.innerHTML = '<p class="fade-in">‚ù§Ô∏è Fique parado por 15 segundos para medir a frequ√™ncia card√≠aca.</p>';
      ppgOverlay.classList.add('active');

      while ((Date.now() - startTime) / 1000 < PPG_DURATION) {
        const elapsed = (Date.now() - startTime) / 1000;
        const progress = (elapsed / PPG_DURATION) * 100;
        ppgProgressBar.style.width = `${progress}%`;

        if (!faceRect || Math.abs((canvas.width / 2 - (faceRect.x + faceRect.width / 2)) / canvas.width * 100) > 20 || Math.abs((canvas.height / 2 - (faceRect.y + faceRect.height / 2)) / canvas.height * 100) > 20) {
          result.innerHTML = '<p class="fade-in">üñãÔ∏è Movimenta√ß√£o detectada. Fique parado.</p><div class="mt-4"><button onclick="startAnalysisWithDelay()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine">Tentar novamente</button></div>';
          ppgOverlay.classList.remove('active');
          tracker.stop();
          faceGuide.classList.add('hidden');
          if (videoStream) videoStream.getTracks().forEach(track => track.stop());
          video.classList.add('hidden');
          return;
        }

        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const foreheadX = Math.floor(faceRect.x + faceRect.width * 0.3);
        const foreheadY = Math.floor(faceRect.y + faceRect.height * 0.2);
        const foreheadWidth = Math.floor(faceRect.width * 0.4);
        const foreheadHeight = Math.floor(faceRect.height * 0.2);
        let foreheadData = context.getImageData(foreheadX, foreheadY, foreheadWidth, foreheadHeight);
        foreheadData = equalizeHistogram(foreheadData);
        context.putImageData(foreheadData, foreheadX, foreheadY);

        let greenSum = 0, pixelCount = 0;
        for (let i = 0; i < foreheadData.data.length; i += 4) {
          greenSum += foreheadData.data[i + 1];
          pixelCount++;
        }
        const averageGreen = greenSum / pixelCount;
        greenValues.push(averageGreen);
        await new Promise(resolve => setTimeout(resolve, 1000 / FRAME_RATE));
      }

      ppgOverlay.classList.remove('active');

      // Calcular frequ√™ncia card√≠aca
      let heartRate = 0;
      try {
        const mean = greenValues.reduce((a, b) => a + b, 0) / greenValues.length;
        const detrended = greenValues.map(val => val - mean);
        const maxVal = Math.max(...detrended.map(Math.abs));
        const normalized = detrended.map(val => val / maxVal);
        const freq = getDominantFrequency(normalized, FRAME_RATE);
        heartRate = Math.round(freq * 60);
        if (heartRate < 40 || heartRate > 180) {
          throw new Error('Frequ√™ncia card√≠aca fora do alcance realista');
        }
      } catch (error) {
        console.error('Erro na PPG:', error);
        heartRate = Math.floor(60 + Math.random() * 40); // Fallback
      }

      // An√°lise de voz
      result.innerHTML = '<p class="fade-in">üéôÔ∏è Diga: "Estou me sentindo bem hoje" por 5 segundos...</p>';
      voiceOverlay.classList.add('active');
      let voiceEmotion = 'calm';
      try {
        audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioContext.createMediaStreamSource(audioStream);
        const analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        source.connect(analyser);

        const waveformCtx = voiceWaveform.getContext('2d');
        drawWaveform(analyser, voiceWaveform, waveformCtx);

        const VOICE_DURATION = 5;
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        let energySum = 0, frameCount = 0;
        startTime = Date.now();

        while ((Date.now() - startTime) / 1000 < VOICE_DURATION) {
          analyser.getByteTimeDomainData(dataArray);
          let sum = 0;
          for (let i = 0; i < bufferLength; i++) {
            const amplitude = (dataArray[i] - 128) / 128;
            sum += amplitude * amplitude;
          }
          energySum += sum / bufferLength;
          frameCount++;
          await new Promise(resolve => setTimeout(resolve, 1000 / 60));
        }

        audioStream.getTracks().forEach(track => track.stop());
        audioContext.close();
        voiceOverlay.classList.remove('active');

        const averageEnergy = energySum / frameCount;
        if (averageEnergy > 0.5) voiceEmotion = 'anxious';
        else if (averageEnergy < 0.2) voiceEmotion = 'sad';

        console.log('Energia vocal m√©dia:', averageEnergy, 'Emo√ß√£o:', voiceEmotion);
      } catch (error) {
        console.error('Erro ao acessar o microfone:', error);
        result.innerHTML = '<p class="fade-in">üöñ Erro: n√£o foi poss√≠vel acessar o microfone. Permita o acesso e tente novamente.</p><div class="mt-4"><button onclick="startAnalysisWithDelay()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine">Tentar Novamente</button></div>';
        voiceOverlay.classList.remove('active');
        if (videoStream) {
          videoStream.getTracks().forEach(track => track.stop());
          video.classList.add('hidden');
        }
        tracker.stop();
        return;
      }

      // Capturar imagem para Face++ API
      result.innerHTML = '<p class="fade-in">üîç Analisando express√£o facial...</p>';
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      imageData = context.getImageData(0, 0, canvas.width, canvas.height);
      imageData = equalizeHistogram(imageData);
      context.putImageData(imageData, 0, 0);
      const imageBase64 = canvas.toDataURL('image/jpeg').split(',')[1];

      // Enviar para Face++ API
      const formData = new FormData();
      formData.append('api_key', apiKey);
      formData.append('api_secret', apiSecret);
      formData.append('image_base64', imageBase64);
      formData.append('return_attributes', 'emotion,age');

      try {
        const response = await fetch('https://api-us.faceplusplus.com/facepp/v3/detect', {
          method: 'POST',
          body: formData
        });
        const data = await response.json();
        console.log('Resposta da API Face++:', data);

        if (data.faces && data.faces.length > 0) {
          const face = data.faces[0];
          const emotion = face.attributes.emotion;
          const emotionsSorted = Object.entries(emotion).sort((a, b) => b[1] - a[1]);
          const primaryEmotion = emotionsSorted[0][0];
          const confidence = emotionsSorted[0][1];
          const age = face.attributes.age.value;

          if (confidence >= 50) {
            const diag = generateDiagnosis(primaryEmotion, heartRate, voiceEmotion, age);
            result.innerHTML = `
              <h3 class="text-2xl font-bold mb-4 fade-in">Resultado do Diagn√≥stico</h3>
              <p class="fade-in"><strong>Emo√ß√£o Facial:</strong> ${diag.primaryEmotionInPortuguese.charAt(0).toUpperCase() + diag.primaryEmotionInPortuguese.slice(1)}</p>
              <p class="fade-in"><strong>Frequ√™ncia Card√≠aca:</strong> ${diag.heartRate} bpm</p>
              <p class="fade-in"><strong>Emo√ß√£o Vocal:</strong> ${diag.voiceEmotionInPortuguese.charAt(0).toUpperCase() + diag.voiceEmotionInPortuguese.slice(1)}</p>
              <p class="fade-in"><strong>Idade Estimada:</strong> Entre ${diag.ageRangeMin} e ${diag.ageRangeMax} anos</p>
              <p class="fade-in mt-2">${diag.diagnosis}</p>
              <p class="fade-in mt-2"><strong>Sugest√£o:</strong> ${diag.suggestion}</p>
              <div class="mt-4"><button onclick="startAnalysisWithDelay()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine">Analisar Novamente</button></div>
            `;
          } else {
            result.innerHTML = '<p class="fade-in">üö´ Emo√ß√£o facial n√£o detectada com confian√ßa suficiente.</p><div class="mt-4"><button onclick="startAnalysisWithDelay()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine">Tentar Novamente</button></div>';
          }
        } else {
          result.innerHTML = '<p class="fade-in">üö´ Nenhum rosto detectado na imagem.</p><div class="mt-4"><button onclick="startAnalysisWithDelay()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine">Tentar Novamente</button></div>';
        }
      } catch (error) {
        console.error('Erro ao conectar com a API:', error);
        result.innerHTML = '<p class="fade-in">üö´ Erro ao conectar com a API. Verifique sua conex√£o.</p><div class="mt-4"><button onclick="startAnalysisWithDelay()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine">Tentar Novamente</button></div>';
      } finally {
        if (videoStream) {
          videoStream.getTracks().forEach(track => track.stop());
          video.classList.add('hidden');
        }
        tracker.stop();
        faceGuide.classList.add('hidden');
      }
    }
  </script>
</body>
</html>
