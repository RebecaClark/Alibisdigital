<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scanner Emocional - Álibis Digital</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tracking.js/1.1.3/tracking-min.js"></script>
  <style>
    body { background: linear-gradient(135deg, #0b1120, #1e3a8a); }
    .hidden { display: none; }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .loading-dots::after { content: '...'; animation: dots 1.5s infinite; }
    @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } }
    .futuristic-btn {
      background: linear-gradient(45deg, #22d3ee, #3b82f6);
      transition: background 0.3s ease;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
    }
    .futuristic-btn:hover {
      background: linear-gradient(45deg, #3b82f6, #22d3ee);
    }
    .shine { animation: shine 2s infinite; }
    @keyframes shine {
      0% { text-shadow: 0 0 5px #22d3ee; }
      50% { text-shadow: 0 0 20px #22d3ee, 0 0 30px #3b82f6; }
      100% { text-shadow: 0 0 5px #22d3ee; }
    }
    .neon-box { 
      border: 1px solid #22d3ee; 
      padding: 1rem; 
      border-radius: 10px; 
      background: rgba(255, 255, 255, 0.05); 
      overflow-wrap: break-word;
    }
    .animate-on-scroll.active { animation: slideIn 0.5s ease-out; }
    @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .face-guide { 
      position: absolute; 
      width: 100%; 
      height: 100%; 
      border: 2px dashed #22d3ee; 
      box-sizing: border-box; 
      pointer-events: none; 
    }
    .scanner-container { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      max-width: 100%;
      padding: 1rem;
    }
    .video-container { 
      position: relative; 
      width: min(90vw, 320px); 
      height: min(67.5vw, 240px); 
    }
    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .ppg-overlay { 
      display: none; 
      position: absolute; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0, 0, 0, 0.5); 
    }
    .ppg-overlay.active { 
      display: flex; 
      flex-direction: column; 
      justify-content: center; 
      align-items: center; 
    }
    .ppg-stay-still { 
      color: #22d3ee; 
      font-size: 1rem; 
      margin-bottom: 0.5rem; 
    }
    .ppg-progress-container { 
      width: 80%; 
      height: 8px; 
      .ppg-progress-background-background 
      border-radius: 3px; 
    }
    .ppg-progress-bar { 
      height: 100%; 
      background: #22d3ee; 
      width: 0%; 
      transition: width 0.3s linear; 
      border-radius: 3px; 
    }
    .voice-overlay { 
      display: none; 
      position: absolute; 
      top: 0; 
      left: 0; 
      width: 100%; 
      background: inherit; 
    }
    .voice-overlay.active { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
    }
    .voice-instruction { 
      color: #22d3ee; 
      font-size: 1rem; 
      margin-bottom: 0.5rem; 
    }
    .voice-waveform { 
      width: 80%; 
      height: 2rem; 
      background: #111; 
      border-radius: 3px; 
    }

    @media screen and (max-width: 640px) {
      h2 { 
        font-size: 1.5rem; 
      }
      p { 
        font-size: 1rem; 
      }
      .futuristic-btn { 
        padding: 0.5rem 1rem; 
        font-size: 0.875rem; 
      }
      .neon-box { 
        padding: 0.75rem; 
        font-size: 0.9rem; 
      }
      .scanner-container { 
        padding: 0.5rem; 
      }
    }
  </style>
</head>
<body class="text-white font-sans">
  <div id="particles-js" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;"></div>
  <div id="particles-fallback" class="hidden text-center text-gray-400 p-4">Particle effect failed to load. Please check your internet connection.</div>

  <!-- Header -->
  <header class="fixed top-0 left-0 w-full z-50 transition-shadow duration-300 bg-opacity-90 bg-gray-900">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center">
        <a href="#" aria-label="Página inicial da Álibis Digital">
          <img src="/assets/logo.png" alt="Logo da Álibis Digital" class="h-10 w-auto" onerror="this.src='https://via.placeholder.com/100x40?text=Logo'; console.error('Erro ao carregar logo.png')">
        </a>
      </div>
      <div class="flex items-center">
        <div class="md:hidden">
          <button id="hamburger-menu" class="text-white focus:outline-none p-2 rounded" aria-label="Abrir menu de navegação">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <svg path stroke-linecap="round" stroke="currentColor" stroke-width="2" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </div>
      </div>
      <nav id="navbar" class="hidden md:flex space-x-6 text-sm items-center">
        <div class="dropdown relative">
          <button class="hover:text-[#22d3ee] transition flex items-center" aria-label="Abrir menu de serviços">
            <svg class="http://www.w3.org/2000/svg" class="w-4 h-4 mr-6 mr-1" fill="none" viewBox="0 0 24 24" stroke="none">
              <svg path stroke-linecap="round" stroke="currentColor" stroke-width="2" stroke-linejoin="round" d="M5 12h14M12 5l-7 7m7 14l7-7"></path stroke-linecap="round">
            </svg>
            <span>Serviços</span>
            <svg class="http://w.w3.org/2000/svg" fill="none" stroke="currentColor" class="stroke">            <svg class="w-4 h-4 ml-1" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke="currentColor" stroke-width="2" stroke-linejoin="round" d="M14 9l-7 7-7-7"></path stroke-linecap="round">
            </svg>
          </button>
          <div class="dropdown-menu">
            <a href="#" class="hover:text-[#22d3ee] transition">Scanner com IA</a>
            <a href="#" class="hover:text-[#22d3ee] transition">Avaliação Emocional</a>
            <a href="#" class="hover:text-[#22d3ee] transition">Diagnóstico Médico</a>
            <a href="#" class="hover:text-[#22d3ee] transition">Criar Álibi</a>
          </div>
        </div>
        <a href="#" class="hover:text-[#22d3ee] transition">Blog</a>
        <a href="#planos" class="hover:text-[#22d3ee] transition">Planos</a>
        <a href="#" class="hover:text-[#22d3ee] transition">Suporte</a>
        <a href="#" class="futuristic-btn text-white font-semibold py-2 px-4 rounded-full text-sm shine" aria-label="Teste Grátis">🔍 Teste Grátis</a>
      </nav>
    </div>
    <div id="mobile-menu" class="md:hidden bg-gray-800 bg-opacity-95 hidden py-4">
      <nav class="flex flex-col items-center">
        <div class="w-full">
          <button id="services-toggle" class="text-white text-center hover:bg-gray-700 py-2 px-4 rounded text-lg w-full flex justify-between items-center">
            <span>Serviços</span>
            <svg class="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="2">
              <p stroke="evenodd" stroke="#fff" stroke-width="2" d="M14 9 7-7"></p>
            </svg>
          </button>
          <div class="dropdown-menu-mobile">
            <a href="#" class="hover:bg-gray-700">Scanner com IA</a>
            <a href="#" class="hover:bg-gray-700">Avaliação Emocional</a>
            <a href="#" class="hover:bg-gray-700">Diagnóstico Médico</a>
            <a href="#" class="hover:bg-gray-700">Criação de Álibi</a>
          </div>
        </div>
        <a href="#" class="hover:bg-gray-700 text-white py-2 px-4 rounded text-lg w-full text-center">Blog</a>
        <a href="#planos" class="text-white py-2 px-4 rounded text-lg w-full text-center hover:bg-gray-700">Planos</a>
        <a href="#" class="hover:bg-gray-700 text-white py-2 px-4 rounded text-lg w-full text-center">Suporte</a>
        <a href="#" class="futuristic-btn text-white font-semibold py-2 px-4 rounded text-lg w-full text-center">🔍 Teste Grátis</a>
      </nav>
    </div>
  </header>
  <!-- Espaço para header fixo -->
  <div class="h-16"></div>

  <!-- Main Content -->
  <section class="py-6 px-4 mx-auto text-center animate-on-scroll scanner-container" id="scanner">
    <h2 class="text-3xl font-bold mb-4 text-white shine">Seu rosto carrega sinais. Vamos descobrir o que ele diz?</h2>
    <p class="text-base mb-6 text-gray-300 fade-in">Ative a câmera e receba um diagnóstico detalhada como se estivesse diante de um clínico experiente."></p>
    <div class="flex flex-col items-center">
      <div class="video-container">
        <video id="video" autoplay playsinline muted class="rounded-xl shadow-md border border-[#22d3ee]" aria-label="Vídeo da câmera"></video>
        <div id="face-guide" class="face-guide hidden"></div>
        <div id="ppg-overlay" class="ppg-overlay">
          <span class="ppg-stay-still"></span>Fique parado
          <div class="ppg-progress-container">
            <div id="ppg-progress-bar" class="ppg-progress-bar"></div>
          </div>
        </div>
        <div id="voice-overlay" class="voice-overlay">
          <span class="voice-instruction"></span>Diga: Estou tranquilo hoje
          <canvas id="voice-waveform" class="voice-waveform"></canvas>
          </div>
      </div>
      <div class="mt-4">
        <button onclick="startAnalysis()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-center shine" aria-label="Analisar Estado Emocional">Analisar Estado Emocional</button>
      </div>
      <div id="scanner-result" class="neon-box mt-4 text-left" style="display: none;"></div>
      <canvas id="canvas" style="display: none;"></canvas>
    </div>
  </section>

  <footer class="bg-gray-900 bg-opacity-90 text-gray-400 py-8">
    <div class="max-w-full mx-auto px-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8 text-xs sm:text-sm">
      <div class="fade-in">
        <h3 class="text-white text-xl font-bold mb-3 shine">Álibis Digital</h3>
        <p class="fade-in">Soluções de bem-estar com tecnologia avançada.</p>
      </div>
      <div class="fade-in">
        <h4 class="text-white font-semibold mb-3">Navegue</h4>
        <ul class="space-y-1">
          <li><a href="#" class="hover:text-white transition">Início</a></li>
          <li><a href="#" class="hover:text-white transition">Scanner</a></li>
          <li><a href="#" class="hover:text-white transition">Blog</a></li>
          <li><a href="#" class="hover:text-white transition">Diagnóstico Médico</a></li>
          <li><a href="#" class="hover:text-white transition">Avaliação Emocional</a></li>
          <li><a href="#" class="hover:text-white transition">Criar Álibi</a></li>
          <li><a href="#planos" class="hover:text-white transition">Planos</a></li>
          <li><a href="#" class="hover:text-white transition">Suporte</a></li>
          <li><a href="#" class="hover:text-white transition">Privacidade</a></li>
        </ul>
      </div>
      <div class="fade-in">
        <h4 class="text-white font-semibold mb-3">Contato</h4>
        <ul class="space-y-1">
          <li class="fade-in">E-mail: contato@alibisdigital.com</li>
          <li class="fade-in">WhatsApp: (11) 91234-5678</li>
        </ul>
      </div>
    </div>
    <div class="text-center mt-6">
      <p class="text-xs sm:text-sm">© 2025 Álibis Digital. Todos os direitos reservados.</p>
    </div>
  </footer>

  <!-- Scripts -->
  <script>
    console.log('Loading scanner.html at:', new Date().toISOString());

    // Inicializar partículas
    function initializeParticles() {
      if (typeof particlesJS !== 'undefined') {
        particlesJS('particles-js', {
          particles: {
            number: { value: 60, density: { enable: true, value_area: 800 } },
            color: { value: '#22d3ee' },
            shape: { type: 'circle' },
            opacity: { value: 0.4, random: true },
            size: { value: 3, random: true },
            line_linked: { enable: true, distance: 150, color: '#22d3ee', opacity: 0.3, width: 1 },
            move: { enable: true, speed: 1.5, direction: 'none', random: true }
          },
          interactivity: {
            detect_on: 'canvas',
            events: { onhover: { enable: true, mode: 'repulse' }, onclick: { enable: true, mode: 'push' } }
          },
          retina_detect: true
        });
        console.log('Particles.js loaded successfully');
      } else {
        console.error('particlesJS not loaded - showing fallback');
        document.getElementById('particles-fallback').classList.remove('hidden');
      }
    }

    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      initializeParticles();
    } else {
      window.addEventListener('DOMContentLoaded', initializeParticles);
    }

    // Verificar preferência de motion reduzida
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      particlesJS('particles-js', { particles: { number: { value: 0 } } });
      console.log('Reduced motion detected - particles disabled');
    }

    // Verificar se está em servidor seguro
    if (window.location.protocol === 'file:') {
      alert('Erro: Este aplicativo requer um servidor local (ex.: http://localhost). Use "python -m http.server 8000" e acesse via http://localhost:8000/scanner.html.');
    }

    // Configurar menu mobile
    document.addEventListener('DOMContentLoaded', () => {
      const hamburger = document.getElementById('hamburger-menu');
      const mobileMenu = document.getElementById('mobile-menu');

      if (hamburger && mobileMenu) {
        hamburger.addEventListener('click', () => {
          mobileMenu.classList.toggle('hidden');
        });
      }

      // Animações de scroll
      const elements = document.querySelectorAll('.animate-on-scroll');
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('active');
            observer.unobserve(entry.target);
          }
        });
      }, { threshold: 0.1 });
      elements.forEach(element => observer.observe(element));
    });
  </script>

  <script>
    // Substitua pelas suas chaves reais da Face++ API
    const apiKey = 'SUA_CHAVE_API_AQUI';
    const apiSecret = 'SUA_CHAVE_SECRETA_AQUI';

    // Equalização de histograma
    function equalizeHistogram(imageData) {
      const data = imageData.data;
      const histogram = new Array(256).fill(0);
      const cdf = new Array(256).fill(0);

      for (let i = 0; i < data.length; i += 4) {
        const luminance = Math.round(0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2]);
        histogram[luminance]++;
      }

      cdf[0] = histogram[0];
      for (let i = 1; i < 256; i++) {
        cdf[i] = cdf[i - 1] + histogram[i];
      }

      const cdfMin = cdf.find(val => val > 0);
      const totalPixels = data.length / 4;
      for (let i = 0; i < 256; i++) {
        cdf[i] = Math.round(((cdf[i] - cdfMin) / (totalPixels - cdfMin)) * 255);
      }

      for (let i = 0; i < data.length; i += 4) {
        const luminance = Math.round(0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2]);
        const newValue = cdf[luminance];
        data[i] = data[i + 1] = data[i + 2] = newValue;
      }

      return imageData;
    }

    // Filtro passa-banda simples para PPG
    function bandpassFilter(signal, sampleRate) {
      const lowFreq = 0.8; // 48 bpm
      const highFreq = 2.5; // 150 bpm
      const n = signal.length;
      const filtered = new Array(n).fill(0);

      for (let i = 1; i < n - 1; i++) {
        if (i > 0 && i < n - 1) {
          filtered[i] = signal[i] - (signal[i - 1] + signal[i + 1]) / 2;
        }
      }
      return filtered;
    }

    // FFT simples
    function fft(signal) {
      const n = signal.length;
      if (n <= 1) return signal;
      const even = [], odd = [];
      for (let i = 0; i < n; i++) {
        if (i % 2 === 0) even.push(signal[i]);
        else odd.push(signal[i]);
      }
      const evenFFT = fft(even), oddFFT = fft(odd);
      const result = new Array(n).fill(0);
      for (let i = 0; i < n / 2; i++) {
        const theta = -2 * Math.PI * i / n;
        const t = Math.cos(theta) * oddFFT[i];
        result[i] = evenFFT[i] + t;
        result[i + n / 2] = evenFFT[i] - t;
      }
      return result;
    }

    function getDominantFrequency(signal, sampleRate) {
      const n = signal.length;
      const fftResult = fft(signal);
      const magnitudes = fftResult.slice(0, n / 2).map(val => Math.abs(val));
      let maxMag = 0, maxIndex = 0;
      for (let i = 1; i < magnitudes.length; i++) {
        const freq = i * sampleRate / n;
        if (freq >= 0.8 && freq <= 2.5 && magnitudes[i] > maxMag) {
          maxMag = magnitudes[i];
          maxIndex = i;
        }
      }
      return maxIndex * sampleRate / n;
    }

    // Visualizar onda sonora
    function drawWaveform(analyser, canvas, ctx) {
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.strokeStyle = '#22d3ee';
      ctx.lineWidth = 2;

      const draw = () => {
        analyser.getByteTimeDomainData(dataArray);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.beginPath();
        const sliceWidth = canvas.width / bufferLength;
        let x = 0;
        for (let i = 0; i < bufferLength; i++) {
          const v = dataArray[i] / 128.0;
          const y = v * canvas.height / 2;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
          x += sliceWidth;
        }
        ctx.stroke();
        if (canvas.getContext) requestAnimationFrame(draw);
      };
      draw();
    }

    // Gerar diagnóstico
    function generateDiagnosis(primaryEmotion, heartRate, voiceEmotion, age) {
      const emotionPortuguese = {
        sadness: 'tristeza', anger: 'raiva', happiness: 'felicidade', surprise: 'surpresa',
        neutral: 'neutro', fear: 'medo', disgust: 'nojo'
      };
      const voiceEmotionPortuguese = {
        anxious: 'ansiedade', calm: 'calma', sad: 'tristeza'
      };
      const primaryEmotionInPortuguese = emotionPortuguese[primaryEmotion)] || primaryEmotion;
      const voiceEmotionInPortuguese = voiceEmotionPortuguese[voiceEmotion] || voiceEmotion;
      const ageRangeMin = Math.max(18, age - 5);
      const ageRangeMax = age + 5;

      const randomChoice = (array) => array[Math.floor(Math.random() * array.length)];

      const scenarios = [
        {
          condition: heartRate > 100 && voiceEmotion === 'anxious' && ['anger', 'fear', 'surprise'].includes(primaryEmotion),
          diagnosis: randomChoice([
            `Sua frequência cardíaca elevada (${heartRate} bpm), tom de voz ansioso e expressão de ${primaryEmotionInPortuguese} sugerem estresse ou agitação.`
            `Você parece sob pressão, com batimentos acelerados (${heartRate} bpm), voz inquieta e emoção de ${primaryEmotionInPortuguese}.`,
            `Os sinais apontam para tensão: frequência cardíaca alta (${heartRate} bpm), tom ansioso e expressão de ${primaryEmotionInPortuguese}.`
          ]),
          suggestion: randomChoice([
            'Tente respirar fundo por 1 minuto, inspirando por 4 segundos e expirando por 6.',
            'Faça uma pausa e ouça uma música relaxante para acalmar a mente.',
            'Escreva o que está sentindo para organizar seus pensamentos.'
          ])
        },
        {
          condition: primaryEmotion === 'sadness' && voiceEmotion === 'sad' && heartRate < 80,
          diagnosis: randomChoice([
            `Sua expressão de tristeza, tom de voz triste e frequência cardíaca baixa (${heartRate} bpm) indicam um momento de melancolia.`,
            `Você parece introspectivo, com emoção de tristeza, voz calma e batimentos reduzidos (${heartRate} bpm).`,
            `Os sinais sugerem tristeza: expressão de ${primaryEmotionInPortuguese}, voz triste e frequência cardíaca baixa (${heartRate} bpm).`
          ]),
          suggestion: randomChoice([
            'Tente uma sessão de leve ou escreva sobre seus sentimentos.',
            'Converse com alguém próximo para compartilhar seus pensamentos.',
            'Dedique um momento a algo que te traga conforto.'
          ])
        },
        {
          condition: primaryEmotion === 'happyiness' && voiceEmotion === 'calm' && heartRate >= 60 && heartRate <= 100,
          diagnosis: randomChoice([
            `Sua expressão de felicidade, tom de voz calmo e frequência cardíaca normal (${heartRate} bpm) refletem um estado de bem-estar.`,
            `Você está em harmonia, com um sorriso, voz serena e batimentos estáveis (${heartRate} bpm).`,
            `Os sinais apontam para um momento positivo: emoção de ${primaryEmotionInPortuguese}, voz tranquila e frequência cardíaca de ${heartRate} bpm.`
          ]),
          suggestion: randomChoice([
            'Aproveite essa energia para se conectar com amigos.',
            'Tente uma atividade criativa, como desenhar.',
            'Compartilhe sua positividade com alguém especial.'
          ])
        },
        {
          condition: primaryEmotion === 'happyiness' && heartRate > 100 && voiceEmotion === 'anxious',
          diagnosis: randomChoice([
            `Sua expressão de felicidade com frequência cardíaca alta (${heartRate} bpm) e tom ansioso sugere entusiasmo.`,
            `Você parece vibrante, com um sorriso, batimentos acelerados (${heartRate} bpm) e voz cheia de energia.`,
            `Os sinais indicam entusiasmo: emoção de ${primaryEmotionInPortuguese}, frequência alta (${heartRate} bpm) e tom inquieto.`
          ]),
          suggestion: randomChoice([
            'Canalize essa energia para uma atividade que ama.',
            'Tente focar em uma tarefa criativa.',
            'Respire fundo para equilibrar sua energia.'
          ])
        },
        {
          condition: ['surprise', 'fear'].includes(primaryEmotion) && voiceEmotion === 'anxious' && heartRate >= 80 && heartRate <= 100,
          diagnosis: randomChoice([
            `Sua expressão de ${primaryEmotionInPortuguese}, tom ansioso e frequência moderada (${heartRate} bpm) sugerem ansiedade leve.`,
            `Você parece em atenção, com emoção de ${primaryEmotionInPortuguese}, voz inquieta e batimentos normais (${heartRate} bpm).`,
            `Os sinais apontam para ansiedade leve: expressão de ${primaryEmotionInPortuguese}, tom ansioso e frequência de ${heartRate} bpm.`
          ]),
          suggestion: randomChoice([
            'Tente uma técnica de relaxamento, como respirar fundo.',
            'Escreva o que está te preocupando.',
            'Faça uma pausa e observe o ambiente.'
          ])
        },
        {
          condition: primaryEmotion === 'neutral' && voiceEmotion === 'calm' && heartRate >= 60 && heartRate <= 100,
          diagnosis: randomChoice([
            `Sua expressão neutra, tom calmo e frequência normal (${heartRate} bpm) indicam equilíbrio.`,
            `Você está sereno, com expressão neutra, voz tranquila e batimentos estáveis (${heartRate} bpm).`,
            `Os sinais sugerem calma: emoção ${primaryEmotionInPortuguese}, tom sereno e frequência de ${heartRate} bpm.`
          ]),
          suggestion: randomChoice([
            'Aproveite esse equilíbrio para planejar seu dia.',
            'Tente uma atividade relaxante, como ler.',
            'Mantenha essa serenidade com uma rotina calma.'
          ])
        },
        {
          condition: primaryEmotion === 'anger' && heartRate > 100 && voiceEmotion !== 'calm',
          diagnosis: randomChoice([
            `Sua expressão de raiva, frequência alta (${heartRate} bpm) e tom ${voiceEmotionInPortuguese} sugerem frustração.`,
            `Você parece agitado, com emoção de ${primaryEmotionInPortuguese}, batimentos acelerados (${heartRate} bpm) e voz inquieta.`,
            `Os sinais apontam para frustração: expressão de ${primaryEmotionInPortuguese}, frequência alta (${heartRate} bpm) e tom ${voiceEmotionInPortuguese}.`
          ]),
          suggestion: randomChoice([
            'Tente contar até 10 lentamente.',
            'Faça uma caminhada rápida.',
            'Escreva o que está te irritando.'
          ])
        },
        {
          condition: primaryEmotion === 'disgust' && voiceEmotion === 'sad' && heartRate < 80,
          diagnosis: randomChoice([
            `Sua expressão de nojo, tom triste e frequência baixa (${heartRate} bpm) sugerem desconforto.`,
            `Você parece incomodado, com emoção de ${primaryEmotionInPortuguese}, voz triste e batimentos reduzidos (${heartRate} bpm).`,
            `Os sinais indicam desânimo: expressão de ${primaryEmotionInPortuguese}, tom triste e frequência de ${heartRate} bpm.`
          ]),
          suggestion: randomChoice([
            'Tente se afastar do que te incomoda.',
            'Ouça uma música animada.',
            'Reflita sobre o que está te afetando.'
          ])
        },
        {
          condition: heartRate < 60 && voiceEmotion === 'calm' && ['neutral', 'sadness'].includes(primaryEmotion),
          diagnosis: randomChoice([
            `Sua frequência baixa (${heartRate} bpm), tom calmo e expressão ${primaryEmotionInPortuguese} sugerem relaxamento profundo.`,
            `Você parece em repouso, com batimentos reduzidos (${heartRate} bpm), voz serena e emoção ${primaryEmotionInPortuguese}.`,
            `Os sinais apontam para calma: frequência baixa (${heartRate} bpm), tom tranquilo e expressão ${primaryEmotionInPortuguese}.`
          ]),
          suggestion: randomChoice([
            'Aproveite para meditar.',
            'Reflita sobre o que te traz serenidade.',
            'Tente uma atividade suave, como yoga.'
          ])
        },
        {
          condition: true,
          diagnosis: randomChoice([
            `Sinais mistos: emoção de ${primaryEmotionInPortuguese}, tom ${voiceEmotionInPortuguese} e frequência de ${heartRate} bpm. Estado emocional complexo.`,
            `Emoção não clara: expressão ${primaryEmotionInPortuguese}, voz ${voiceEmotionInPortuguese} e batimentos em ${heartRate} bpm.`,
            `Sinais não convergem: emoção ${primaryEmotionInPortuguese}, tom ${voiceEmotionInPortuguese} e frequência de ${heartRate} bpm.`
          ]),
          suggestion: randomChoice([
            'Reflita sobre o que está sentindo.',
            'Tente uma atividade neutra, como organizar.',
            'Anote seus pensamentos.'
          ])
        }
      ];

      const selectedScenario = scenarios.find(scenario => scenario.condition) || scenarios[scenarios.length - 1];
      const heartRateStatus = heartRate < 60 ? 'abaixo do normal, sugerindo relaxamento.' :
                             heartRate > 100 ? 'elevada, indicando estresse ou excitação.' :
                             'normal, refletindo estabilidade.';

      return {
        diagnosis: selectedScenario.diagnosis,
        suggestion: selectedScenario.suggestion,
        heartRate,
        heartRateStatus,
        voiceEmotionInPortuguese,
        primaryEmotionInPortuguese,
        ageRangeMin,
        ageRangeMax
      };
    }

    // Iniciar análise
    async function startAnalysis() {
      const result = document.getElementById('scanner-result');
      result.style.display = 'block';
      result.innerHTML = '<p class="fade-in">📖 Iniciando análise...</p>';
      await new Promise(resolve => setTimeout(resolve, 2000));
      captureAndAnalyze();
    }

    // Capturar e analisar
    async function captureAndAnalyze() {
      console.log('Iniciando análise facial, cardíaca e vocal...');
      const canvas = document.getElementById('canvas');
      const video = document.getElementById('video');
      const result = document.getElementById('scanner-result');
      const faceGuide = document.getElementById('face-guide');
      const ppgOverlay = document.getElementById('ppg-overlay');
      const ppgProgressBar = document.getElementById('ppg-progress-bar');
      const voiceOverlay = document.getElementById('voice-overlay');
      const voiceWaveform = document.getElementById('voice-waveform');
      let videoStream = null, audioStream = null;

      if (!canvas || !video || !result || !faceGuide || !ppgOverlay || !ppgProgressBar || !voiceOverlay || !voiceWaveform) {
        console.error('Elementos não encontrados');
        result.innerHTML = '<p class="fade-in">🚫 Erro interno: elementos não encontrados.</p>';
        return;
      }

      // Ajustar canvas e vídeo
      const videoWidth = min(90 * window.innerWidth / 100, 320);
      const videoHeight = videoWidth * 3 / 4;
      video.width = canvas.width = videoWidth;
      video.height = canvas.height = videoHeight;

      // Inicializar câmera
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({ video: { width: videoWidth, height: videoHeight }, audio: false });
        video.srcObject = videoStream;
        video.classList.remove('hidden');
        console.log('Câmera inicializada');
      } catch (error) {
        console.error('Erro na câmera:', error);
        result.innerHTML = '<p class="fade-in">🚫 Erro: câmera não acessível. Permita o acesso e tente novamente.</p><div class="mt-4"><button onclick="startAnalysis()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine">Tentar Novamente</button></div>';
        return;
      }

      // Verificar brilho
      const context = canvas.getContext('2d');
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      let imageData = context.getImageData(0, 0, canvas.width, canvas.height);
      imageData = equalizeHistogram(imageData);
      context.putImageData(imageData, 0, 0);

      let brightnessSum = 0;
      for (let i = 0; i < imageData.data.length; i += 4) {
        brightnessSum += (0.299 * imageData.data[i] + 0.587 * imageData.data[i + 1] + 0.114 * imageData.data[i + 2]);
      }
      const averageBrightness = brightnessSum / (imageData.data.length / 4);
      if (averageBrightness < 50) {
        result.innerHTML = '<p class="fade-in">🌙 Iluminação baixa. Ajuste a luz e tente novamente.</p><div class="mt-4"><button onclick="startAnalysis()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine">Tentar Novamente</button></div>';
        if (videoStream) videoStream.getTracks().forEach(track => track.stop());
        video.classList.add('hidden');
        return;
      }

      // Detectar rosto
      let faceRect = null;
      const tracker = new tracking.ObjectTracker('face');
      tracker.setInitialScale(4);
      tracker.setStepSize(2);
      tracker.setEdgesDensity(0.1);
      tracking.track('#video', tracker);
      faceGuide.classList.remove('hidden');

      tracker.on('track', event => {
        if (event.data.length > 0) {
          faceRect = event.data[0];
          if (faceRect) {
            const centerX = faceRect.x + faceRect.width / 2;
            const centerY = faceRect.y + faceRect.height / 2;
            const offsetX = (canvas.width / 2 - centerX) / canvas.width * 100;
            const offsetY = (canvas.height / 2 - centerY) / canvas.height * 100;
            faceGuide.style.transform = `translate(${offsetX}%, ${offsetY}%)`;
            if (Math.abs(offsetX) > 20 || Math.abs(offsetY) > 20) {
              result.innerHTML = '<p class="fade-in">🤔 Ajuste seu rosto ao centro.</p><div class="mt-4"><button onclick="startAnalysis()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine">Tentar novamente</button></div>';
              tracker.stop();
              faceGuide.classList.add('hidden');
              if (videoStream) videoStream.getTracks().forEach(track => track.stop());
              video.classList.add('hidden');
            }
          }
        }
      });

      let faceDetected = false;
      for (let i = 0; i < 50; i++) {
        if (faceRect) {
          faceDetected = true;
          console.log('Rosto detectado');
          break;
        }
        await new Promise(resolve => setTimeout(resolve, 100));
      }

      if (!faceDetected) {
        result.innerHTML = '<p class="fade-in">🤔 Rosto não detectado. Centralize-se na câmera.</p><div class="mt-4"><button onclick="startAnalysis()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine">Tentar novamente</button></div>';
        tracker.stop();
        faceGuide.classList.add('hidden');
        if (videoStream) videoStream.getTracks().forEach(track => track.stop());
        video.classList.add('hidden');
        return;
      }

      // Medição PPG
      const PPG_DURATION = 10;
      const FRAME_RATE = 30;
      const greenValues = [];
      let startTime = Date.now();
      result.innerHTML = '<p class="fade-in">❤️ Fique parado por 10 segundos para medir a frequência cardíaca.</p>';
      ppgOverlay.classList.add('active');

      while ((Date.now() - startTime) / 1000 < PPG_DURATION) {
        const elapsed = (Date.now() - startTime) / 1000;
        const progress = (elapsed / PPG_DURATION) * 100;
        ppgProgressBar.style.width = `${progress}%`;

        if (!faceRect || Math.abs((canvas.width / 2 - (faceRect.x + faceRect.width / 2)) / canvas.width * 100) > 20 || Math.abs((canvas.height / 2 - (faceRect.y + faceRect.height / 2)) / canvas.height * 100) > 20) {
          result.innerHTML = '<p class="fade-in">🖋️ Movimentação detectada. Fique parado.</p><div class="mt-4"><button onclick="startAnalysis()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine">Tentar novamente</button></div>';
          ppgOverlay.classList.remove('active');
          tracker.stop();
          faceGuide.classList.add('hidden');
          if (videoStream) videoStream.getTracks().forEach(track => track.stop());
          video.classList.add('hidden');
          return;
        }

        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const foreheadX = Math.floor(faceRect.x + faceRect.width * 0.25);
        const foreheadY = Math.floor(faceRect.y + faceRect.height * 0.15);
        const foreheadWidth = Math.floor(faceRect.width * 0.5);
        const foreheadHeight = Math.floor(faceRect.height * 0.25);
        let foreheadData = context.getImageData(foreheadX, foreheadY, foreheadWidth, foreheadHeight);
        foreheadData = equalizeHistogram(foreheadData);

        let greenSum = 0, pixelCount = 0;
        for (let i = 0; i < foreheadData.data.length; i += 4) {
          const green = foreheadData.data[i + 1];
          if (green > 50) {
            greenSum += green;
            pixelCount++;
          }
        }
        if (pixelCount > 0) {
          const averageGreen = greenSum / pixelCount;
          greenValues.push(averageGreen);
          console.log(`PPG frame: green=${averageGreen.toFixed(2)}, pixels=${pixelCount}`);
        }
        await new Promise(resolve => setTimeout(resolve, 1000 / FRAME_RATE));
      }

      ppgOverlay.classList.remove('active');

      // Calcular frequência cardíaca
      let heartRate = 0;
      try {
        if (greenValues.length < FRAME_RATE * PPG_DURATION / 2) {
          throw new Error('Dados PPG insuficientes');
        }
        const mean = greenValues.reduce((a, b) => a + b, 0) / greenValues.length;
        const detrended = greenValues.map(val => val - mean));
        const filtered = bandpassFilter.apply(detrended, FRAME_RATE);
        const freq = getDominantFrequency(filtered, FRAME_RATE);
        heartRate = Math.round(freq * 60);
        if (heartRate < 40 || heartRate > 180) {
          throw new Error('Frequência cardíaca fora do alcance');
        }
        console.log('PPG calculada: heartRate = ${heartRate} bpm');
      } catch (error) {
        console.error('Erro no PPG:', error);
        heartRate = Math.floor(60 + Math.random() * 20); // Fallback: 60-80
        result.innerHTML += '<p class="fade-in">⚠️ Frequência cardíaca estimada devido a dados insuficientes.</p>';
      }

      // Análise de voz
      result.innerHTML = '<p class="fade-in">🎶 Diga: "Estou tranquilo hoje" por 5 segundos...</p>';
      voiceOverlay.classList.add('active');
      let voiceEmotion = 'calm';
      try {
        if (!window.AudioContext && !window.webkitAudioContext) {
          throw new Error('AudioContext não suportado');
        }
        audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioContext.createMediaStreamSource(audioStream);
        const analyser = audioContext.createAnalyser();
        analyser.fftSize = 128;
        source.connect(analyser);

        const waveformCtx = voiceWaveform.getContext('2d');
        drawWaveform(analyser, voiceWaveform, waveformCtx);

        const VOICE_DURATION = 5;
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        let energySum = 0, frameCount = 0;
        startTime = Date.now();

        while ((Date.now() - startTime) / 1000 < VOICE_DURATION) {
          analyser.getByteFrequencyData(dataArray);
          let sum = 0;
          for (let i = 0; i < bufferLength; i++) {
            sum += dataArray[i] * dataArray[i];
          }
          const energy = sum / bufferLength;
          energySum += energy;
          frameCount++;
          await new Promise(resolve => setTimeout(resolve, 1000 / 60));
        }

        audioStream.getTracks().forEach(track => track.stop());
        audioContext.close();
        voiceOverlay.classList.remove('active');

        const averageEnergy = energySum / frameCount;
        if (averageEnergy > 1000) voiceEmotion = 'anxious';
        else if (averageEnergy < 50) voiceEmotion = 'sad';
        console.log('Vozância: averageEnergy=${averageEnergy.toFixed(2)}, emotion=$voiceEmotion');
      } catch (error) {
        console.error('Erro na voz:', error);
        result.innerHTML = '<p class="fade-in">🚖️ Microfone falhou. Permite o acesso e continue.</p><div class="mt-4"><button onclick="startAnalysis()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine">Tentar Novamente</button></div>';
        voiceOverlay.classList.remove('active');
        if (audioStream) audioStream.getTracks().forEach(track => track.stop());
        if (videoStream) {
          videoStream.getTracks().forEach(track => track.stop());
          video.classList.add('hidden');
        }
        return;
      }

      // Capturar imagem para Face++ API
      result.innerHTML = '<p class="fade-in">🔍 Analisando...</p>';
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      imageData = context.getImageData(0, 0, canvas.width, canvas.height);
      imageData = equalizeHistogram(imageData);
      context.putImageData(imageData, 0, 0);
      const imageBase64 = canvas.toDataURL('image/jpeg').split(',')[1];

      // Enviar para Face++ API
      const formData = new FormData();
      formData.append('api_key', apiKey);
      formData.append('api_secret', apiSecret);
      formData.append('image_base64', imageBase64);
      formData.append('return_attributes', 'emotion,age');

      try {
        const response = await fetch('https://api-us.faceplusplus.com/facepp/v3/detect', {
          method: 'POST',
          body: formData
        });
        const data = await response.json();
        console.log('Face++ API response:', data);

        if (data.faces && data.faces.length > 0) {
          const face = data.faces[0];
          const emotion = face.attributes.emotion;
          const emotionsSorted = Object.entries(emotion).sort((a, b) => b[1] - a[1]);
          const primaryEmotion = emotionsSorted[0][0];
          const confidence = emotionsSorted[0][1];
          const age = face.attributes.age.value;

          if (confidence >= 50) {
            const diag = generateDiagnosis(primaryEmotion, heartRate, voiceEmotion, age);
            result.innerHTML = `
              <h3 class="text-xl font-bold mb-3 fade-in">Resultado do Diagnóstico</h3>
              <p class="fade-in"><strong>Emoção Facial:</strong> ${diag.primaryEmotionInPortuguese.charAt(0).toUpperCase() + diag.primaryEmotionInPortuguese.slice(1)}</p>
              <p class="fade-in"><strong>Frequência Cardíaca:</strong> ${diag.heartRate} bpm (${diag.heartRateStatus})</p>
              <p class="fade-in"><strong>Emoção Vocal:</strong> ${diag.voiceEmotionInPortuguese.charAt(0).toUpperCase() + diag.voiceEmotionInPortuguese.slice(1)}</p>
              <p class="fade-in"><strong>Idade Estimada:</strong> Entre ${diag.ageRangeMin} e ${diag.ageRangeMax} anos</p>
              <p class="fade-in mt-2">${diag.diagnosis}</p>
              <p class="fade-in mt-2"><strong>Sugestão:</strong> ${diag.suggestion}</p>
              <div class="mt-4"><button onclick="startAnalysis()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine">Analisar Novamente</button></div>
            `;
          } else {
            result.innerHTML = '<p class="fade-in">🚫 Emoção facial não detectada com confiança.</p><div class="mt-4"><button onclick="startAnalysis()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine">Tentar Novamente</button></div>';
          }
        } else {
          result.innerHTML = '<p class="fade-in">🚫 Rosto não detectado na imagem.</p><div class="mt-4"><button onclick="startAnalysis()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine">Tentar Novamente</button></div>';
        }
      } catch (error) {
        console.error('Erro na API:', error);
        result.innerHTML = '<p class="fade-in">🚫 Erro ao conectar com a API.</p><div class="mt-4"><button onclick="startAnalysis()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine">Tentar Novamente</button></div>';
      } finally {
        if (videoStream) {
          videoStream.getTracks().forEach(track => track.stop());
          video.classList.add('hidden');
        }
        tracker.stop();
        faceGuide.classList.add('hidden');
      }
    }
  </script>
</body>
</html>
