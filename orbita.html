<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="√ìRBITA Qu√¢ntica - Revolucione seu bem-estar diariamente">
    <meta name="keywords" content="√ìRBITA, IA qu√¢ntica, bem-estar, medita√ß√£o, monitoramento, AR">
    <meta name="author" content="√Ålibis Digital">
    <title>√ìRBITA Qu√¢ntica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dsp.js/1.0.0/dsp.min.js" onerror="console.warn('dsp.js failed to load')"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap">
    <style>
        body { margin: 0; padding: 0; min-height: 100vh; font-family: 'Inter', sans-serif; color: #e5e7eb; background: linear-gradient(135deg, #0b1120, #1e1b4b); overflow-x: hidden; }
        #particles-js { position: fixed; width: 100%; height: 100%; top: 0; left: 0; z-index: -1; background: transparent; }
        .fade-in { animation: fadeIn 0.8s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .header { position: fixed; top: 0; width: 100%; background: rgba(17, 24, 39, 0.9); backdrop-filter: blur(10px); padding: 10px 15px; z-index: 10; display: flex; justify-content: space-between; align-items: center; }
        .header img { height: 30px; width: auto; }
        .nav-btn { color: #e5e7eb; font-size: 1.2rem; background: none; border: none; cursor: pointer; }
        .nav-btn:hover { color: #22d3ee; }
        .content { margin-top: 60px; padding: 10px; }
        .card { background: linear-gradient(45deg, #0a1f2e, #00ccff); border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 0 10px rgba(0, 212, 255, 0.3); backdrop-filter: blur(5px); }
        .futuristic-btn { background: linear-gradient(45deg, #7C3AED, #22d3ee); color: #fff; padding: 10px 20px; border-radius: 25px; font-size: 0.9rem; font-weight: 600; box-shadow: 0 0 5px #22d3ee; transition: transform 0.3s; }
        .futuristic-btn:hover { transform: translateY(-2px); }
        .futuristic-btn:active { transform: scale(0.95); }
        .futuristic-btn:disabled { background: #666; cursor: not-allowed; }
        .progress-bar { width: 100%; background: #1a1a1a; border-radius: 5px; overflow: hidden; margin-top: 10px; }
        .progress { height: 6px; background: #22d3ee; width: 0; transition: width 0.3s ease; }
        .loading-dots::after { content: ''; display: inline-block; width: 0.8em; height: 0.8em; animation: dots 1.5s steps(3, end) infinite; }
        @keyframes dots { 0% { content: '.'; } 33% { content: '..'; } 66% { content: '...'; } 100% { content: '.'; } }
        #avatar-container { width: 100%; height: 200px; position: relative; }
        @media (min-width: 768px) { .card { margin-bottom: 20px; } .futuristic-btn { font-size: 1rem; } }
    </style>
</head>
<body>
    <div id="particles-js"></div>

    <!-- Cabe√ßalho -->
    <header class="header">
        <a href="/"><img src="/assets/logo.png" alt="Logo √ìRBITA" class="fade-in"></a>
        <button class="nav-btn" id="menu-btn">‚ò∞</button>
    </header>

    <!-- Conte√∫do Principal -->
    <div class="content">
        <div class="card fade-in">
            <h2 class="text-xl font-semibold mb-2">Espelho Qu√¢ntico</h2>
            <p class="text-gray-300 mb-4">Seu avatar emocional em 3D.</p>
            <div id="avatar-container"></div>
            <video id="video" width="100%" autoplay muted class="rounded-lg border-2 border-[#22d3ee] pulse mt-2 hidden"></video>
            <button id="scan-btn" class="futuristic-btn mt-4 w-full" aria-label="Escanear Agora">Escanear Agora</button>
            <div id="scan-result" class="mt-4 hidden"></div>
        </div>
        <div class="card fade-in">
            <h2 class="text-xl font-semibold mb-2">Ciclo Di√°rio</h2>
            <p class="text-gray-300 mb-4">Sugest√µes personalizadas.</p>
            <div id="daily-suggestions" class="mt-2">
                <p class="text-gray-400">Monitore para ver sugest√µes!</p>
            </div>
        </div>
        <div class="card fade-in">
            <h2 class="text-xl font-semibold mb-2">Comunidade √ìrbita</h2>
            <p class="text-gray-300 mb-4">Conecte-se anonimamente.</p>
            <button id="community-btn" class="futuristic-btn w-full" aria-label="Entrar na Comunidade">Entrar</button>
        </div>
        <div class="card fade-in">
            <a href="meditacao.html" class="futuristic-btn w-full text-center" aria-label="Medita√ß√£o">üßò Medita√ß√£o</a>
            <a href="apoio-emocional.html" class="futuristic-btn w-full mt-2 text-center" aria-label="Apoio">ü´Ç Apoio</a>
        </div>
    </div>

    <canvas id="canvas" width="320" height="240" style="display: none;" willReadFrequently="true"></canvas>

    <script>
        // Inicializar particles.js
        particlesJS('particles-js', {
            particles: { number: { value: 50, density: { enable: true, value_area: 600 } }, color: { value: '#22d3ee' }, shape: { type: 'circle' }, opacity: { value: 0.2, random: true }, size: { value: 1.5, random: true }, line_linked: { enable: true, distance: 80, color: '#22d3ee', opacity: 0.15, width: 0.5 }, move: { enable: true, speed: 0.8, direction: 'none', random: false, straight: false, out_mode: 'out' } },
            interactivity: { detect_on: 'canvas', events: { onhover: { enable: true, mode: 'repulse' }, onclick: { enable: true, mode: 'push' }, resize: true }, modes: { repulse: { distance: 80 }, push: { particles_nb: 2 } } }
        });

        // Configura√ß√µes
        const SIMULATED_DATA = true; // Ativa simula√ß√£o para evitar depend√™ncia de APIs
        let dailyData = [];

        // Avatar 3D com Three.js
        const avatarContainer = document.getElementById('avatar-container');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, avatarContainer.offsetWidth / 200, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true });
        renderer.setSize(avatarContainer.offsetWidth, 200);
        avatarContainer.appendChild(renderer.domElement);
        const geometry = new THREE.SphereGeometry(50, 32, 32);
        const material = new THREE.MeshBasicMaterial({ color: 0x9ca3af, transparent: true, opacity: 0.7 });
        const sphere = new THREE.Mesh(geometry, material);
        scene.add(sphere);
        camera.position.z = 100;
        function animate() { requestAnimationFrame(animate); sphere.rotation.y += 0.01; renderer.render(scene, camera); }
        animate();

        function speakDiagnosis(text) {
            try { const utterance = new SpeechSynthesisUtterance(text); utterance.lang = 'pt-BR'; utterance.rate = 0.85; utterance.pitch = 0.7; utterance.volume = 0.9; window.speechSynthesis.speak(utterance); console.log('Diagnosis spoken:', text); } catch (error) { console.error('Speech error:', error.message); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const video = document.getElementById('video');
            const scanBtn = document.getElementById('scan-btn');
            const scanResult = document.getElementById('scan-result');
            const dailySuggestions = document.getElementById('daily-suggestions');
            const communityBtn = document.getElementById('community-btn');
            const menuBtn = document.getElementById('menu-btn');

            let cameraInitialized = false;

            // Inicializar c√¢mera
            if (video) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(stream => {
                        video.srcObject = stream;
                        cameraInitialized = true;
                        video.classList.remove('hidden');
                        scanBtn.disabled = false; // Ativa o bot√£o quando a c√¢mera est√° pronta
                        console.log('C√¢mera inicializada com sucesso!');
                    })
                    .catch(err => {
                        console.error('Erro na c√¢mera:', err.message);
                        scanResult.classList.remove('hidden');
                        scanResult.innerHTML = '<p class="fade-in text-red-500">‚ùå C√¢mera n√£o acessada. Verifique permiss√µes ou use outro dispositivo.</p>';
                        scanBtn.disabled = true;
                    });
            }

            // Evento do bot√£o "Escanear Agora"
            scanBtn.addEventListener('click', () => {
                if (!cameraInitialized || scanBtn.disabled) return;
                startScan();
            });

            menuBtn.addEventListener('click', () => alert('Menu aberto (simula√ß√£o)'));
            communityBtn.addEventListener('click', () => alert('Conectando √† Comunidade √ìrbita (simula√ß√£o)'));

            function updateDaily(emotion, bpm) {
                dailyData.push({ time: new Date().toLocaleTimeString(), emotion, bpm });
                if (dailyData.length > 5) dailyData.shift();
                const suggestion = getDailySuggestion(emotion, bpm);
                dailySuggestions.innerHTML = `<p class="text-gray-300">${suggestion}</p>`;
            }

            async function startScan() {
                scanBtn.disabled = true;
                scanResult.classList.remove('hidden');
                scanResult.innerHTML = '<p class="fade-in text-white">Escanando...<span class="loading-dots"></span></p><div class="progress-bar"><div id="progress" class="progress"></div></div>';

                const canvas = document.getElementById('canvas');
                const context = canvas.getContext('2d');
                const progress = document.getElementById('progress');

                // Simula progresso
                let progressWidth = 0;
                const interval = setInterval(() => {
                    progressWidth += 10;
                    progress.style.width = `${progressWidth}%`;
                    if (progressWidth >= 100) clearInterval(interval);
                }, 300);

                try {
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const faceAnalysis = await analyzeFace(canvas, video);
                    const voiceData = await analyzeVoice();
                    const bpm = await calculateHeartRate(video, canvas);

                    const emotion = unifyDiagnosis(faceAnalysis.emotion, voiceData, bpm);
                    displayScanResult(emotion, bpm, faceAnalysis.emotion, voiceData, scanResult);
                    updateDaily(emotion, bpm);
                    updateAvatar(emotion);
                } catch (error) {
                    console.error('Erro no escaneamento:', error.message);
                    scanResult.innerHTML = '<p class="fade-in text-red-500">‚ùå Erro: ' + error.message + '. Tente novamente ou verifique a conex√£o.</p>';
                } finally {
                    scanBtn.disabled = false;
                    progress.style.width = '0';
                }
            }

            // An√°lise facial com fallback simulado
            async function analyzeFace(canvas, video) {
                if (!SIMULATED_DATA) {
                    const context = canvas.getContext('2d');
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const imageBase64 = canvas.toDataURL('image/png').split(',')[1];
                    const formData = new FormData();
                    formData.append('api_key', 'AmoIQKuEFggNsZmeO_Ur50ZZmfSrZ3mX');
                    formData.append('api_secret', 'WoRf3C8_IqQhe0Su8coFmOnAB_0nOheY');
                    formData.append('image_base64', imageBase64);
                    formData.append('return_attributes', 'emotion');
                    const response = await fetch('https://api-us.faceplusplus.com/facepp/v3/detect', { method: 'POST', body: formData });
                    if (!response.ok) throw new Error('Falha na API Face++: ' + response.status);
                    const data = await response.json();
                    return data.faces && data.faces.length > 0 ? { emotion: data.faces[0].attributes.emotion } : { emotion: { sadness: 10, anger: 5, happiness: 80, surprise: 2, neutral: 1, fear: 1, disgust: 1 } };
                } else {
                    // Simula√ß√£o para teste
                    await new Promise(resolve => setTimeout(resolve, 500));
                    return { emotion: { happiness: 70, neutral: 20, sadness: 10 } };
                }
            }

            // An√°lise de voz com fallback simulado
            async function analyzeVoice() {
                if (!SIMULATED_DATA) {
                    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                    recognition.lang = 'pt-BR';
                    recognition.maxAlternatives = 1;
                    recognition.interimResults = false;
                    return new Promise((resolve) => {
                        recognition.onstart = () => console.log('Iniciando reconhecimento de voz');
                        recognition.onresult = async (event) => {
                            const transcript = event.results[0][0].transcript;
                            console.log('Transcri√ß√£o:', transcript);
                            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                                method: 'POST',
                                headers: { 'Authorization': `Bearer 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`, 'Content-Type': 'application/json' },
                                body: JSON.stringify({ model: 'gpt-3.5-turbo', messages: [{ role: 'system', content: 'Analise o sentimento em portugu√™s. Retorne "positivo", "negativo" ou "neutro".' }, { role: 'user', content: transcript }] })
                            });
                            if (!response.ok) throw new Error('Falha na API OpenAI: ' + response.status);
                            const data = await response.json();
                            const sentiment = data.choices[0].message.content.toLowerCase();
                            const sentimentMap = { positivo: { happiness: 0.8, neutral: 0.2 }, negativo: { sadness: 0.6, anger: 0.3, fear: 0.1 }, neutro: { neutral: 0.7, happiness: 0.3 } };
                            resolve(sentimentMap[sentiment] || { neutral: 1 });
                        };
                        recognition.onerror = (event) => { console.error('Erro na voz:', event.error); resolve({ neutral: 1 }); };
                        recognition.start();
                        setTimeout(() => recognition.stop(), 8000);
                    });
                } else {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    return { happiness: 0.7, neutral: 0.3 };
                }
            }

            // C√°lculo de frequ√™ncia card√≠aca com fallback simulado
            async function calculateHeartRate(video, canvas) {
                if (!SIMULATED_DATA) {
                    try {
                        const context = canvas.getContext('2d');
                        const forehead = { x: canvas.width * 0.3, y: 0, width: canvas.width * 0.4, height: canvas.height * 0.2 };
                        const greenValues = [];
                        for (let i = 0; i < 20; i++) {
                            context.drawImage(video, 0, 0, canvas.width, canvas.height);
                            const data = context.getImageData(forehead.x, forehead.y, forehead.width, forehead.height).data;
                            let greenSum = 0;
                            for (let j = 1; j < data.length; j += 4) greenSum += data[j];
                            greenValues.push(greenSum / (data.length / 4));
                            await new Promise(resolve => setTimeout(resolve, 1000 / 20));
                        }
                        if (typeof FFT === 'undefined') throw new Error('FFT n√£o dispon√≠vel');
                        const fft = new FFT(greenValues.length, 20);
                        fft.forward(greenValues);
                        const magnitudes = fft.spectrum;
                        let maxMag = 0, maxIndex = 0;
                        for (let i = 1; i < magnitudes.length / 2; i++) {
                            if (magnitudes[i] > magnitudes[maxMag]) { maxMag = i; maxIndex = i; }
                        }
                        return Math.round(maxIndex * 20 / greenValues.length * 60);
                    } catch (error) {
                        console.warn('Erro no c√°lculo de BPM, usando valor simulado:', error.message);
                        return simulateHeartRate();
                    }
                } else {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    return simulateHeartRate();
                }
            }

            function simulateHeartRate() {
                const baseBpm = 70;
                const variance = Math.random() * 10 - 5;
                return Math.round(baseBpm + variance);
            }

            function getDiagnosisScores(facialData, voiceData, bpm) {
                const defaultScores = { sadness: 0, anger: 0, happiness: 0, surprise: 0, neutral: 0, fear: 0, disgust: 0 };
                const facialScores = facialData || defaultScores;
                const totalFacial = Object.values(facialScores).reduce((sum, val) => sum + val, 0);
                const normFacial = {};
                for (let emo in facialScores) normFacial[emo] = totalFacial ? facialScores[emo] / totalFacial : 0;
                const voiceScores = voiceData || defaultScores;
                const totalVoice = Object.values(voiceScores).reduce((sum, val) => sum + val, 0);
                const normVoice = {};
                for (let emo in voiceScores) normVoice[emo] = totalVoice ? voiceScores[emo] / totalVoice : 0;
                const hrWeight = bpm > 90 ? 0.2 : 0;
                const hrScores = bpm > 90 ? { anger: 0.5, fear: 0.3, sadness: 0.2 } : defaultScores;
                const voiceFailed = voiceData && voiceData.neutral === 1 && totalVoice === 1;
                const facialWeight = voiceFailed ? 0.8 : 0.5;
                const voiceWeight = voiceFailed ? 0.0 : 0.3;
                const finalScores = {};
                for (let emo in defaultScores) finalScores[emo] = facialWeight * (normFacial[emo] || 0) + voiceWeight * (normVoice[emo] || 0) + hrWeight * (hrScores[emo] || 0);
                return finalScores;
            }

            function unifyDiagnosis(facialData, voiceData, bpm) {
                const scores = getDiagnosisScores(facialData, voiceData, bpm);
                return Object.keys(scores).reduce((a, b) => scores[a] > scores[b] ? a : b);
            }

            const diagnosisMap = {
                sadness: { emotionalText: ["Express√£o vazia‚Ä¶ algo pesa! ‚òï", "Energia baixa‚Ä¶ reabaste√ßa! ‚úàÔ∏è"], physicalText: "Frequ√™ncia: ${bpm} bpm, ${bpmContext}. Busque calma.", suggestion: "Tente m√∫sica ou escreva.", link: "apoio-emocional.html" },
                anger: { emotionalText: ["Tens√£o‚Ä¶ vulc√£o ativo! üåã", "Energia intensa‚Ä¶ controle! ‚ö°"], physicalText: "Frequ√™ncia: ${bpm} bpm, ${bpmContext}. Alivie.", suggestion: "Respire fundo.", link: "apoio-emocional.html" },
                neutral: { emotionalText: { cansa√ßo: ["Energia esgotada‚Ä¶ sono chama! üí§", "C√≠rculos‚Ä¶ panda? üêº"], apatia: ["Campo neutro‚Ä¶ ativa√ß√£o pendente! üßü", "Mente flutuante‚Ä¶ ancorar? ‚úàÔ∏è"] }, physicalText: "Frequ√™ncia: ${bpm} bpm, ${bpmContext}. Respire.", suggestion: { cansa√ßo: "5 min de pausa.", apatia: "Foco na respira√ß√£o." }, link: "apoio-emocional.html" },
                fear: { emotionalText: ["Vibra√ß√£o r√°pida‚Ä¶ ansiedade alta! üì∂", "Mente em √≥rbita‚Ä¶ desacelere! üèéÔ∏è"], physicalText: "Frequ√™ncia: ${bpm} bpm, ${bpmContext}. Paz agora.", suggestion: "Inspira 4, segura 4, solta 4.", link: "apoio-emocional.html" }
            };

            function displayScanResult(emotion, bpm, facialData, voiceData, resultDiv) {
                const bpmContext = bpm >= 60 && bpm <= 100 ? 'est√°vel' : bpm < 60 ? 'baixa, veja um m√©dico' : 'alta, relaxe';
                const diag = diagnosisMap[emotion] || diagnosisMap.neutral;
                let emotionalText = Array.isArray(diag.emotionalText) ? diag.emotionalText[Math.floor(Math.random() * diag.emotionalText.length)] : 
                    (facialData && facialData.exhausted ? diag.emotionalText.cansa√ßo[Math.floor(Math.random() * diag.emotionalText.cansa√ßo.length)] : diag.emotionalText.apatia[Math.floor(Math.random() * diag.emotionalText.apatia.length)]);
                const physicalText = diag.physicalText.replace('${bpm}', bpm).replace('${bpmContext}', bpmContext);
                const suggestionText = typeof diag.suggestion === 'object' ? (facialData && facialData.exhausted ? diag.suggestion.cansa√ßo : diag.suggestion.apatia) : diag.suggestion;

                resultDiv.innerHTML = `
                    <h3 class="text-lg font-semibold mb-2">üß† Estado Qu√¢ntico</h3>
                    <p class="fade-in">${emotionalText}</p>
                    <h3 class="text-lg font-semibold mt-2 mb-2">üíì Frequ√™ncia</h3>
                    <p class="fade-in">${physicalText}</p>
                    <h3 class="text-lg font-semibold mt-2 mb-2">üåå Sugest√£o</h3>
                    <p class="fade-in text-gray-300">${suggestionText}</p>
                    <button id="retry-btn" class="futuristic-btn mt-2 w-full" aria-label="Reiniciar">üîÑ Reiniciar</button>
                `;
                document.getElementById('retry-btn').addEventListener('click', startScan);
                speakDiagnosis(`${emotionalText} ${physicalText} ${suggestionText}`);
            }

            function updateAvatar(emotion) {
                const colors = { sadness: 0x1e40af, anger: 0xb91c1c, happiness: 0x22c55e, neutral: 0x9ca3af, fear: 0xf59e0b };
                material.color.set(colors[emotion] || 0x9ca3af);
                sphere.scale.set(emotion === 'happiness' ? 1.2 : 1.0, emotion === 'happiness' ? 1.2 : 1.0, 1.0);
            }

            function getDailySuggestion(emotion, bpm) {
                const suggestions = {
                    sadness: "Tente medita√ß√£o suave hoje √†s 18h.",
                    anger: "Pausa de respira√ß√£o √†s 15h para aliviar.",
                    neutral: bpm > 90 ? "Relaxe com medita√ß√£o √†s 17h." : "Mantenha o ritmo com uma caminhada.",
                    fear: "Sess√£o de calma √†s 16h, inspire devagar."
                };
                return suggestions[emotion] || "Monitore para sugest√µes personalizadas!";
            }
        });
    </script>
</body>
</html>
