<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="√ìRBITA Qu√¢ntica - Seu assistente pessoal de bem-estar com IA">
    <meta name="keywords" content="√ìRBITA, IA emocional, bem-estar, medita√ß√£o, monitoramento">
    <meta name="author" content="√Ålibis Digital">
    <title>√ìRBITA Qu√¢ntica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dsp.js/1.0.0/dsp.min.js" onerror="console.warn('dsp.js failed to load')"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap">
    <style>
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
            color: #e5e7eb;
            background: linear-gradient(135deg, #0b1120, #1e1b4b);
            overflow-x: hidden;
        }
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
            background: transparent;
        }
        .fade-in { animation: fadeIn 0.8s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .header {
            position: fixed;
            top: 0;
            width: 100%;
            background: rgba(17, 24, 39, 0.9);
            backdrop-filter: blur(10px);
            padding: 10px 15px;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header img { height: 30px; width: auto; }
        .nav-btn { color: #e5e7eb; font-size: 1.2rem; background: none; border: none; cursor: pointer; }
        .nav-btn:hover { color: #22d3ee; }
        .content { margin-top: 60px; padding: 10px; }
        .card {
            background: linear-gradient(45deg, #0a1f2e, #00ccff);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
            backdrop-filter: blur(5px);
        }
        .futuristic-btn {
            background: linear-gradient(45deg, #7C3AED, #22d3ee);
            color: #fff;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 0 5px #22d3ee;
            transition: transform 0.3s;
        }
        .futuristic-btn:hover { transform: translateY(-2px); }
        .futuristic-btn:active { transform: scale(0.95); }
        .progress-bar { width: 100%; background: #1a1a1a; border-radius: 5px; overflow: hidden; margin-top: 10px; }
        .progress { height: 6px; background: #22d3ee; width: 0; transition: width 0.3s ease; }
        .loading-dots::after { content: ''; display: inline-block; width: 0.8em; height: 0.8em; animation: dots 1.5s steps(3, end) infinite; }
        @keyframes dots { 0% { content: '.'; } 33% { content: '..'; } 66% { content: '...'; } 100% { content: '.'; } }
        #avatar-container { width: 100%; height: 200px; position: relative; }
        @media (min-width: 768px) {
            .card { margin-bottom: 20px; }
            .futuristic-btn { font-size: 1rem; }
        }
    </style>
</head>
<body>
    <div id="particles-js"></div>

    <!-- Cabe√ßalho -->
    <header class="header">
        <a href="/"><img src="/assets/logo.png" alt="Logo √ìRBITA" class="fade-in"></a>
        <button class="nav-btn" id="menu-btn">‚ò∞</button>
    </header>

    <!-- Conte√∫do Principal -->
    <div class="content">
        <div class="card fade-in">
            <h2 class="text-xl font-semibold mb-2">Monitoramento Emocional</h2>
            <p class="text-gray-300 mb-4">A √ìRBITA analisa seu estado em tempo real.</p>
            <video id="video" width="100%" autoplay muted class="rounded-lg border-2 border-[#22d3ee] pulse"></video>
            <button id="monitor-btn" class="futuristic-btn mt-4 w-full" aria-label="Iniciar Monitoramento">Iniciar Monitoramento</button>
            <div id="monitoring-result" class="mt-4 hidden"></div>
        </div>
        <div class="card fade-in">
            <h2 class="text-xl font-semibold mb-2">Hist√≥rico</h2>
            <p class="text-gray-300 mb-4">Seu progresso emocional.</p>
            <div id="history" class="mt-2">
                <p class="text-gray-400">Nenhum dado ainda. Monitore para come√ßar!</p>
            </div>
        </div>
        <div class="card fade-in">
            <a href="meditacao.html" class="futuristic-btn w-full text-center" aria-label="Medita√ß√£o Guiada">üßò Medita√ß√£o</a>
            <a href="apoio-emocional.html" class="futuristic-btn w-full mt-2 text-center" aria-label="Mais Apoio">ü´Ç Apoio</a>
        </div>
    </div>

    <canvas id="canvas" width="320" height="240" style="display: none;" willReadFrequently="true"></canvas>

    <script>
        particlesJS('particles-js', {
            particles: { number: { value: 50, density: { enable: true, value_area: 600 } }, color: { value: '#22d3ee' }, shape: { type: 'circle' }, opacity: { value: 0.2, random: true }, size: { value: 1.5, random: true }, line_linked: { enable: true, distance: 80, color: '#22d3ee', opacity: 0.15, width: 0.5 }, move: { enable: true, speed: 0.8, direction: 'none', random: false, straight: false, out_mode: 'out' } },
            interactivity: { detect_on: 'canvas', events: { onhover: { enable: true, mode: 'repulse' }, onclick: { enable: true, mode: 'push' }, resize: true }, modes: { repulse: { distance: 80 }, push: { particles_nb: 2 } } }
        });

        const FACE_API_KEY = 'AmoIQKuEFggNsZmeO_Ur50ZZmfSrZ3mX';
        const FACE_API_SECRET = 'WoRf3C8_IqQhe0Su8coFmOnAB_0nOheY';
        const OPENAI_API_KEY = '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';

        let historyData = [];

        function speakDiagnosis(text) {
            try {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'pt-BR';
                utterance.rate = 0.85;
                utterance.pitch = 0.7;
                utterance.volume = 0.9;
                window.speechSynthesis.speak(utterance);
                console.log('Diagnosis spoken:', text);
            } catch (error) {
                console.error('Speech error:', error.message);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const video = document.getElementById('video');
            const monitorBtn = document.getElementById('monitor-btn');
            const monitoringResult = document.getElementById('monitoring-result');
            const historyDiv = document.getElementById('history');

            let cameraInitialized = false;
            if (video) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    video.srcObject = stream;
                    cameraInitialized = true;
                    console.log('Camera initialized successfully');
                } catch (err) {
                    console.error('Camera error:', err.message);
                    monitoringResult.classList.remove('hidden');
                    monitoringResult.innerHTML = '<p class="fade-in text-red-500">‚ùå C√¢mera n√£o acessada. Verifique permiss√µes.</p>';
                    monitorBtn.disabled = true;
                }
            }

            monitorBtn.addEventListener('click', () => {
                if (!cameraInitialized) return;
                startMonitoring();
            });

            function updateHistory(emotion, bpm) {
                historyData.push({ date: new Date().toLocaleString('pt-BR'), emotion, bpm });
                if (historyData.length > 5) historyData.shift();
                historyDiv.innerHTML = historyData.map(entry => `<p class="text-gray-300">${entry.date}: ${entry.emotion} (BPM: ${entry.bpm})</p>`).join('');
            }

            async function startMonitoring() {
                monitoringResult.classList.remove('hidden');
                monitoringResult.innerHTML = '<p class="fade-in text-white">Monitorando...<span class="loading-dots"></span></p><div class="progress-bar"><div id="progress" class="progress"></div></div>';

                const canvas = document.getElementById('canvas');
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const faceAnalysis = await analyzeFace(canvas, video);
                const voiceData = await analyzeVoice();
                const bpm = await calculateHeartRate(video, canvas);

                const emotion = unifyDiagnosis(faceAnalysis.emotion, voiceData, bpm);
                displayMonitoringResult(emotion, bpm, faceAnalysis.emotion, voiceData, monitoringResult);
                updateHistory(emotion, bpm);
            }
        });

        async function analyzeFace(canvas, video) {
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageBase64 = canvas.toDataURL('image/png').split(',')[1];
            const formData = new FormData();
            formData.append('api_key', FACE_API_KEY);
            formData.append('api_secret', FACE_API_SECRET);
            formData.append('image_base64', imageBase64);
            formData.append('return_attributes', 'emotion');
            const response = await fetch('https://api-us.faceplusplus.com/facepp/v3/detect', { method: 'POST', body: formData });
            if (!response.ok) throw new Error(`Face++ API failed: ${response.status}`);
            const data = await response.json();
            return data.faces && data.faces.length > 0 ? { emotion: data.faces[0].attributes.emotion } : { emotion: { sadness: 10, anger: 5, happiness: 80, surprise: 2, neutral: 1, fear: 1, disgust: 1 } };
        }

        async function analyzeVoice() {
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'pt-BR';
            recognition.maxAlternatives = 1;
            recognition.interimResults = false;
            return new Promise((resolve) => {
                recognition.onstart = () => console.log('Voice recording started');
                recognition.onresult = async (event) => {
                    const transcript = event.results[0][0].transcript;
                    console.log('Voice transcript:', transcript);
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${OPENAI_API_KEY}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: 'gpt-3.5-turbo', messages: [{ role: 'system', content: 'Analise o sentimento deste texto em portugu√™s. Retorne "positivo", "negativo" ou "neutro".' }, { role: 'user', content: transcript }] })
                    });
                    if (!response.ok) throw new Error(`OpenAI API failed: ${response.status}`);
                    const data = await response.json();
                    const sentiment = data.choices[0].message.content.toLowerCase();
                    const sentimentMap = { positivo: { happiness: 0.8, neutral: 0.2 }, negativo: { sadness: 0.6, anger: 0.3, fear: 0.1 }, neutro: { neutral: 0.7, happiness: 0.3 } };
                    resolve(sentimentMap[sentiment] || { neutral: 1 });
                };
                recognition.onerror = (event) => { console.error('Speech recognition error:', event.error); resolve({ neutral: 1 }); };
                recognition.start();
                setTimeout(() => recognition.stop(), 10000);
            });
        }

        async function calculateHeartRate(video, canvas) {
            try {
                const context = canvas.getContext('2d');
                const forehead = { x: canvas.width * 0.3, y: 0, width: canvas.width * 0.4, height: canvas.height * 0.2 };
                const greenValues = [];
                for (let i = 0; i < 30; i++) {
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const data = context.getImageData(forehead.x, forehead.y, forehead.width, forehead.height).data;
                    let greenSum = 0;
                    for (let j = 1; j < data.length; j += 4) greenSum += data[j];
                    greenValues.push(greenSum / (data.length / 4));
                    await new Promise(resolve => setTimeout(resolve, 1000 / 30));
                }
                if (typeof FFT === 'undefined') throw new Error('FFT not available');
                const fft = new FFT(greenValues.length, 30);
                fft.forward(greenValues);
                const magnitudes = fft.spectrum;
                let maxMag = 0;
                let maxIndex = 0;
                for (let i = 1; i < magnitudes.length / 2; i++) {
                    if (magnitudes[i] > magnitudes[maxMag]) {
                        maxMag = i;
                        maxIndex = i;
                    }
                }
                return Math.round(maxIndex * 30 / greenValues.length * 60);
            } catch (error) {
                console.warn('Heart rate calculation failed, using simulated value:', error.message);
                return simulateHeartRate();
            }
        }

        function simulateHeartRate() {
            const baseBpm = 70;
            const variance = Math.random() * 10 - 5;
            return Math.round(baseBpm + variance);
        }

        function getDiagnosisScores(facialData, voiceData, bpm) {
            const defaultScores = { sadness: 0, anger: 0, happiness: 0, surprise: 0, neutral: 0, fear: 0, disgust: 0 };
            const facialScores = facialData || defaultScores;
            const totalFacial = Object.values(facialScores).reduce((sum, val) => sum + val, 0);
            const normFacial = {};
            for (let emo in facialScores) normFacial[emo] = totalFacial ? facialScores[emo] / totalFacial : 0;

            const voiceScores = voiceData || defaultScores;
            const totalVoice = Object.values(voiceScores).reduce((sum, val) => sum + val, 0);
            const normVoice = {};
            for (let emo in voiceScores) normVoice[emo] = totalVoice ? voiceScores[emo] / totalVoice : 0;

            const hrWeight = bpm > 90 ? 0.2 : 0;
            const hrScores = bpm > 90 ? { anger: 0.5, fear: 0.3, sadness: 0.2 } : defaultScores;

            const voiceFailed = voiceData && voiceData.neutral === 1 && totalVoice === 1;
            const facialWeight = voiceFailed ? 0.8 : 0.5;
            const voiceWeight = voiceFailed ? 0.0 : 0.3;

            const finalScores = {};
            for (let emo in defaultScores) finalScores[emo] = facialWeight * (normFacial[emo] || 0) + voiceWeight * (normVoice[emo] || 0) + hrWeight * (hrScores[emo] || 0);
            return finalScores;
        }

        function unifyDiagnosis(facialData, voiceData, bpm) {
            const scores = getDiagnosisScores(facialData, voiceData, bpm);
            return Object.keys(scores).reduce((a, b) => scores[a] > scores[b] ? a : b);
        }

        function displayMonitoringResult(emotion, bpm, facialData, voiceData, resultDiv) {
            const bpmContext = bpm >= 60 && bpm <= 100 ? 'normal' : bpm < 60 ? 'baixa, consulte um m√©dico' : 'alta, relaxe';
            const diag = diagnosisMap[emotion] || diagnosisMap.neutral;
            let emotionalText = Array.isArray(diag.emotionalText) ? diag.emotionalText[Math.floor(Math.random() * diag.emotionalText.length)] : 
                (facialData && facialData.exhausted ? diag.emotionalText.cansa√ßo[Math.floor(Math.random() * diag.emotionalText.cansa√ßo.length)] : diag.emotionalText.apatia[Math.floor(Math.random() * diag.emotionalText.apatia.length)]);
            const physicalText = diag.physicalText.replace('${bpm}', bpm).replace('${bpmContext}', bpmContext);
            const suggestionText = typeof diag.suggestion === 'object' ? (facialData && facialData.exhausted ? diag.suggestion.cansa√ßo : diag.suggestion.apatia) : diag.suggestion;

            resultDiv.innerHTML = `
                <h3 class="text-lg font-semibold text-white mb-2">üß† Como voc√™ t√° se sentindo</h3>
                <p class="fade-in text-white">${emotionalText}</p>
                <h3 class="text-lg font-semibold text-white mt-4 mb-2">üíì O que teu corpo t√° dizendo</h3>
                <p class="fade-in text-white">${physicalText}</p>
                <h3 class="text-lg font-semibold text-white mt-4 mb-2">üßò O que fazer agora</h3>
                <p class="fade-in text-gray-300">${suggestionText}</p>
                <p class="fade-in text-gray-500 text-xs mt-2">Nota: Isso n√£o substitui um m√©dico, t√°? √â s√≥ um primeiro passo.</p>
                <div class="mt-4 flex flex-wrap gap-2">
                    <button id="retryBtn" class="futuristic-btn" aria-label="Tentar Novamente">üîÑ Tentar Novamente</button>
                    <a href="meditacao.html" class="futuristic-btn" aria-label="Ir para Medita√ß√£o Guiada">üßò‚Äç‚ôÄÔ∏è Medita√ß√£o Guiada</a>
                    <a href="${diag.link}" class="futuristic-btn" aria-label="Obter Apoio">ü´Ç Quero Mais Apoio</a>
                </div>
            `;

            document.getElementById('retryBtn').addEventListener('click', startMonitoring);
            speakDiagnosis(`${emotionalText} ${physicalText} ${suggestionText}`);
        }

        const diagnosisMap = {
            sadness: { 
                emotionalText: ["Sua express√£o t√° mais vazia que minha caneca de caf√© numa segunda-feira de manh√£‚Ä¶ algo t√° pesando a√≠ dentro, n√©? ‚òï"],
                physicalText: "Sua frequ√™ncia card√≠aca t√° em ${bpm} bpm, ${bpmContext}. Teu corpo t√° pedindo um momento de calma.",
                suggestion: "Que tal colocar uma m√∫sica que te anima ou escrever o que t√° te incomodando? Voc√™ n√£o t√° sozinho!",
                link: "apoio-emocional.html"
            },
            anger: { 
                emotionalText: ["Mand√≠bula tensa‚Ä¶ parece que voc√™ t√° segurando mais coisa a√≠ dentro do que minha av√≥ no bingo da igreja! üòÜ"],
                physicalText: "Sua frequ√™ncia card√≠aca t√° em ${bpm} bpm, ${bpmContext}. Teu corpo t√° pedindo pra aliviar essa carga.",
                suggestion: "Para um pouco e respira fundo. Solta esse peso como se fosse um grito (mas mental, t√°?).",
                link: "apoio-emocional.html"
            },
            neutral: { 
                emotionalText: {
                    cansa√ßo: ["Olhos pesados e inchados‚Ä¶ parece que o sono te deu um perdido e foi curtir a noite sem voc√™, hein? üòÖ"],
                    apatia: ["Fisionomia neutra‚Ä¶ parece que voc√™ t√° no modo zumbi, s√≥ esperando o apocalipse pra brilhar, n√©? üßü"]
                },
                physicalText: "Sua frequ√™ncia card√≠aca t√° em ${bpm} bpm, ${bpmContext}. Teu corpo t√° pedindo um respiro.",
                suggestion: {
                    cansa√ßo: "Que tal uma pausa de 5 minutinhos pra fechar os olhos e dar um truque nesse sono fuj√£o?",
                    apatia: "Que tal uma pausa pra focar na tua respira√ß√£o? Vamos trazer voc√™ de volta pro modo humano!"
                },
                link: "apoio-emocional.html"
            },
            fear: { 
                emotionalText: ["Piscar r√°pido, olhar inquieto‚Ä¶ sua ansiedade t√° mais acelerada que minha internet tentando abrir um PDF, hein? üì∂"],
                physicalText: "Sua frequ√™ncia card√≠aca t√° em ${bpm} bpm, ${bpmContext}. Teu corpo t√° pedindo um momento de paz.",
                suggestion: "Vamos desacelerar juntos: inspira por 4, segura por 4, solta por 4. Voc√™ t√° seguro aqui!",
                link: "apoio-emocional.html"
            }
        };
    </script>
</body>
</html>
