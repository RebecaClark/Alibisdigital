<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÓRBITA Quântica - Autocuidado do Futuro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap">
    <style>
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background: #0b1120; /* Fundo escuro padrão */
            color: #e5e7eb;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
            background: linear-gradient(135deg, #0b1120, #1e1b4b, #2e1065); /* Gradiente para o fundo */
        }
        .container {
            max-width: 1200px; /* Aumentado para melhor organização */
            margin: 0 auto;
            padding: 2rem;
            flex-grow: 1; /* Permite que o conteúdo ocupe o espaço disponível */
        }
        .futuristic-btn {
            display: inline-block;
            background: linear-gradient(45deg, #7C3AED, #22d3ee); /* Gradiente roxo-ciano */
            color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2), 0 0 8px #22d3ee;
            transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.5s ease;
            overflow: hidden;
            position: relative;
            z-index: 1;
        }
        .futuristic-btn:hover {
            transform: translateY(-3px) rotate(1deg);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05), 0 0 20px #22d3ee, 0 0 30px #22d3ee;
            background: linear-gradient(45deg, #6D28D9, #06B6D4);
        }
        .futuristic-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 300%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: lightSweep 3s infinite linear;
            z-index: -1;
        }
        @keyframes lightSweep {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .section-title {
            @apply text-3xl md:text-4xl font-bold text-center text-white mb-6;
        }
        .glassmorphic-card {
            background: rgba(255, 255, 255, 0.08); /* Mais transparente */
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2); /* Sombra mais profunda */
            backdrop-filter: blur(8px); /* Blur mais forte */
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.15); /* Borda mais suave */
            padding: 2.5rem; /* Padding aumentado */
            margin-bottom: 3rem; /* Espaçamento entre seções */
        }
        #camera-feed {
            width: 100%;
            max-width: 400px; /* Limita o tamanho para mobile */
            height: auto;
            aspect-ratio: 4/3; /* Mantém a proporção */
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 2px solid #22d3ee; /* Borda ciano neon */
            box-shadow: 0 0 15px rgba(34, 211, 238, 0.5); /* Efeito neon */
        }
        #emotion-result {
            font-size: 1.6rem; /* Tamanho maior */
            font-weight: bold;
            color: #a78bfa; /* Cor roxa clara */
            margin-top: 1rem;
            text-shadow: 0 0 10px rgba(167, 139, 250, 0.7); /* Sombra de texto neon */
        }
        #wellbeing-advice {
            margin-top: 0.8rem;
            color: #a7f3d0; /* Verde claro */
            font-size: 1rem;
        }
        .habit-tracker-item {
            @apply bg-gray-800 rounded-lg p-4 mb-3 flex justify-between items-center shadow-md;
        }
        .habit-button {
            @apply bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full transition duration-200 shadow-md;
        }
        .meditation-item, .tool-card {
            @apply bg-gray-900 rounded-lg p-5 mb-4 shadow-xl border border-gray-700 hover:border-blue-500 transition-all duration-300;
        }
        .tool-card h4 {
            @apply text-xl font-semibold text-white mb-2;
        }
        .tool-card p {
            @apply text-gray-300 text-sm;
        }
        .tool-card .play-button {
            @apply mt-3 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-full transition duration-200;
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 100; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.8); /* Black w/ opacity */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: linear-gradient(135deg, #1f2937, #111827); /* Fundo escuro gradiente */
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            max-width: 600px;
            width: 90%;
            position: relative;
            animation: fadeInScale 0.3s ease-out;
            border: 1px solid #22d3ee;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .close-button:hover,
        .close-button:focus {
            color: #22d3ee;
            text-decoration: none;
            cursor: pointer;
        }
        .progress-bar-container {
            width: 100%;
            background-color: #374151;
            border-radius: 9999px;
            height: 8px;
            margin-top: 1rem;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: #22d3ee;
            border-radius: 9999px;
            transition: width 0.3s ease-in-out;
        }
        .loading-dots::after {
            content: '';
            display: inline-block;
            width: 1em;
            height: 1em;
            animation: dots 1.5s steps(3, end) infinite;
        }
        @keyframes dots {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
            100% { content: '.'; }
        }
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .section-title { font-size: 2.2rem; }
            .glassmorphic-card { padding: 1.5rem; margin-bottom: 2rem; }
            .wellbeing-tools { grid-template-columns: 1fr; }
            #camera-feed { max-width: 100%; }
        }
    </style>
</head>
<body>
    <div id="particles-js"></div>
    <div class="container flex flex-col">
        <header class="py-8 text-center">
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">ÓRBITA Quântica</h1>
            <p class="text-lg md:text-xl text-gray-400">Seu espaço de autocuidado e evolução no futuro.</p>
        </header>

        <section class="glassmorphic-card mb-8">
            <h2 class="section-title">Monitoramento Emocional Quântico</h2>
            <p class="text-gray-300 mb-6 text-center">Ative sua câmera para uma análise em tempo real do seu estado emocional e receba insights personalizados.</p>
            <div class="flex flex-col items-center">
                <video id="camera-feed" autoplay playsinline></video>
                <canvas id="capture-canvas" class="hidden"></canvas>
                <input type="text" id="user-context" placeholder="Como você está se sentindo hoje (opcional)?"
                       class="w-full max-w-md rounded-md bg-gray-800 text-white placeholder-gray-500 p-3 mb-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300">
                <button id="analyze-emotion-btn" class="futuristic-btn">
                    <span id="analyze-button-text">Analisar Emoção</span>
                    <span id="loading-dots" class="loading-dots hidden"></span>
                </button>
                <div id="emotion-status" class="mt-4 text-center text-gray-400 text-sm">Aguardando análise...</div>
                <div id="emotion-result" class="mt-4 text-center"></div>
                <div id="wellbeing-advice" class="text-sm text-gray-400 mt-2 text-center"></div>
            </div>
        </section>

        <section class="glassmorphic-card mb-8">
            <h2 class="section-title">Registro de Hábitos Diários</h2>
            <p class="text-gray-300 mb-6 text-center">Acompanhe seus hábitos e construa uma rotina mais saudável.</p>
            <div id="habit-tracker" class="space-y-3">
                </div>
            <button onclick="addHabit()" class="futuristic-btn mt-6">Adicionar Novo Hábito</button>
        </section>

        <section class="glassmorphic-card mb-8">
            <h2 class="section-title">Ferramentas de Bem-Estar e Relaxamento</h2>
            <p class="text-gray-300 mb-6 text-center">Encontre paz, foco e equilíbrio com nossas ferramentas guiadas.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="tool-card">
                    <h4>Meditações Guiadas</h4>
                    <p>Encontre a calma com nossas sessões de meditação.</p>
                    <button class="play-button" onclick="openModal('meditation')">Explorar</button>
                </div>
                <div class="tool-card">
                    <h4>Histórias para Dormir</h4>
                    <p>Adormeça suavemente com narrativas tranquilizantes.</p>
                    <button class="play-button" onclick="openModal('sleep-story')">Explorar</button>
                </div>
                <div class="tool-card">
                    <h4>Alongamento & Yoga</h4>
                    <p>Mantenha seu corpo flexível e mente tranquila.</p>
                    <button class="play-button" onclick="openModal('exercise')">Explorar</button>
                </div>
                <div class="tool-card">
                    <h4>Exercícios de Respiração</h4>
                    <p>Controle o estresse e aumente o foco com a respiração.</p>
                    <button class="play-button" onclick="openModal('breathing')">Explorar</button>
                </div>
                <div class="tool-card">
                    <h4>Sons Relaxantes</h4>
                    <p>Crie seu ambiente perfeito com sons da natureza e mais.</p>
                    <button class="play-button" onclick="openModal('sounds')">Explorar</button>
                </div>
                <div class="tool-card">
                    <h4>Reflexão Diária</h4>
                    <p>Conecte-se consigo mesmo através de perguntas guiadas.</p>
                    <button class="play-button" onclick="dailyReflection()">Começar</button>
                </div>
            </div>
        </section>

        <section class="glassmorphic-card mb-8">
            <h2 class="section-title">Comunidade Órbita</h2>
            <p class="text-gray-300 mb-6 text-center">Conecte-se com outros exploradores do autocuidado.</p>
            <div id="community-orbita" class="text-center">
                <p class="text-gray-400 mb-4">Um espaço seguro para compartilhar experiências e crescer juntos.</p>
                <button onclick="joinCommunity()" class="futuristic-btn">Participar da Comunidade (Em Breve)</button>
            </div>
        </section>

        <section class="glassmorphic-card mb-8">
            <h2 class="section-title">Últimos Artigos e Insights</h2>
            <p class="text-gray-300 mb-6 text-center">Mantenha-se atualizado com as últimas pesquisas e tendências em bem-estar.</p>
            <div id="latest-articles" class="text-center">
                <p class="text-gray-400 mb-4">Conteúdo inspirador e educativo para sua jornada.</p>
                <a href="#" class="futuristic-btn">Explorar Artigos (Em Breve)</a>
            </div>
        </section>

        <footer class="py-8 text-center text-gray-500 mt-auto">
            <p>&copy; 2024 ÓRBITA Quântica. Todos os direitos reservados.</p>
        </footer>
    </div>

    <div id="interactiveModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle" class="text-2xl font-bold text-white mb-4"></h3>
            <div id="modalContent" class="text-gray-300 text-lg leading-relaxed mb-4"></div>
            <div class="flex justify-center space-x-4">
                <button id="start-narration" class="futuristic-btn play-button hidden">Narrar</button>
                <button id="stop-narration" class="futuristic-btn play-button hidden">Parar Narração</button>
                <button id="restart-narration" class="futuristic-btn play-button hidden">Reiniciar Narração</button>
            </div>
            <div class="progress-bar-container hidden" id="narration-progress-container">
                <div class="progress-bar" id="narration-progress"></div>
            </div>
        </div>
    </div>

    <script>
        // Inicialização de partículas de fundo
        particlesJS('particles-js', {
            particles: { number: { value: 80, density: { enable: true, value_area: 800 } }, color: { value: '#a78bfa' }, shape: { type: 'circle' }, opacity: { value: 0.5, random: true }, size: { value: 3, random: true }, line_linked: { enable: true, distance: 150, color: '#22d3ee', opacity: 0.4, width: 1 }, move: { enable: true, speed: 2, direction: 'none', random: false, straight: false, out_mode: 'out', bounce: false } },
            interactivity: { detect_on: 'canvas', events: { onhover: { enable: true, mode: 'grab' }, onclick: { enable: true, mode: 'push' }, resize: true }, modes: { grab: { distance: 200, line_linked: { opacity: 1 } }, push: { particles_nb: 4 } } }
        });

        // ==================================================================================================
        // !!! AVISO IMPORTANTE DE SEGURANÇA !!!
        // Estas chaves de API estão expostas no código do frontend APENAS PARA FINS DE TESTE.
        // EM PRODUÇÃO, ELAS DEVEM SER MOVIDAS PARA UM BACKEND SEGURO PARA PROTEGER SUAS CREDENCIAIS.
        // Após os testes, revogue estas chaves e crie novas para uso no backend.
        // ==================================================================================================
        const FACE_API_KEY = 'YOUR_FACE_API_KEY'; // Substitua pela sua chave da Face++
        const FACE_API_SECRET = 'YOUR_FACE_API_SECRET'; // Substitua pelo seu segredo da Face++
        const OPENAI_API_KEY = 'YOUR_OPENAI_API_KEY'; // Substitua pela sua chave da OpenAI
        // ==================================================================================================

        // --- Variáveis e Elementos do DOM para o Scanner ---
        const cameraFeed = document.getElementById('camera-feed');
        const captureCanvas = document.getElementById('capture-canvas');
        const analyzeEmotionBtn = document.getElementById('analyze-emotion-btn');
        const analyzeButtonText = document.getElementById('analyze-button-text');
        const loadingDots = document.getElementById('loading-dots');
        const emotionStatusDiv = document.getElementById('emotion-status');
        const emotionResultDiv = document.getElementById('emotion-result');
        const wellbeingAdviceDiv = document.getElementById('wellbeing-advice');
        const userContextInput = document.getElementById('user-context');

        let cameraStream;
        let isAnalyzing = false; // Para evitar cliques múltiplos durante a análise

        // --- Funções do Scanner ---
        async function startCamera() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
                cameraFeed.srcObject = cameraStream;
                emotionStatusDiv.textContent = "Câmera ativada. Pressione 'Analisar Emoção'.";
            } catch (error) {
                console.error("Erro ao acessar a câmera:", error);
                emotionStatusDiv.textContent = "Erro ao acessar a câmera. Verifique as permissões.";
                analyzeEmotionBtn.disabled = true;
            }
        }

        function captureFrame() {
            if (!cameraFeed || !captureCanvas || cameraFeed.videoWidth === 0) return null;
            captureCanvas.width = cameraFeed.videoWidth;
            captureCanvas.height = cameraFeed.videoHeight;
            const context = captureCanvas.getContext('2d');
            context.drawImage(cameraFeed, 0, 0, captureCanvas.width, captureCanvas.height);
            return captureCanvas.toDataURL('image/jpeg');
        }

        async function analyzeEmotion() {
            if (isAnalyzing) return;
            isAnalyzing = true;
            analyzeEmotionBtn.disabled = true;
            analyzeButtonText.classList.add('hidden');
            loadingDots.classList.remove('hidden');

            if (!FACE_API_KEY || FACE_API_KEY === 'YOUR_FACE_API_KEY' || !FACE_API_SECRET || FACE_API_SECRET === 'YOUR_FACE_API_SECRET' || !OPENAI_API_KEY || OPENAI_API_KEY === 'YOUR_OPENAI_API_KEY') {
                emotionStatusDiv.textContent = "Erro: Chaves de API não configuradas corretamente. Por favor, edite o código.";
                emotionResultDiv.textContent = "";
                wellbeingAdviceDiv.textContent = "";
                isAnalyzing = false;
                analyzeEmotionBtn.disabled = false;
                analyzeButtonText.classList.remove('hidden');
                loadingDots.classList.add('hidden');
                return;
            }

            const imageData = captureFrame();
            if (!imageData) {
                emotionStatusDiv.textContent = "Não foi possível capturar a imagem da câmera. Tente novamente.";
                emotionResultDiv.textContent = "";
                wellbeingAdviceDiv.textContent = "";
                isAnalyzing = false;
                analyzeEmotionBtn.disabled = false;
                analyzeButtonText.classList.remove('hidden');
                loadingDots.classList.add('hidden');
                return;
            }

            emotionStatusDiv.textContent = "Analisando expressão facial...";
            emotionResultDiv.textContent = "";
            wellbeingAdviceDiv.textContent = "";

            const formData = new URLSearchParams();
            formData.append('api_key', FACE_API_KEY);
            formData.append('api_secret', FACE_API_SECRET);
            formData.append('image_base64', imageData.split(',')[1]);
            formData.append('return_emotion', 1);

            try {
                const faceApiResponse = await fetch('https://api-us.faceplusplus.com/facepp/v3/detect', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });
                const faceData = await faceApiResponse.json();

                if (faceData.faces && faceData.faces.length > 0) {
                    const emotions = faceData.faces[0].emotion;
                    emotionStatusDiv.textContent = "Emoções faciais detectadas. Gerando diagnóstico...";
                    await getAiDiagnosis(emotions, userContextInput.value);
                } else {
                    emotionStatusDiv.textContent = "Nenhum rosto detectado. Posicione-se bem em frente à câmera.";
                    emotionResultDiv.textContent = "";
                    wellbeingAdviceDiv.textContent = "";
                }

            } catch (error) {
                console.error("Erro na API da Face++:", error);
                emotionStatusDiv.textContent = "Erro ao analisar a emoção (Face++). Tente novamente.";
                emotionResultDiv.textContent = "";
                wellbeingAdviceDiv.textContent = "";
            } finally {
                isAnalyzing = false;
                analyzeEmotionBtn.disabled = false;
                analyzeButtonText.classList.remove('hidden');
                loadingDots.classList.add('hidden');
            }
        }

        async function getAiDiagnosis(facialEmotions, userContext) {
            const dominantEmotion = Object.keys(facialEmotions).reduce((a, b) => facialEmotions[a] > facialEmotions[b] ? a : b);

            const prompt = `
                Analise as seguintes emoções faciais detectadas (percentuais: ${JSON.stringify(facialEmotions)}) e o contexto opcional fornecido pelo usuário ("${userContext}") para determinar o estado emocional geral de uma pessoa.
                Forneça uma emoção principal concisa e uma breve sugestão de bem-estar relacionada, que seja encorajadora e relevante para autocuidado.
                Evite termos médicos ou diagnósticos clínicos. Foque no bem-estar e na autoconsciência.

                Responda com um objeto JSON no seguinte formato:
                {"emotion": "emoção principal detectada", "advice": "breve sugestão de bem-estar personalizada"}
                Exemplo: {"emotion": "Calmo", "advice": "Mantenha a tranquilidade, talvez com uma breve meditação de foco."}
            `;

            try {
                const openaiResponse = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo', // Ou 'gpt-4o' se tiver acesso e preferir
                        messages: [{ role: 'user', content: prompt }],
                        response_format: { type: "json_object" } // Solicita um JSON como resposta
                    })
                });

                const aiData = await openaiResponse.json();

                if (aiData.choices && aiData.choices.length > 0 && aiData.choices[0].message && aiData.choices[0].message.content) {
                    try {
                        const diagnosis = JSON.parse(aiData.choices[0].message.content);
                        emotionResultDiv.textContent = `Você parece estar se sentindo: ${diagnosis.emotion || 'Indefinido'}.`;
                        wellbeingAdviceDiv.textContent = diagnosis.advice || "Esperamos que se sinta bem!";
                    } catch (e) {
                        console.error("Erro ao parsear JSON da OpenAI:", e);
                        emotionResultDiv.textContent = `Você parece estar se sentindo: ${dominantEmotion}.`;
                        wellbeingAdviceDiv.textContent = "Houve um problema ao obter uma sugestão da IA.";
                    }
                } else {
                    console.warn("Resposta da OpenAI incompleta ou inválida:", aiData);
                    emotionResultDiv.textContent = `Você parece estar se sentindo: ${dominantEmotion}.`;
                    wellbeingAdviceDiv.textContent = "Não foi possível obter uma sugestão da IA neste momento.";
                }

            } catch (error) {
                console.error("Erro na API da OpenAI:", error);
                emotionStatusDiv.textContent = "Erro ao conectar com a IA (OpenAI). Tente novamente.";
                emotionResultDiv.textContent = "";
                wellbeingAdviceDiv.textContent = "";
            }
        }

        // --- Funcionalidades de Registro de Hábitos ---
        let habits = [];
        const habitTrackerDiv = document.getElementById('habit-tracker');

        function loadHabits() {
            const storedHabits = localStorage.getItem('orbita_habits');
            if (storedHabits) {
                habits = JSON.parse(storedHabits);
                renderHabits();
            }
        }

        function saveHabits() {
            localStorage.setItem('orbita_habits', JSON.stringify(habits));
        }

        function renderHabits() {
            habitTrackerDiv.innerHTML = '';
            if (habits.length === 0) {
                habitTrackerDiv.innerHTML = '<p class="text-center text-gray-400">Nenhum hábito registrado ainda. Adicione um para começar!</p>';
            }
            habits.forEach((habit, index) => {
                const habitDiv = document.createElement('div');
                habitDiv.classList.add('habit-tracker-item');
                habitDiv.innerHTML = `
                    <span class="${habit.completed ? 'line-through text-gray-500' : 'text-white'} text-lg">${habit.name}</span>
                    <button class="habit-button ${habit.completed ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-600 hover:bg-blue-700'}"
                            onclick="toggleHabit(${index})">${habit.completed ? 'Concluído!' : 'Marcar como Concluído'}</button>
                `;
                habitTrackerDiv.appendChild(habitDiv);
            });
        }

        function addHabit() {
            const habitName = prompt("Qual hábito você gostaria de registrar (ex: Beber água, Meditar 10min)?");
            if (habitName && habitName.trim() !== "") {
                habits.push({ name: habitName.trim(), completed: false });
                saveHabits();
                renderHabits();
            } else if (habitName !== null) { // Se o usuário digitou algo mas era vazio
                alert("O nome do hábito não pode ser vazio.");
            }
        }

        function toggleHabit(index) {
            habits[index].completed = !habits[index].completed;
            saveHabits();
            renderHabits();
        }

        // --- Conteúdo das Ferramentas de Bem-Estar (Dados fictícios para demonstração) ---
        const meditations = [
            { title: "Meditação Guiada para Iniciantes", content: "Esta meditação suave irá guiá-lo através de técnicas básicas de atenção plena, ajudando a acalmar a mente e focar no presente. Respire profundamente e sinta a tranquilidade." },
            { title: "Meditação para Redução do Estresse", content: "Concentre-se em liberar tensões com esta meditação focada no corpo e na respiração. Deixe as preocupações irem e encontre um estado de relaxamento profundo." },
            { title: "Meditação da Gratidão", content: "Cultive um coração grato nesta meditação que o convida a refletir sobre as coisas boas da sua vida, grandes e pequenas. Sinta a alegria da gratidão." }
        ];

        const sleepStories = [
            { title: "A Viagem para a Floresta Encantada", content: "Deixe-se levar por uma jornada mágica através de uma floresta antiga, onde os murmúrios do vento e o canto dos pássaros o conduzem a um sono profundo e reparador. Cada passo é uma onda de relaxamento." },
            { title: "A Caverna dos Cristais", content: "Imagine-se em uma caverna luminosa, cercada por cristais brilhantes que emitem uma energia suave e curativa. Sinta a paz e a segurança enquanto mergulha no descanso." },
            { title: "O Jardim Secreto ao Luar", content: "Caminhe por um jardim sereno sob a luz prateada da lua. As flores perfumadas e a brisa suave acalmam seus pensamentos, preparando-o para uma noite de sono tranquilo e sonhos doces." }
        ];

        const exercises = [
            { title: "Alongamento Matinal Suave", content: "Comece o dia com uma série de alongamentos suaves para despertar seu corpo, aliviar tensões e preparar-se para o dia com flexibilidade e energia. Preste atenção em cada músculo." },
            { title: "Yoga para Relaxamento Profundo", content: "Esta sequência de yoga suave e restauradora foi projetada para liberar o estresse acumulado no corpo e na mente, promovendo um relaxamento profundo e restaurador. Deixe a gravidade fazer o trabalho." }
        ];

        const breathingExercises = [
            { title: "Respiração 4-7-8", content: "A técnica de respiração 4-7-8 é um poderoso relaxante natural. Inspire por 4 segundos, segure por 7, expire por 8. Repita para acalmar seu sistema nervoso." },
            { title: "Respiração Quadrada", content: "Ideal para focar e reduzir a ansiedade. Inspire, segure, expire e segure, cada um por 4 segundos. Visualiza um quadrado perfeito com sua respiração." }
        ];

        const relaxingSounds = [
            { title: "Sons da Chuva Calma", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" }, // Exemplo de MP3
            { title: "Ondas do Mar Suaves", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" }, // Exemplo de MP3
            { title: "Flauta Nativa Americana", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3" } // Exemplo de MP3
        ];

        // --- Funções do Modal ---
        const interactiveModal = document.getElementById('interactiveModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');
        const startNarrationBtn = document.getElementById('start-narration');
        const stopNarrationBtn = document.getElementById('stop-narration');
        const restartNarrationBtn = document.getElementById('restart-narration');
        const narrationProgressBarContainer = document.getElementById('narration-progress-container');
        const narrationProgressBar = document.getElementById('narration-progress');

        let currentNarrationText = "";
        let currentUtterance = null;
        let speechSynth = window.speechSynthesis;

        function openModal(type) {
            interactiveModal.classList.remove('hidden');
            modalContent.innerHTML = ''; // Limpa conteúdo anterior
            startNarrationBtn.classList.add('hidden');
            stopNarrationBtn.classList.add('hidden');
            restartNarrationBtn.classList.add('hidden');
            narrationProgressBarContainer.classList.add('hidden');

            let items = [];
            let displayHtml = '';
            modalTitle.textContent = "Explorar";

            switch (type) {
                case 'meditation':
                    modalTitle.textContent = "Meditações Guiadas";
                    items = meditations;
                    items.forEach((item, index) => {
                        displayHtml += `<div class="p-3 bg-gray-800 rounded-md mb-2">
                                            <h4 class="font-semibold text-white">${item.title}</h4>
                                            <p class="text-gray-400 text-sm mt-1">${item.content.substring(0, 120)}...</p>
                                            <button class="mt-2 bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded-full text-sm"
                                                    onclick="selectAndNarrate('${item.title}', '${item.content}', 'meditation')">Iniciar</button>
                                        </div>`;
                    });
                    break;
                case 'sleep-story':
                    modalTitle.textContent = "Histórias para Dormir";
                    items = sleepStories;
                    items.forEach((item, index) => {
                        displayHtml += `<div class="p-3 bg-gray-800 rounded-md mb-2">
                                            <h4 class="font-semibold text-white">${item.title}</h4>
                                            <p class="text-gray-400 text-sm mt-1">${item.content.substring(0, 120)}...</p>
                                            <button class="mt-2 bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded-full text-sm"
                                                    onclick="selectAndNarrate('${item.title}', '${item.content}', 'sleep-story')">Iniciar</button>
                                        </div>`;
                    });
                    break;
                case 'exercise':
                    modalTitle.textContent = "Alongamento & Yoga";
                    items = exercises;
                    items.forEach((item, index) => {
                        displayHtml += `<div class="p-3 bg-gray-800 rounded-md mb-2">
                                            <h4 class="font-semibold text-white">${item.title}</h4>
                                            <p class="text-gray-400 text-sm mt-1">${item.content.substring(0, 120)}...</p>
                                            <button class="mt-2 bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded-full text-sm"
                                                    onclick="selectAndNarrate('${item.title}', '${item.content}', 'exercise')">Iniciar</button>
                                        </div>`;
                    });
                    break;
                case 'breathing':
                    modalTitle.textContent = "Exercícios de Respiração";
                    items = breathingExercises;
                    items.forEach((item, index) => {
                        displayHtml += `<div class="p-3 bg-gray-800 rounded-md mb-2">
                                            <h4 class="font-semibold text-white">${item.title}</h4>
                                            <p class="text-gray-400 text-sm mt-1">${item.content.substring(0, 120)}...</p>
                                            <button class="mt-2 bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded-full text-sm"
                                                    onclick="selectAndNarrate('${item.title}', '${item.content}', 'breathing')">Iniciar</button>
                                        </div>`;
                    });
                    break;
                case 'sounds':
                    modalTitle.textContent = "Sons Relaxantes";
                    items = relaxingSounds;
                    items.forEach((item, index) => {
                        displayHtml += `<div class="p-3 bg-gray-800 rounded-md mb-2">
                                            <h4 class="font-semibold text-white">${item.title}</h4>
                                            <audio controls class="w-full mt-2" src="${item.src}"></audio>
                                        </div>`;
                    });
                    break;
            }
            modalContent.innerHTML = displayHtml || '<p class="text-gray-400">Conteúdo não disponível.</p>';
        }

        function closeModal() {
            interactiveModal.classList.add('hidden');
            stopNarration(); // Garante que a narração pare ao fechar o modal
        }

        function cleanTextForNarration(text) {
            // Remove caracteres especiais que podem causar problemas na fala
            return text.replace(/[^a-zA-Z0-9\s.,!?;áéíóúÁÉÍÓÚãõÃÕâêôÂÊÔçÇ]/g, '').replace(/\s+/g, ' ').trim();
        }

        function selectAndNarrate(title, content, type) {
            modalTitle.textContent = title;
            modalContent.innerHTML = `<p>${content}</p>`; // Exibe o conteúdo completo
            currentNarrationText = cleanTextForNarration(content);

            startNarrationBtn.classList.remove('hidden');
            stopNarrationBtn.classList.add('hidden');
            restartNarrationBtn.classList.add('hidden');
            narrationProgressBarContainer.classList.remove('hidden');
            narrationProgressBar.style.width = '0%'; // Resetar barra de progresso

            // Adiciona listeners para os botões de controle de narração
            startNarrationBtn.onclick = () => narrateText(currentNarrationText);
            stopNarrationBtn.onclick = stopNarration;
            restartNarrationBtn.onclick = () => { stopNarration(); narrateText(currentNarrationText); };

            narrateText(currentNarrationText); // Inicia automaticamente ao selecionar
        }

        function narrateText(text) {
            if (!speechSynth) {
                alert("Seu navegador não suporta síntese de fala.");
                return;
            }
            if (speechSynth.speaking) {
                speechSynth.cancel(); // Para a fala atual antes de começar uma nova
            }

            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.lang = 'pt-BR';
            currentUtterance.rate = 0.9; // Ajuste a velocidade se necessário
            currentUtterance.pitch = 1.0; // Ajuste o tom se necessário
            currentUtterance.volume = 0.9;

            let charIndex = 0;
            currentUtterance.onboundary = (event) => {
                if (event.name === 'word') {
                    charIndex = event.charIndex;
                    const progress = (charIndex / text.length) * 100;
                    narrationProgressBar.style.width = `${progress}%`;
                }
            };

            currentUtterance.onend = () => {
                narrationProgressBar.style.width = '100%';
                startNarrationBtn.classList.add('hidden');
                stopNarrationBtn.classList.add('hidden');
                restartNarrationBtn.classList.remove('hidden');
                console.log("Narração concluída.");
            };

            currentUtterance.onstart = () => {
                startNarrationBtn.classList.add('hidden');
                stopNarrationBtn.classList.remove('hidden');
                restartNarrationBtn.classList.add('hidden');
                console.log("Narração iniciada.");
            };

            currentUtterance.onerror = (event) => {
                console.error('Erro na síntese de fala:', event.error);
                stopNarration();
            };

            speechSynth.speak(currentUtterance);
        }

        function stopNarration() {
            if (speechSynth.speaking) {
                speechSynth.cancel();
                startNarrationBtn.classList.remove('hidden');
                stopNarrationBtn.classList.add('hidden');
                restartNarrationBtn.classList.remove('hidden');
                narrationProgressBar.style.width = `${(currentUtterance && currentUtterance.charIndex) ? (currentUtterance.charIndex / currentUtterance.text.length) * 100 : 0}%`;
                console.log("Narração parada.");
            }
        }

        // --- Outras Funções do ÓRBITA ---
        function dailyReflection() {
            const questions = [
                "Qual foi o momento mais positivo do seu dia?",
                "O que você aprendeu de novo hoje?",
                "Pelo que você é grato(a) neste momento?",
                "Como você cuidou de si mesmo(a) hoje?",
                "Se pudesse mudar uma coisa no seu dia, qual seria e por quê?"
            ];
            const selectedQuestion = questions[Math.floor(Math.random() * questions.length)];
            const userResponse = prompt(`Pergunta do Dia:\n"${selectedQuestion}"\n\nSua resposta:`);

            if (userResponse !== null) { // Se o usuário não cancelou o prompt
                openModal('reflection-result'); // Reutilize o modal para exibir a resposta
                modalTitle.textContent = "Sua Reflexão Diária";
                modalContent.innerHTML = `<p class="mb-2"><strong>Pergunta:</strong> ${selectedQuestion}</p><p><strong>Sua Resposta:</strong> ${userResponse || 'Nenhuma resposta registrada.'}</p><p class="mt-4 text-gray-400 text-sm">Refletir ajuda a construir autoconsciência. Ótimo trabalho!</p>`;
                startNarrationBtn.classList.add('hidden');
                stopNarrationBtn.classList.add('hidden');
                restartNarrationBtn.classList.add('hidden');
                narrationProgressBarContainer.classList.add('hidden');
            }
        }

        function joinCommunity() {
            alert("A Comunidade Órbita está em desenvolvimento! Fique ligado(a) para novidades.");
        }


        // --- Inicialização da Página ---
        document.addEventListener('DOMContentLoaded', () => {
            startCamera();
            loadHabits();
            renderHabits(); // Garante que os hábitos são exibidos mesmo que a lista esteja vazia

            analyzeEmotionBtn.addEventListener('click', analyzeEmotion);

            // Adiciona o fechamento do modal ao clicar fora do conteúdo
            interactiveModal.addEventListener('click', (e) => {
                if (e.target === interactiveModal) {
                    closeModal();
                }
            });
        });
    </script>
</body>
</html>
