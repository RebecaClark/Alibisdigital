<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scanner Emocional - √Ålibis Digital</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tracking.js/1.1.3/tracking-min.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #0b1120, #1e3a8a);
    }
    .hidden { display: none; }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .loading-dots::after { content: '...'; animation: dots 1.5s infinite; }
    @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } }
    .futuristic-btn {
      background: linear-gradient(45deg, #22d3ee, #3b82f6);
      transition: background 0.3s ease;
    }
    .futuristic-btn:hover {
      background: linear-gradient(45deg, #3b82f6, #22d3ee);
    }
    .shine {
      animation: shine 2s infinite;
    }
    @keyframes shine {
      0% { text-shadow: 0 0 5px #22d3ee; }
      50% { text-shadow: 0 0 20px #22d3ee, 0 0 30px #3b82f6; }
      100% { text-shadow: 0 0 5px #22d3ee; }
    }
    .neon-box {
      border: 1px solid #22d3ee;
      padding: 20px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.05);
    }
    .mic-prompt {
      display: flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.1);
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
    }
    .mic-icon::before {
      content: 'üéôÔ∏è';
      margin-right: 8px;
    }
    .ppg-overlay {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
    }
    .ppg-overlay.active {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .ppg-stay-still {
      color: #22d3ee;
      font-size: 1.2rem;
      margin-bottom: 10px;
    }
    .ppg-progress-container {
      width: 80%;
      height: 10px;
      background: #333;
      border-radius: 5px;
    }
    .ppg-progress-bar {
      height: 100%;
      background: #22d3ee;
      width: 0%;
      transition: width 0.1s linear;
      border-radius: 5px;
    }
    .video-placeholder {
      width: 400px;
      height: 300px;
      background: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      border-radius: 12px;
    }
    .animate-on-scroll.active {
      animation: slideIn 0.5s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .face-guide {
      position: absolute;
      width: 400px;
      height: 300px;
      border: 2px dashed #22d3ee;
      box-sizing: border-box;
      pointer-events: none;
    }
    .scanner-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .video-container {
      position: relative;
      width: 400px;
      height: 300px;
    }
  </style>
</head>
<body class="text-white font-sans">
  <div id="particles-js" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;"></div>
  <div id="particles-fallback" class="hidden text-center text-gray-400 p-4">Particle effect failed to load. Please check your internet connection.</div>

  <header class="fixed top-0 left-0 w-full z-50 transition-shadow duration-300 bg-opacity-90 bg-gray-900">
    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
      <div class="flex items-center">
        <a href="/index.html" aria-label="P√°gina inicial da √Ålibis Digital">
          <img src="/assets/logo.png" alt="Logo da √Ålibis Digital" class="h-10 w-auto" onerror="this.src='https://via.placeholder.com/100x40?text=Logo'; console.error('Erro ao carregar logo.png')">
        </a>
      </div>
      <div class="flex items-center">
        <div class="md:hidden">
          <button id="hamburger-menu" class="text-white focus:outline-none p-2 rounded" aria-label="Abrir menu de navega√ß√£o">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </div>
        <div class="relative">
          <select id="language-selector" class="bg-transparent text-white border border-[#22d3ee] rounded-full px-3 py-1 focus:outline-none appearance-none" onchange="changeLanguage()">
            <option value="pt-BR">Portugu√™s</option>
          </select>
          <svg class="w-4 h-4 absolute right-2 top-1/2 transform -translate-y-1/2 text-white pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </div>
      </div>
      <nav id="navbar" class="hidden md:flex space-x-6 text-sm items-center">
        <div class="dropdown relative">
          <button class="hover:text-[#22d3ee] transition flex items-center" aria-label="Abrir menu de servi√ßos">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l-7 7-7 7"></path>
            </svg>
            <span>Servi√ßos</span>
            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div class="dropdown-menu">
            <a href="/scanner.html" class="hover:text-[#22d3ee] transition">Scanner com IA</a>
            <a href="/apoio-emocional.html" class="hover:text-[#22d3ee] transition">Avalia√ß√£o Emocional</a>
            <a href="/medical-ai.html" class="hover:text-[#22d3ee] transition">Diagn√≥stico M√©dico</a>
            <a href="/alibi.html" class="hover:text-[#22d3ee] transition">Criar √Ålibi</a>
          </div>
        </div>
        <a href="/blog.html" class="hover:text-[#22d3ee] transition">Blog</a>
        <a href="/planos.html" class="hover:text-[#22d3ee] transition">Planos</a>
        <a href="/suporte.html" class="hover:text-[#22d3ee] transition">Suporte</a>
        <a href="/planos.html" class="futuristic-btn text-white py-2 px-4 rounded-full text-sm font-semibold shine" aria-label="Teste Gr√°tis">üîç Teste Gr√°tis</a>
      </nav>
    </div>
    <div id="mobile-menu" class="md:hidden bg-gray-800 bg-opacity-95 w-full hidden py-4">
      <nav class="flex flex-col items-center space-y-4">
        <div class="w-full">
          <button id="services-toggle" class="text-white py-2 px-4 text-lg w-full text-center hover:bg-gray-700 rounded flex justify-between items-center">
            <span>Servi√ßos</span>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div id="services-menu" class="dropdown-menu-mobile hidden">
            <a href="/scanner.html" class="hover:bg-gray-700">Scanner com IA</a>
            <a href="/apoio-emocional.html" class="hover:bg-gray-700">Avalia√ß√£o Emocional</a>
            <a href="/medical-ai.html" class="hover:bg-gray-700">Diagn√≥stico M√©dico</a>
            <a href="/alibi.html" class="hover:bg-gray-700">Criar √Ålibi</a>
          </div>
        </div>
        <a href="/blog.html" class="text-white py-2 px-4 text-lg w-full text-center hover:bg-gray-700 rounded">Blog</a>
        <a href="/planos.html" class="text-white py-2 px-4 text-lg w-full text-center hover:bg-gray-700 rounded">Planos</a>
        <a href="/suporte.html" class="text-white py-2 px-4 text-lg w-full text-center hover:bg-gray-700 rounded">Suporte</a>
        <a href="/planos.html" class="futuristic-btn text-white py-2 px-4 rounded-full text-lg w-full text-center shine" aria-label="Teste Gr√°tis">üîç Teste Gr√°tis</a>
      </nav>
    </div>
  </header>
  <div class="h-20"></div>

  <section id="hero" class="text-white text-center py-20 px-6 relative animate-on-scroll">
    <div class="max-w-6xl mx-auto">
      <h1 class="text-5xl md:text-6xl font-serif font-bold mb-6 leading-tight fade-in">Transforme Sua Vida com o Scanner Emocional</h1>
      <p class="text-lg md:text-xl text-gray-300 mb-10 fade-in">Descubra seu estado emocional com IA avan√ßada. Teste gr√°tis agora!</p>
      <div>
        <a href="/relatorios-avancados.html" class="futuristic-btn text-white font-bold py-3 px-8 rounded-full shine" aria-label="Obter Relat√≥rios Avan√ßados">üîç Obter Relat√≥rios Avan√ßados</a>
      </div>
    </div>
  </section>

  <section class="py-10 px-6 text-center animate-on-scroll" id="emotion-intro">
    <div class="max-w-4xl mx-auto">
      <p class="text-lg mb-6 text-gray-300 fade-in">Nosso scanner analisa express√µes faciais, frequ√™ncia card√≠aca e tom de voz para identificar seu estado emocional com precis√£o.</p>
      <button onclick="document.getElementById('scanner').scrollIntoView({behavior: 'smooth'})" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine" aria-label="Come√ßar o Scanner">Come√ßar o Scanner</button>
    </div>
  </section>

  <section class="py-10 px-6 text-center animate-on-scroll scanner-container" id="scanner">
    <h2 class="text-4xl font-bold mb-6 text-white shine">Seu rosto carrega sinais. Vamos descobrir o que ele diz?</h2>
    <p class="text-lg mb-8 text-gray-300 fade-in">Ative sua c√¢mera e permita acesso a dados biom√©tricos (frequ√™ncia card√≠aca) para um diagn√≥stico emocional detalhado com idade aparente.</p>
    <div class="flex flex-col items-center mb-4">
      <div class="video-container">
        <video id="video" width="400" height="300" autoplay class="rounded-xl shadow-md border border-[#22d3ee]" aria-label="V√≠deo da c√¢mera para an√°lise emocional"></video>
        <div id="face-guide" class="face-guide hidden"></div>
        <div id="ppg-overlay" class="ppg-overlay">
          <span class="ppg-stay-still">Fique parado</span>
          <div class="ppg-progress-container">
            <div id="ppg-progress-bar" class="ppg-progress-bar"></div>
          </div>
        </div>
        <div id="video-placeholder" class="video-placeholder">C√¢mera n√£o dispon√≠vel</div>
      </div>
      <div id="mic-prompt" class="mic-prompt" style="display: none;">
        <span class="mic-icon"></span>
        <span>Leia esta frase: "Estou me sentindo bem hoje"</span>
      </div>
      <div id="speech-output" class="mt-2 text-gray-300 text-lg hidden"></div>
      <div id="vr-toggle" class="mt-4">
        <button onclick="toggleVR()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine" aria-label="Ativar Relaxamento VR/AR">Ativar Relaxamento VR/AR</button>
      </div>
    </div>
    <div class="flex justify-center mb-4">
      <button onclick="startAnalysisWithDelay()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine" aria-label="Analisar Estado Emocional">Analisar Estado Emocional</button>
      <button onclick="initMedicalConsult()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine ml-4" aria-label="Consultar M√©dico">Consultar M√©dico</button>
    </div>
    <div id="scanner-result" class="neon-box mt-6" style="display: none;"></div>
    <div class="testimonials mt-8 max-w-4xl mx-auto">
      <h3 class="text-2xl font-bold mb-4 text-white shine">O que nossos usu√°rios dizem</h3>
      <div class="flex flex-wrap justify-center">
        <div class="testimonial-card flex items-center p-4">
          <img src="https://via.placeholder.com/60" alt="Foto de Ana" class="w-16 h-16 rounded-full mr-4">
          <div>
            <p class="text-gray-300">"O Scanner mudou minha vida! Descobri o que me estressava e agora vivo mais leve."</p>
            <p class="text-sm text-gray-400 mt-2">- Ana, 34 anos</p>
          </div>
        </div>
        <div class="testimonial-card flex items-center p-4">
          <img src="https://via.placeholder.com/60" alt="Foto de Jo√£o" class="w-16 h-16 rounded-full mr-4">
          <div>
            <p class="text-gray-300">"Incr√≠vel como a IA me ajudou a entender minhas emo√ß√µes. Recomendo!"</p>
            <p class="text-sm text-gray-400 mt-2">- Jo√£o, 29 anos</p>
          </div>
        </div>
      </div>
    </div>
    <div id="vr-container" style="display: none;"></div>
    <canvas id="canvas" width="400" height="300" style="display: none;"></canvas>
  </section>

  <footer class="bg-gray-900 bg-opacity-90 text-gray-400 py-12 animate-on-scroll">
    <div class="max-w-6xl mx-auto px-6 grid grid-cols-1 md:grid-cols-3 gap-10 text-sm">
      <div class="fade-in">
        <h3 class="text-white text-2xl font-bold mb-4 shine">√Ålibis Digital</h3>
        <p class="fade-in">Solu√ß√µes de bem-estar com tecnologia avan√ßada.</p>
      </div>
      <div class="fade-in">
        <h4 class="text-white font-semibold mb-4">Navegue</h4>
        <ul class="space-y-2">
          <li><a href="/index.html" class="hover:text-white transition">In√≠cio</a></li>
          <li><a href="/scanner.html" class="hover:text-white transition">Scanner</a></li>
          <li><a href="/blog.html" class="hover:text-white transition">Blog</a></li>
          <li><a href="/medical-ai.html" class="hover:text-white transition">Diagn√≥stico M√©dico</a></li>
          <li><a href="/apoio-emocional.html" class="hover:text-white transition">Avalia√ß√£o Emocional</a></li>
          <li><a href="/alibi.html" class="hover:text-white transition">Criar √Ålibi</a></li>
          <li><a href="/planos.html" class="hover:text-white transition">Planos</a></li>
          <li><a href="/suporte.html" class="hover:text-white transition">Suporte</a></li>
          <li><a href="/politica-privacidade.html" class="hover:text-white transition">Privacidade</a></li>
        </ul>
      </div>
      <div class="fade-in">
        <h4 class="text-white font-semibold mb-4">Contato</h4>
        <ul class="space-y-2">
          <li class="fade-in">E-mail: contato@alibisdigital.com</li>
          <li class="fade-in">WhatsApp: (11) 91234-5678</li>
        </ul>
      </div>
    </div>
    <div class="text-center mt-8">
      <p class="text-sm">¬© 2025 √Ålibis Digital. Todos os direitos reservados.</p>
    </div>
  </footer>

  <!-- Scripts -->
  <script>
    console.log('Loading scanner.html at', new Date().toISOString());

    function initializeParticles() {
      if (typeof particlesJS !== 'undefined') {
        particlesJS('particles-js', {
          particles: {
            number: { value: 100, density: { enable: true, value_area: 800 } },
            color: { value: '#22d3ee' },
            shape: { type: 'circle' },
            opacity: { value: 0.7, random: true },
            size: { value: 3, random: true },
            line_linked: {
              enable: true,
              distance: 120,
              color: '#22d3ee',
              opacity: 0.4,
              width: 1
            },
            move: { speed: 1, direction: 'none', random: true }
          },
          interactivity: {
            detect_on: 'canvas',
            events: {
              onhover: { enable: true, mode: 'repulse' },
              onclick: { enable: true, mode: 'push' }
            }
          },
          retina_detect: true
        });
        console.log('Particles.js loaded successfully with hexagonal effect');
      } else {
        console.error('particlesJS not loaded - showing fallback');
        document.getElementById('particles-fallback').classList.remove('hidden');
      }
    }

    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      initializeParticles();
    } else {
      window.addEventListener('DOMContentLoaded', initializeParticles);
    }

    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      particlesJS('particles-js', { particles: { number: { value: 0 } } });
      console.log('Reduced motion detected - particles disabled');
    }
  </script>

  <script>
    // Carregar chaves de vari√°veis de ambiente ou usar fallback hardcoded
    const apiKey = window.apiKey || 'AmoIQKuEFggNsZmeO_Ur50ZZmfSrZ3mX'; // Substitua pelo fallback se necess√°rio
    const apiSecret = window.apiSecret || 'WoRf3C8_IqQhe0Su8coFmOnAB_0nOheY'; // Substitua pelo fallback se necess√°rio
    let lastDetectedEmotion = null;

    function generateDiagnosis(primaryEmotion, heartRate, age, isSimulated) {
      const emotionPortuguese = {
        sadness: 'tristeza',
        anger: 'raiva',
        happiness: 'felicidade',
        surprise: 'surpresa',
        neutral: 'neutra',
        fear: 'medo',
        disgust: 'nojo'
      };

      const primaryEmotionInPortuguese = emotionPortuguese[primaryEmotion] || primaryEmotion;
      const ageRangeMin = Math.max(18, age - 5);
      const ageRangeMax = age + 5;
      let diagnosis = '';
      let triggers = '';
      let suggestion = '';
      let personalizedPlan = '';
      let ctaButtons = '';

      switch (primaryEmotion) {
        case 'happiness':
          diagnosis = `Voc√™ est√° radiante, com uma frequ√™ncia card√≠aca de ${heartRate} bpm, refletindo felicidade e leveza.`;
          triggers = 'Pode ser resultado de uma conquista recente, uma conex√£o social significativa ou um momento de satisfa√ß√£o pessoal.';
          suggestion = 'Aproveite essa energia positiva para se conectar com amigos ou explorar uma atividade criativa.';
          personalizedPlan = 'Plano: 10 minutos de medita√ß√£o di√°ria e caminhada ao ar livre.';
          ctaButtons = '<div class="mt-6"><button onclick="window.location.href=\'/planos.html\'" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Assinar Plano</button></div>';
          break;
        case 'sadness':
          diagnosis = `Sua express√£o reflete tristeza, com frequ√™ncia card√≠aca de ${heartRate} bpm, indicando introspec√ß√£o ou sobrecarga emocional.`;
          triggers = 'Isso pode estar ligado a saudades, estresse acumulado ou uma perda recente.';
          suggestion = 'Experimente medita√ß√£o guiada por 5 minutos ou escreva seus pensamentos.';
          personalizedPlan = 'Plano: 5 minutos de respira√ß√£o consciente e consulta com apoio emocional.';
          ctaButtons = '<div class="mt-6"><button onclick="window.location.href=\'/apoio-emocional.html\'" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Explorar Apoio Emocional</button></div>';
          break;
        case 'anger':
          diagnosis = `Sua express√£o mostra raiva, com frequ√™ncia card√≠aca de ${heartRate} bpm, sugerindo tens√£o ou frustra√ß√£o.`;
          triggers = 'Pode ser devido a um conflito recente, press√£o no trabalho ou uma situa√ß√£o irritante.';
          suggestion = 'Tente uma caminhada r√°pida para liberar a tens√£o ou pratique exerc√≠cios de respira√ß√£o profunda.';
          personalizedPlan = 'Plano: 10 minutos de alongamento e pr√°tica de mindfulness para aliviar a tens√£o.';
          ctaButtons = '<div class="mt-6"><button onclick="window.location.href=\'/apoio-emocional.html\'" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Explorar Apoio Emocional</button></div>';
          break;
        case 'fear':
          diagnosis = `Sua express√£o indica medo, com frequ√™ncia card√≠aca de ${heartRate} bpm, refletindo ansiedade ou incerteza.`;
          triggers = 'Pode estar relacionado a uma situa√ß√£o de incerteza, preocupa√ß√£o com o futuro ou um evento estressante.';
          suggestion = 'Pratique a t√©cnica de respira√ß√£o 4-7-8 para acalmar o sistema nervoso.';
          personalizedPlan = 'Plano: 5 minutos de respira√ß√£o 4-7-8 e uma sess√£o de relaxamento guiado.';
          ctaButtons = '<div class="mt-6"><button onclick="window.location.href=\'/apoio-emocional.html\'" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Explorar Apoio Emocional</button></div>';
          break;
        case 'surprise':
          diagnosis = `Voc√™ parece surpreso, com frequ√™ncia card√≠aca de ${heartRate} bpm, indicando um momento inesperado.`;
          triggers = 'Pode ser resultado de uma novidade, uma not√≠cia inesperada ou uma mudan√ßa repentina.';
          suggestion = 'Aproveite a energia da surpresa para explorar algo novo ou refletir sobre o que causou essa rea√ß√£o.';
          personalizedPlan = 'Plano: 10 minutos de escrita reflexiva sobre o evento que causou surpresa.';
          ctaButtons = '<div class="mt-6"><button onclick="window.location.href=\'/planos.html\'" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Assinar Plano</button></div>';
          break;
        case 'disgust':
          diagnosis = `Sua express√£o reflete nojo, com frequ√™ncia card√≠aca de ${heartRate} bpm, indicando desagrado.`;
          triggers = 'Pode estar ligado a uma situa√ß√£o desconfort√°vel, algo que voc√™ considera inaceit√°vel ou um ambiente desagrad√°vel.';
          suggestion = 'Tente se afastar da fonte do desagrado e pratique uma atividade que traga conforto.';
          personalizedPlan = 'Plano: 10 minutos de relaxamento com m√∫sica calma e um ch√° quente.';
          ctaButtons = '<div class="mt-6"><button onclick="window.location.href=\'/apoio-emocional.html\'" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Explorar Apoio Emocional</button></div>';
          break;
        case 'neutral':
          diagnosis = `Sua express√£o √© neutra, com frequ√™ncia card√≠aca de ${heartRate} bpm, sugerindo calma ou concentra√ß√£o.`;
          triggers = 'Pode indicar que voc√™ est√° em um estado de equil√≠brio ou focado em uma tarefa.';
          suggestion = 'Continue mantendo esse equil√≠brio com pr√°ticas de mindfulness ou pausas regulares.';
          personalizedPlan = 'Plano: 5 minutos de alongamento leve e hidrata√ß√£o regular.';
          ctaButtons = '<div class="mt-6"><button onclick="window.location.href=\'/planos.html\'" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Assinar Plano</button></div>';
          break;
        default:
          diagnosis = `Emo√ß√£o predominante: ${primaryEmotionInPortuguese}, com frequ√™ncia card√≠aca de ${heartRate} bpm.`;
          triggers = 'Estamos analisando poss√≠veis gatilhos para essa emo√ß√£o.';
          suggestion = 'Tente refletir sobre o que pode estar influenciando esse estado.';
          personalizedPlan = 'Plano: 5 minutos de pausa para reflex√£o.';
          ctaButtons = '<div class="mt-6"><button onclick="window.location.href=\'/planos.html\'" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Assinar Plano</button></div>';
      }

      if (isSimulated) {
        diagnosis += ' <span class="text-yellow-300"> (Frequ√™ncia card√≠aca estimada devido a falha na medi√ß√£o precisa)</span>';
      }

      return { diagnosis, triggers, suggestion, personalizedPlan, ctaButtons, ageRangeMin, ageRangeMax, primaryEmotionInPortuguese };
    }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM carregado, inicializando scanner...');
      const video = document.getElementById('video');
      const placeholder = document.getElementById('video-placeholder');
      const result = document.getElementById('scanner-result');
      const vrContainer = document.getElementById('vr-container');

      if (result) {
        result.style.display = 'none';
        result.innerHTML = '';
        console.log('Resultado inicializado como oculto');
      }

      if (video && placeholder) {
        video.classList.add('hidden');
        placeholder.classList.remove('hidden');
        console.log('Camera will be initialized on user action');
      } else {
        console.error('Elementos de v√≠deo ou placeholder n√£o encontrados');
      }

      initScrollAnimations();

      const hamburger = document.getElementById('hamburger-menu');
      const mobileMenu = document.getElementById('mobile-menu');
      if (hamburger && mobileMenu) {
        hamburger.addEventListener('click', () => {
          mobileMenu.classList.toggle('hidden');
        });
      }

      const servicesToggle = document.getElementById('services-toggle');
      const servicesMenu = document.getElementById('services-menu');
      if (servicesToggle && servicesMenu) {
        servicesToggle.addEventListener('click', () => {
          servicesMenu.classList.toggle('hidden');
        });
      }

      function initScrollAnimations() {
        const elements = document.querySelectorAll('.animate-on-scroll');
        const observer = new IntersectionObserver((entries, observer) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('active');
              observer.unobserve(entry.target);
            }
          });
        }, { threshold: 0.1 });
        elements.forEach(element => observer.observe(element));
      }
    });

    function changeLanguage() {
      const lang = document.getElementById('language-selector').value;
      console.log(`Mudando idioma para: ${lang}`);
    }

    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'pt-BR';
      window.speechSynthesis.speak(utterance);
    }

    function fft(signal) {
      const n = signal.length;
      if (n <= 1) return signal;
      const even = [], odd = [];
      for (let i = 0; i < n; i++) {
        if (i % 2 === 0) even.push(signal[i]);
        else odd.push(signal[i]);
      }
      const evenFFT = fft(even), oddFFT = fft(odd);
      const result = new Array(n).fill(0);
      for (let i = 0; i < n / 2; i++) {
        const theta = -2 * Math.PI * i / n;
        const t = { re: Math.cos(theta) * oddFFT[i], im: Math.sin(theta) * oddFFT[i] };
        result[i] = evenFFT[i] + t.re;
        result[i + n / 2] = evenFFT[i] - t.re;
      }
      return result;
    }

    function getDominantFrequency(signal, sampleRate) {
      const n = signal.length;
      const fftResult = fft(signal);
      const magnitudes = fftResult.slice(0, n / 2).map((val, i) => Math.sqrt(val * val));
      let maxMag = 0, maxIndex = 0;
      for (let i = 1; i < magnitudes.length; i++) {
        if (magnitudes[i] > maxMag) { maxMag = magnitudes[i]; maxIndex = i; }
      }
      return maxIndex * sampleRate / n;
    }

    async function startAnalysisWithDelay() {
      const result = document.getElementById('scanner-result');
      result.style.display = 'block';
      result.innerHTML = '<p class="fade-in">üìñ Voc√™ pode ler o conte√∫do da p√°gina. A an√°lise come√ßar√° em 10 segundos, ou clique no bot√£o para come√ßar agora.</p><div class="mt-4"><button onclick="showInstruction()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine">Iniciar Agora</button></div>';
      speak('Voc√™ pode ler o conte√∫do da p√°gina. A an√°lise come√ßar√° em 10 segundos, ou clique no bot√£o para come√ßar agora.');

      await new Promise(resolve => setTimeout(resolve, 10000));
      if (result.innerHTML.includes('Iniciar Agora')) {
        showInstruction();
      }
    }

    async function showInstruction() {
      const result = document.getElementById('scanner-result');
      const micPrompt = document.getElementById('mic-prompt');
      micPrompt.style.display = 'flex';
      result.style.display = 'block';
      result.innerHTML = '<p class="fade-in">üìù A an√°lise come√ßar√° em 5 segundos, ou clique no bot√£o para continuar.</p><div class="mt-4"><button onclick="captureAndAnalyze()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine">Continuar</button></div>';
      speak('A an√°lise come√ßar√° em 5 segundos, ou clique no bot√£o para continuar.');

      await new Promise(resolve => setTimeout(resolve, 5000));
      if (result.innerHTML.includes('Continuar')) {
        captureAndAnalyze();
      }
    }

    async function captureAndAnalyze() {
      console.log('Iniciando an√°lise facial e biom√©trica...');
      const canvas = document.getElementById('canvas');
      const video = document.getElementById('video');
      const placeholder = document.getElementById('video-placeholder');
      const result = document.getElementById('scanner-result');
      const ppgOverlay = document.getElementById('ppg-overlay');
      const ppgProgressBar = document.getElementById('ppg-progress-bar');
      const micPrompt = document.getElementById('mic-prompt');
      const faceGuide = document.getElementById('face-guide');
      let videoStream = null;

      if (!canvas || !video || !result || !placeholder || !ppgOverlay || !ppgProgressBar || !micPrompt || !faceGuide) {
        console.error('Elementos necess√°rios n√£o encontrados:', { canvas, video, result, placeholder, ppgOverlay, ppgProgressBar, micPrompt, faceGuide });
        result.style.display = 'block';
        result.innerHTML = '<p class="fade-in">üö´ Erro interno: elementos da p√°gina n√£o encontrados. Recarregue a p√°gina e tente novamente.</p>';
        speak('Erro interno: elementos da p√°gina n√£o encontrados. Recarregue a p√°gina e tente novamente.');
        return;
      }

      try {
        videoStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        video.srcObject = videoStream;
        video.classList.remove('hidden');
        placeholder.classList.add('hidden');
        console.log('C√¢mera inicializada com sucesso');
      } catch (error) {
        console.error('Erro ao acessar a c√¢mera:', error);
        video.classList.add('hidden');
        placeholder.classList.remove('hidden');
        result.style.display = 'block';
        let errorMessage = '<p class="fade-in">üö´ Erro: n√£o foi poss√≠vel acessar a c√¢mera. Permita o acesso e tente novamente.</p>';
        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
          errorMessage = '<p class="fade-in">üö´ Por favor, permita o acesso √† c√¢mera para continuar.</p>';
        } else if (error.name === 'NotFoundError') {
          errorMessage = '<p class="fade-in">üö´ Nenhuma c√¢mera detectada. Conecte uma c√¢mera e tente novamente.</p>';
        }
        result.innerHTML = `${errorMessage}<div class="mt-6"><button onclick="startAnalysisWithDelay()" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Tentar Novamente</button></div>`;
        speak(errorMessage.replace('üö´ ', ''));
        return;
      }

      window.speechSynthesis.cancel();
      result.style.display = 'block';
      result.innerHTML = '<p class="fade-in">‚è≥ Preparando an√°lise<span class="loading-dots"></span></p>';

      const context = canvas.getContext('2d');
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
      let brightnessSum = 0;
      for (let i = 0; i < imageData.data.length; i += 4) {
        const r = imageData.data[i];
        const g = imageData.data[i + 1];
        const b = imageData.data[i + 2];
        brightnessSum += (0.299 * r + 0.587 * g + 0.114 * b);
      }
      const averageBrightness = brightnessSum / (imageData.data.length / 4);
      if (averageBrightness < 50) {
        result.innerHTML = '<p class="fade-in">üåô A ilumina√ß√£o est√° muito baixa. Ajuste a luz para continuar.</p><div class="mt-6"><button onclick="startAnalysisWithDelay()" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Tentar Novamente</button></div>';
        speak('A ilumina√ß√£o est√° muito baixa. Ajuste a luz e tente novamente.');
        if (videoStream) {
          videoStream.getVideoTracks().forEach(track => track.stop());
          video.classList.add('hidden');
          placeholder.classList.remove('hidden');
        }
        return;
      }

      let faceRect = null;
      const tracker = new tracking.ObjectTracker('face');
      tracker.setInitialScale(4);
      tracker.setStepSize(2);
      tracker.setEdgesDensity(0.1);
      tracking.track('#video', tracker);
      faceGuide.classList.remove('hidden');

      tracker.on('track', event => {
        if (event.data.length > 0) {
          faceRect = event.data[0];
          const guide = document.getElementById('face-guide');
          if (faceRect) {
            const centerX = faceRect.x + faceRect.width / 2;
            const centerY = faceRect.y + faceRect.height / 2;
            const offsetX = (canvas.width / 2 - centerX) / canvas.width * 100;
            const offsetY = (canvas.height / 2 - centerY) / canvas.height * 100;
            guide.style.transform = `translate(${offsetX}%, ${offsetY}%)`;
            if (Math.abs(offsetX) > 20 || Math.abs(offsetY) > 20) {
              result.innerHTML = '<p class="fade-in">ü§î Ajuste seu rosto para o centro do quadro e tente novamente.</p><div class="mt-6"><button onclick="startAnalysisWithDelay()" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Tentar Novamente</button></div>';
              speak('Ajuste seu rosto para o centro do quadro e tente novamente.');
              tracker.stop();
              faceGuide.classList.add('hidden');
              if (videoStream) {
                videoStream.getVideoTracks().forEach(track => track.stop());
                video.classList.add('hidden');
                placeholder.classList.remove('hidden');
              }
              return;
            }
          }
        }
      });

      let faceDetected = false;
      for (let i = 0; i < 50; i++) {
        if (faceRect) {
          faceDetected = true;
          break;
        }
        await new Promise(resolve => setTimeout(resolve, 100));
      }

      if (!faceDetected) {
        result.innerHTML = '<p class="fade-in">ü§î N√£o conseguimos detectar seu rosto. Centralize-se na c√¢mera e tente novamente.</p><div class="mt-6"><button onclick="startAnalysisWithDelay()" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Tentar Novamente</button></div>';
        speak('N√£o conseguimos detectar seu rosto. Centralize-se na c√¢mera e tente novamente.');
        tracker.stop();
        faceGuide.classList.add('hidden');
        if (videoStream) {
          videoStream.getVideoTracks().forEach(track => track.stop());
          video.classList.add('hidden');
          placeholder.classList.remove('hidden');
        }
        return;
      }

      const PPG_DURATION = 15;
      const FRAME_RATE = 30;
      const TOTAL_FRAMES = PPG_DURATION * FRAME_RATE;
      const greenValues = [];
      let startTime = Date.now();
      result.innerHTML = '<p class="fade-in">‚ù§Ô∏è Fique parado por 15 segundos para medir sua frequ√™ncia card√≠aca.</p>';
      ppgOverlay.classList.add('active');

      while ((Date.now() - startTime) / 1000 < PPG_DURATION) {
        const elapsed = (Date.now() - startTime) / 1000;
        const progress = (elapsed / PPG_DURATION) * 100;
        ppgProgressBar.style.width = `${progress}%`;

        if (!faceRect || Math.abs((canvas.width / 2 - (faceRect.x + faceRect.width / 2)) / canvas.width * 100) > 20 || Math.abs((canvas.height / 2 - (faceRect.y + faceRect.height / 2)) / canvas.height * 100) > 20) {
          result.innerHTML = '<p class="fade-in">üõë Movimenta√ß√£o detectada ou rosto fora do centro. Fique parado e centralize-se.</p><div class="mt-6"><button onclick="startAnalysisWithDelay()" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Tentar Novamente</button></div>';
          speak('Movimenta√ß√£o detectada ou rosto fora do centro. Fique parado e centralize-se.');
          ppgOverlay.classList.remove('active');
          tracker.stop();
          faceGuide.classList.add('hidden');
          if (videoStream) {
            videoStream.getVideoTracks().forEach(track => track.stop());
            video.classList.add('hidden');
            placeholder.classList.remove('hidden');
          }
          return;
        }

        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const foreheadX = faceRect.x + faceRect.width * 0.3;
        const foreheadY = faceRect.y + faceRect.height * 0.2;
        const foreheadWidth = faceRect.width * 0.4;
        const foreheadHeight = faceRect.height * 0.2;
        const foreheadData = context.getImageData(foreheadX, foreheadY, foreheadWidth, foreheadHeight);
        let greenSum = 0;
        let pixelCount = 0;
        for (let i = 0; i < foreheadData.data.length; i += 4) {
          greenSum += foreheadData.data[i + 1];
          pixelCount++;
        }
        const averageGreen = greenSum / pixelCount;
        greenValues.push(averageGreen);
        await new Promise(resolve => setTimeout(resolve, 1000 / FRAME_RATE));
      }

      ppgOverlay.classList.remove('active');
      tracker.stop();
      faceGuide.classList.add('hidden');

      let heartRate = 0;
      let isSimulated = false;
      try {
        const mean = greenValues.reduce((a, b) => a + b, 0) / greenValues.length;
        const detrended = greenValues.map(val => val - mean);
        const maxVal = Math.max(...detrended.map(Math.abs));
        const normalized = detrended.map(val => val / maxVal);
        const freq = getDominantFrequency(normalized, FRAME_RATE);
        heartRate = Math.round(freq * 60);
        if (heartRate < 40 || heartRate > 180) {
          throw new Error('Heart rate out of realistic range');
        }
      } catch (error) {
        console.error('PPG analysis failed:', error);
        heartRate = Math.floor(60 + (Math.random() * 40));
        isSimulated = true;
      }

      result.innerHTML = '<p class="fade-in">‚è≥ Analisando express√£o facial<span class="loading-dots"></span></p>';
      const captures = [];
      try {
        for (let i = 0; i < 2; i++) {
          context.drawImage(video, 0, 0, canvas.width, canvas.height);
          const imageBase64 = canvas.toDataURL('image/jpeg').split(',')[1];
          captures.push(imageBase64);
          await new Promise(resolve => setTimeout(resolve, 100));
        }
      } catch (error) {
        console.error('Erro durante a an√°lise:', error);
        result.innerHTML = '<p class="fade-in">üö´ Erro durante a an√°lise. Tente novamente.</p><div class="mt-6"><button onclick="startAnalysisWithDelay()" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Tentar Novamente</button></div>';
        if (videoStream) {
          videoStream.getVideoTracks().forEach(track => track.stop());
          video.classList.add('hidden');
          placeholder.classList.remove('hidden');
        }
        return;
      } finally {
        if (videoStream) {
          videoStream.getVideoTracks().forEach(track => track.stop());
          video.classList.add('hidden');
          placeholder.classList.remove('hidden');
          console.log('C√¢mera fechada ap√≥s an√°lise');
        }
        videoStream = null;
      }

      let bestResult = null;
      let maxConfidence = 0;

      for (let i = 0; i < captures.length; i++) {
        const formData = new FormData();
        formData.append('api_key', apiKey);
        formData.append('api_secret', apiSecret);
        formData.append('image_base64', captures[i]);
        formData.append('return_attributes', 'emotion,age');

        try {
          const response = await fetch('https://api-us.faceplusplus.com/facepp/v3/detect', {
            method: 'POST',
            body: formData
          });
          const data = await response.json();
          console.log('Resposta da API Face++:', data);

          if (data.faces && data.faces.length > 0) {
            const face = data.faces[0];
            const emotion = face.attributes.emotion;
            const emotionsSorted = Object.entries(emotion).sort((a, b) => b[1] - a[1]);
            const confidence = emotionsSorted[0][1];
            if (confidence > maxConfidence) {
              maxConfidence = confidence;
              bestResult = { emotion, age: face.attributes.age.value, heartRate, isSimulated };
            }
          }
        } catch (error) {
          console.error('Erro ao analisar captura:', error);
          result.innerHTML = '<p class="fade-in">üö´ Erro ao conectar com a API de an√°lise facial. Verifique sua conex√£o e tente novamente.</p><div class="mt-6"><button onclick="startAnalysisWithDelay()" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Tentar Novamente</button></div>';
          speak('Erro ao conectar com a API de an√°lise facial. Verifique sua conex√£o e tente novamente.');
          return;
        }
      }

      if (bestResult && maxConfidence >= 50) {
        const { emotion, age, heartRate, isSimulated } = bestResult;
        const emotionsSorted = Object.entries(emotion).sort((a, b) => b[1] - a[1]);
        const primaryEmotion = emotionsSorted[0][0];
        lastDetectedEmotion = primaryEmotion;

        const diag = generateDiagnosis(primaryEmotion, heartRate, age, isSimulated);

        const diagnosisHTML = `
          <h3 class="text-2xl font-bold mb-4 fade-in">Resultado do Diagn√≥stico</h3>
          <p class="fade-in"><strong>Emo√ß√£o Predominante:</strong> ${diag.primaryEmotionInPortuguese.charAt(0).toUpperCase() + diag.primaryEmotionInPortuguese.slice(1)}</p>
          <p class="fade-in"><strong>Idade Aparente:</strong> Entre ${diag.ageRangeMin} e ${diag.ageRangeMax} anos</p>
          <p class="fade-in mt-2">${diag.diagnosis}</p>
          <p class="fade-in mt-2"><strong>Poss√≠veis Gatilhos:</strong> ${diag.triggers}</p>
          <p class="fade-in mt-2"><strong>Sugest√£o:</strong> ${diag.suggestion}</p>
          <p class="fade-in mt-2"><strong>Plano Personalizado:</strong> ${diag.personalizedPlan}</p>
          ${diag.ctaButtons}
        `;

        result.innerHTML = diagnosisHTML;
        speak(`Seu diagn√≥stico est√° pronto. Emo√ß√£o predominante: ${diag.primaryEmotionInPortuguese.charAt(0).toUpperCase() + diag.primaryEmotionInPortuguese.slice(1)}. ${diag.diagnosis}`);
      } else {
        result.innerHTML = '<p class="fade-in">üö´ N√£o foi poss√≠vel determinar uma emo√ß√£o com confian√ßa suficiente. Tente novamente.</p><div class="mt-6"><button onclick="startAnalysisWithDelay()" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Tentar Novamente</button></div>';
        speak('N√£o foi poss√≠vel determinar uma emo√ß√£o com confian√ßa suficiente. Tente novamente.');
      }
    }

    async function initMedicalConsult() {
      const result = document.getElementById('scanner-result');
      if (result) {
        result.style.display = 'block';
        result.innerHTML = '<p class="fade-in">üìû Conectando a um consultor m√©dico<span class="loading-dots"></span></p>';
        speak('Conectando a um consultor m√©dico.');
        setTimeout(() => {
          window.location.href = '/medical-ai.html';
        }, 3000);
      }
    }

    function toggleVR() {
      const vrContainer = document.getElementById('vr-container');
      if (vrContainer) {
        let vrContent = '';
        let vrMessage = 'Bem-vindo ao Relaxamento VR/AR!';
        let vrIframeSrc = 'https://example.com/vr-nature-walk';

        switch (lastDetectedEmotion) {
          case 'sadness':
            vrMessage = 'Relaxe em uma praia calma para aliviar a tristeza.';
            vrIframeSrc = 'https://example.com/vr-beach';
            break;
          case 'anger':
            vrMessage = 'Explore uma floresta serena para acalmar a raiva.';
            vrIframeSrc = 'https://example.com/vr-forest';
            break;
          case 'happiness':
            vrMessage = 'Aproveite um parque vibrante para manter sua alegria!';
            vrIframeSrc = 'https://example.com/vr-park';
            break;
          case 'fear':
            vrMessage = 'Mergulhe em um ambiente seguro para reduzir o medo.';
            vrIframeSrc = 'https://example.com/vr-safe-space';
            break;
          case 'surprise':
            vrMessage = 'Descubra um cen√°rio novo e inspirador!';
            vrIframeSrc = 'https://example.com/vr-new-landscape';
            break;
          case 'disgust':
            vrMessage = 'Renove-se em um ambiente puro e tranquilo.';
            vrIframeSrc = 'https://example.com/vr-pure-landscape';
            break;
          case 'neutral':
            vrMessage = 'Mantenha o equil√≠brio com uma caminhada virtual na natureza.';
            vrIframeSrc = 'https://example.com/vr-nature-walk';
            break;
          default:
            vrMessage = 'Explore uma caminhada virtual na natureza.';
            vrIframeSrc = 'https://example.com/vr-nature-walk';
        }

        vrContent = `
          <p class="text-lg text-gray-300 fade-in">${vrMessage}</p>
          <iframe src="${vrIframeSrc}" width="400" height="300" frameborder="0" allowfullscreen></iframe>
        `;

        vrContainer.innerHTML = vrContent;
        vrContainer.style.display = vrContainer.style.display === 'block' ? 'none' : 'block';
        speak(vrContainer.style.display === 'block' ? vrMessage : 'Relaxamento VR/AR desativado.');
      }
    }
  </script>
</body>
</html>
