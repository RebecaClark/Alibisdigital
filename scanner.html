<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Teste o Scanner Emocional da √Ålibis Digital para um diagn√≥stico emocional detalhado e descubra planos para bem-estar.">
  <meta name="keywords" content="scanner emocional, criar √°libi, apoio emocional, medical IA, bem-estar, estresse">
  <meta name="author" content="√Ålibis Digital">
  <title>Scanner Emocional - √Ålibis Digital</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tracking.js/1.1.3/tracking-min.js" defer></script>
  <style>
    html { scroll-behavior: smooth; }
    body { 
      position: relative; 
      overflow-x: hidden; 
      min-height: 100vh; 
      color: #e5e7eb; 
      text-shadow: 0 0.5px rgba(0, 0, 0, 0.5); 
      font-family: Arial, sans-serif;
    }
    #particles-js { 
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: -1;
      background: #0b1120;
    }
    #particles-fallback {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: -1;
      background: #0b1120;
      display: none;
      color: #e5e7eb;
      text-align: center;
      padding-top: 20%;
      font-size: 1.2rem;
    }
    .fade-in { animation: fadeIn 1s ease-in-out; }
    .slide-in-left { animation: slideInLeft 1.2s ease-in-out; }
    .slide-in-right { animation: slideInRight 1.2s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideInLeft { from { opacity: 0; transform: translateX(-60px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes slideInRight { from { opacity: 0; transform: translateX(60px); } to { opacity: 1; transform: translateX(0); } }
    .shine { position: relative; overflow: hidden; }
    .shine::after { 
      content: ''; 
      position: absolute; 
      top: -60%; 
      left: -60%; 
      width: 220%; 
      height: 220%; 
      background: linear-gradient(45deg, rgba(255,255,255,0), rgba(255,255,255,0.2), rgba(255,255,255,0)); 
      transform: rotate(20deg); 
      animation: shine 4s infinite linear; 
    }
    @keyframes shine { 
      0% { transform: translateX(-120%) rotate(20deg); } 
      100% { transform: translateX(120%) rotate(20deg); } 
    }
    .futuristic-btn { 
      background: linear-gradient(45deg, #7C3AED, #22d3ee); 
      box-shadow: 0 0 15px #22d3ee; 
      transition: transform 0.3s ease, box-shadow 0.3s ease; 
      animation: neonPulse 1.5s infinite alternate; 
    }
    .futuristic-btn:hover { 
      transform: translateY(-5px); 
      box-shadow: 0 0 25px #22d3ee, 0 0 35px #22d3ee; 
    }
    @keyframes neonPulse { 
      0% { box-shadow: 0 0 5px #22d3ee, 0 0 10px #22d3ee; } 
      100% { box-shadow: 0 0 15px #22d3ee, 0 0 25px #22d3ee; } 
    }
    .holo-nav {
      background: rgba(17, 24, 39, 0.8);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      animation: holoGlow 2s infinite alternate;
    }
    @keyframes holoGlow {
      0% { box-shadow: 0 0 10px #22d3ee, 0 0 20px #22d3ee; }
      100% { box-shadow: 0 0 20px #22d3ee, 0 0 30px #22d3ee; }
    }
    .holo-nav a, .holo-nav button { transition: color 0.3s ease; }
    .holo-nav a:hover, .holo-nav button:hover { 
      color: #22d3ee; 
      text-shadow: 0 0 5px #22d3ee; 
    }
    .dropdown-menu {
      background: rgba(31, 41, 55, 0.9);
      border: 1px solid #22d3ee;
      box-shadow: 0 0 10px #22d3ee;
      border-radius: 8px;
      padding: 8px 0;
      position: absolute;
      top: 100%;
      left: 0;
      display: none;
      width: 200px;
    }
    .dropdown-menu a {
      display: block;
      padding: 8px 16px;
      color: #e5e7eb;
      transition: all 0.3s ease;
    }
    .dropdown-menu a:hover {
      background: rgba(55, 65, 81, 0.8);
      color: #22d3ee;
    }
    .dropdown:hover .dropdown-menu { display: block; }
    .dropdown-menu-mobile {
      background: rgba(31, 41, 55, 0.9);
      border: 1px solid #22d3ee;
      box-shadow: 0 0 10px #22d3ee;
      border-radius: 8px;
      padding: 8px 0;
      width: 100%;
      position: static;
    }
    .dropdown-menu-mobile a {
      display: block;
      padding: 8px 16px;
      color: #e5e7eb;
      transition: all 0.3s ease;
    }
    .dropdown-menu-mobile a:hover {
      background: rgba(55, 65, 81, 0.8);
      color: #22d3ee;
    }
    .animate-on-scroll {
      opacity: 0;
      transform: translateY(50px);
      transition: opacity 0.9s ease-out, transform 0.9s ease-out;
    }
    .animate-on-scroll.visible {
      opacity: 1;
      transform: translateY(0);
    }
    .neon-box {
      background: linear-gradient(45deg, #1e1b4b, #22d3ee);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 0 10px #22d3ee;
      animation: fadeIn 1s ease-in-out;
      max-width: 600px;
      margin: 0 auto;
      text-align: left;
    }
    .loading-dots::after {
      content: '';
      display: inline-block;
      width: 1em;
      height: 1em;
      animation: dots 1.5s steps(3, end) infinite;
    }
    @keyframes dots {
      0% { content: '.'; }
      33% { content: '..'; }
      66% { content: '...'; }
      100% { content: '.'; }
    }
    video {
      width: 400px;
      height: 300px;
      max-width: 100%;
      margin-left: auto;
      margin-right: auto;
      border-radius: 0.75rem;
      box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.2);
      border: 1px solid #22d3ee;
    }
    .video-placeholder {
      width: 400px;
      height: 300px;
      max-width: 100%;
      background: #1f2937;
      border-radius: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #e5e7eb;
      border: 1px solid #22d3ee;
    }
    .ppg-overlay {
      position: absolute;
      width: 400px;
      height: 300px;
      max-width: 100%;
      border-radius: 0.75rem;
      border: 2px dashed #22d3ee;
      pointer-events: none;
      display: none;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
      padding-bottom: 10px;
    }
    .ppg-overlay.active {
      display: flex;
    }
    .ppg-progress-container {
      width: 80%;
      height: 20px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      overflow: hidden;
      margin-top: 10px;
    }
    .ppg-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #22d3ee, #7C3AED);
      width: 0%;
      transition: width 0.1s linear;
      box-shadow: 0 0 10px #22d3ee;
    }
    .ppg-stay-still {
      color: #22d3ee;
      font-size: 1rem;
      text-shadow: 0 0 5px #22d3ee;
      animation: pulseText 1.5s infinite;
      margin-bottom: 10px;
    }
    @keyframes pulseText {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    .mic-icon {
      display: inline-block;
      width: 24px;
      height: 24px;
      background: url('https://via.placeholder.com/24?text=üéôÔ∏è') no-repeat center;
      animation: pulseMic 1.5s infinite;
      margin-right: 8px;
    }
    @keyframes pulseMic {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.7; }
      100% { transform: scale(1); opacity: 1; }
    }
    .mic-prompt {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 10px;
      color: #22d3ee;
      font-size: 1.1rem;
      text-shadow: 0 0 5px #22d3ee;
    }
    .testimonial-card {
      background: rgba(31, 41, 55, 0.9);
      border: 1px solid #22d3ee;
      border-radius: 10px;
      padding: 20px;
      margin: 10px;
      box-shadow: 0 0 10px #22d3ee;
    }
    .testimonial-img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 2px solid #22d3ee;
      margin-right: 15px;
    }
    #chat-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }
    #chat-bubble {
      background: linear-gradient(45deg, #7C3AED, #22d3ee);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 0 15px #22d3ee;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    #chat-window {
      display: none;
      background: rgba(17, 24, 39, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid #22d3ee;
      border-radius: 15px;
      width: 300px;
      height: 400px;
      position: absolute;
      bottom: 80px;
      right: 0;
      box-shadow: 0 0 20px #22d3ee;
    }
    #chat-messages {
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      color: #e5e7eb;
    }
    #chat-input {
      background: rgba(55, 65, 81, 0.8);
      border: 1px solid #22d3ee;
      border-radius: 20px;
      padding: 10px;
      width: 100%;
      color: white;
    }
    .listening-indicator {
      display: none;
      color: #22d3ee;
      font-size: 0.9rem;
      text-align: center;
      margin-top: 5px;
    }
    .listening-indicator.active { display: block; }
    @media (max-width: 768px) {
      h1 { font-size: 2rem; }
      h2 { font-size: 1.5rem; }
      p { font-size: 0.9rem; }
      .max-w-4xl { max-width: 100%; padding: 0 1rem; }
      .max-w-6xl { max-width: 100%; padding: 0 1rem; }
      .grid { grid-template-columns: 1fr; }
      .flex { flex-direction: column; }
      .futuristic-btn { width: 100%; margin-bottom: 0.5rem; padding: 0.5rem 1rem; font-size: 0.9rem; }
      video, .video-placeholder { width: 360px; height: 270px; max-width: 90vw; }
      .ppg-overlay { width: 360px; height: 270px; max-width: 90vw; }
      .scanner-container { padding: 1rem; max-height: 80vh; }
      section#scanner, section#emotion-intro { padding-top: 1.5rem; padding-bottom: 1.5rem; }
      #chat-window { width: 90%; right: 5%; height: 350px; }
      #chat-messages { height: 250px; }
      .testimonial-card { padding: 15px; margin: 5px; }
      .testimonial-img { width: 50px; height: 50px; }
    }
    @media (max-width: 480px) {
      h1 { font-size: 1.8rem; }
      h2 { font-size: 1.3rem; }
      p { font-size: 0.85rem; }
      video, .video-placeholder { width: 320px; height: 240px; }
      .ppg-overlay { width: 320px; height: 240px; }
      .futuristic-btn { font-size: 0.8rem; }
      .neon-box { padding: 15px; }
    }
  </style>
</head>
<body class="bg-transparent text-white font-sans">
  <div id="particles-js"></div>
  <div id="particles-fallback">Particle effect failed to load. Please check your internet connection.</div>

  <header class="holo-nav fixed top-0 left-0 w-full z-50 transition-shadow duration-300">
    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
      <div class="flex items-center">
        <a href="/index.html" aria-label="P√°gina inicial da √Ålibis Digital">
          <img src="/assets/logo.png" alt="Logo da √Ålibis Digital" class="h-10 w-auto" onerror="this.src='https://via.placeholder.com/100x40?text=Logo'; console.error('Erro ao carregar logo.png')">
        </a>
      </div>
      <div class="flex items-center">
        <div class="md:hidden">
          <button id="hamburger-menu" class="text-white focus:outline-none p-2 rounded" aria-label="Abrir menu de navega√ß√£o">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </div>
        <div class="relative">
          <select id="language-selector" class="bg-transparent text-white border border-[#22d3ee] rounded-full px-3 py-1 focus:outline-none appearance-none" onchange="changeLanguage()">
            <option value="pt-BR">Portugu√™s</option>
            <option value="en-US">English</option>
            <option value="es-ES">Espa√±ol</option>
          </select>
          <svg class="w-4 h-4 absolute right-2 top-1/2 transform -translate-y-1/2 text-white pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </div>
      </div>
      <nav id="navbar" class="hidden md:flex space-x-6 text-sm items-center">
        <div class="dropdown relative">
          <button class="hover:text-[#22d3ee] transition flex items-center" aria-label="Abrir menu de servi√ßos">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path>
            </svg>
            <span>Servi√ßos</span>
            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div class="dropdown-menu">
            <a href="/scanner.html" class="hover:text-[#22d3ee] transition">Scanner com IA</a>
            <a href="/apoio-emocional.html" class="hover:text-[#22d3ee] transition">Avalia√ß√£o Emocional</a>
            <a href="/medical-ai.html" class="hover:text-[#22d3ee] transition">Diagn√≥stico M√©dico</a>
            <a href="/alibi.html" class="hover:text-[#22d3ee] transition">Criar √Ålibi</a>
          </div>
        </div>
        <a href="/blog.html" class="hover:text-[#22d3ee] transition">Blog</a>
        <a href="/planos.html" class="hover:text-[#22d3ee] transition">Planos</a>
        <a href="/suporte.html" class="hover:text-[#22d3ee] transition">Suporte</a>
        <a href="/planos.html" class="futuristic-btn text-white py-2 px-4 rounded-full text-sm font-semibold" aria-label="Teste Gr√°tis">üîç Teste Gr√°tis</a>
      </nav>
    </div>
    <div id="mobile-menu" class="md:hidden bg-gray-800 bg-opacity-95 w-full hidden py-4">
      <nav class="flex flex-col items-center space-y-4">
        <div class="w-full">
          <button id="services-toggle" class="text-white py-2 px-4 text-lg w-full text-center hover:bg-gray-700 rounded flex justify-between items-center">
            <span>Servi√ßos</span>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div id="services-menu" class="dropdown-menu-mobile hidden">
            <a href="/scanner.html" class="hover:bg-gray-700">Scanner com IA</a>
            <a href="/apoio-emocional.html" class="hover:bg-gray-700">Avalia√ß√£o Emocional</a>
            <a href="/medical-ai.html" class="hover:bg-gray-700">Diagn√≥stico M√©dico</a>
            <a href="/alibi.html" class="hover:bg-gray-700">Criar √Ålibi</a>
          </div>
        </div>
        <a href="/blog.html" class="text-white py-2 px-4 text-lg w-full text-center hover:bg-gray-700 rounded">Blog</a>
        <a href="/planos.html" class="text-white py-2 px-4 text-lg w-full text-center hover:bg-gray-700 rounded">Planos</a>
        <a href="/suporte.html" class="text-white py-2 px-4 text-lg w-full text-center hover:bg-gray-700 rounded">Suporte</a>
        <a href="/planos.html" class="futuristic-btn text-white py-2 px-4 rounded-full text-lg w-full text-center" aria-label="Teste Gr√°tis">üîç Teste Gr√°tis</a>
      </nav>
    </div>
  </header>
  <div class="h-20"></div>

  <section id="hero" class="text-white text-center py-20 px-6 relative animate-on-scroll">
    <div class="max-w-6xl mx-auto">
      <h1 class="text-5xl md:text-6xl font-serif font-bold mb-6 leading-tight fade-in">Transforme Sua Vida com o Scanner Emocional</h1>
      <p class="text-lg md:text-xl text-gray-300 mb-10 fade-in">Descubra seu estado emocional com IA avan√ßada. Teste gr√°tis agora!</p>
      <div>
        <a href="/relatorios-avancados.html" class="futuristic-btn text-white font-bold py-3 px-8 rounded-full" aria-label="Obter Relat√≥rios Avan√ßados">üîç Obter Relat√≥rios Avan√ßados</a>
      </div>
    </div>
  </section>

  <section class="py-10 px-6 text-center animate-on-scroll" id="emotion-intro">
    <div class="max-w-4xl mx-auto">
      <h2 class="text-3xl font-bold mb-6 text-white shine">Entenda Suas Emo√ß√µes</h2>
      <p class="text-lg mb-6 text-gray-300 fade-in">Nosso scanner analisa express√µes faciais, frequ√™ncia card√≠aca e tom de voz para identificar seu estado emocional com precis√£o.</p>
      <button onclick="document.getElementById('scanner').scrollIntoView({behavior: 'smooth'})" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine" aria-label="Come√ßar o Scanner">Come√ßar o Scanner</button>
    </div>
  </section>

  <section class="py-10 px-6 text-center animate-on-scroll scanner-container" id="scanner">
    <h2 class="text-4xl font-bold mb-6 text-white shine">Seu rosto carrega sinais. Vamos descobrir o que ele diz?</h2>
    <p class="text-lg mb-8 text-gray-300 fade-in">Ative sua c√¢mera e microfone para um diagn√≥stico emocional detalhado com idade aparente.</p>
    <div class="flex flex-col items-center mb-4 relative">
      <video id="video" width="400" height="300" autoplay class="rounded-xl shadow-md border border-[#22d3ee]" aria-label="V√≠deo da c√¢mera para an√°lise emocional"></video>
      <div id="ppg-overlay" class="ppg-overlay">
        <span class="ppg-stay-still">Fique parado</span>
        <div class="ppg-progress-container">
          <div id="ppg-progress-bar" class="ppg-progress-bar"></div>
        </div>
      </div>
      <div id="video-placeholder" class="video-placeholder">C√¢mera n√£o dispon√≠vel</div>
      <div id="mic-prompt" class="mic-prompt" style="display: none;">
        <span class="mic-icon"></span>
        <span>Leia esta frase: "Estou me sentindo bem hoje"</span>
      </div>
      <div id="vr-toggle" class="mt-4">
        <button onclick="toggleVR()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine" aria-label="Ativar Experi√™ncia VR/AR">Ativar Relaxamento VR/AR</button>
      </div>
    </div>
    <div class="flex justify-center mb-4">
      <button onclick="captureAndAnalyze()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine" aria-label="Analisar Estado Emocional">Analisar Estado Emocional</button>
      <button onclick="initMedicalConsult()" class="futuristic-btn text-white font-bold py-2 px-6 rounded-full text-sm shine ml-4" aria-label="Consultar M√©dico">Consultar M√©dico</button>
    </div>
    <div id="scanner-result" class="neon-box mt-6" style="display: none;"></div>
    <div class="testimonials mt-8 max-w-4xl mx-auto">
      <h3 class="text-2xl font-bold mb-4 text-white shine">O que nossos usu√°rios dizem</h3>
      <div class="flex flex-wrap justify-center">
        <div class="testimonial-card flex items-center">
          <img src="https://via.placeholder.com/60" alt="Foto de Ana" class="testimonial-img">
          <div>
            <p class="text-gray-300">"O Scanner mudou minha vida! Descobri o que me estressava e agora vivo mais leve."</p>
            <p class="text-sm text-gray-400 mt-2">- Ana, 34 anos</p>
          </div>
        </div>
        <div class="testimonial-card flex items-center">
          <img src="https://via.placeholder.com/60" alt="Foto de Jo√£o" class="testimonial-img">
          <div>
            <p class="text-gray-300">"Incr√≠vel como a IA me ajudou a entender minhas emo√ß√µes. Recomendo!"</p>
            <p class="text-sm text-gray-400 mt-2">- Jo√£o, 29 anos</p>
          </div>
        </div>
      </div>
    </div>
    <div id="vr-container" style="display: none;">
      <p class="text-lg text-gray-300 fade-in">Bem-vindo ao Relaxamento VR/AR! Explore uma caminhada virtual na natureza.</p>
      <iframe src="https://example.com/vr-nature-walk" width="400" height="300" frameborder="0" allowfullscreen></iframe>
    </div>
    <canvas id="canvas" width="400" height="300" style="display: none;"></canvas>
  </section>

  <div id="chat-container">
    <div id="chat-bubble">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
      </svg>
    </div>
    <div id="chat-window">
      <div id="chat-messages"></div>
      <div class="p-4">
        <input id="chat-input" type="text" class="w-full" placeholder="Digite ou fale sua mensagem" aria-label="Digite ou fale sua mensagem">
        <div id="listening-indicator" class="listening-indicator">üéôÔ∏è Ouvindo...</div>
      </div>
    </div>
  </div>

  <footer class="bg-[rgba(11,17,32,0.8)] text-gray-400 py-12 animate-on-scroll">
    <div class="max-w-6xl mx-auto px-6 grid grid-cols-1 md:grid-cols-3 gap-10 text-sm">
      <div class="slide-in-left">
        <h3 class="text-white text-2xl font-bold mb-4 shine">√Ålibis Digital</h3>
        <p class="fade-in">Solu√ß√µes de bem-estar com tecnologia avan√ßada.</p>
      </div>
      <div class="fade-in">
        <h4 class="text-white font-semibold mb-4">Navegue</h4>
        <ul class="space-y-2">
          <li><a href="/index.html" class="hover:text-white transition">In√≠cio</a></li>
          <li><a href="/scanner.html" class="hover:text-white transition">Scanner</a></li>
          <li><a href="/blog.html" class="hover:text-white transition">Blog</a></li>
          <li><a href="/medical-ai.html" class="hover:text-white transition">Diagn√≥stico M√©dico</a></li>
          <li><a href="/apoio-emocional.html" class="hover:text-white transition">Avalia√ß√£o Emocional</a></li>
          <li><a href="/alibi.html" class="hover:text-white transition">Criar √Ålibi</a></li>
          <li><a href="/planos.html" class="hover:text-white transition">Planos</a></li>
          <li><a href="/suporte.html" class="hover:text-white transition">Suporte</a></li>
          <li><a href="/politica-privacidade.html" class="hover:text-white transition">Privacidade</a></li>
        </ul>
      </div>
      <div class="slide-in-right">
        <h4 class="text-white font-semibold mb-4">Contato</h4>
        <ul class="space-y-2">
          <li class="fade-in">E-mail: contato@alibisdigital.com</li>
          <li class="fade-in">WhatsApp: (11) 91234-5678</li>
        </ul>
      </div>
    </div>
    <div class="text-center mt-8">
      <p class="text-sm">¬© 2025 √Ålibis Digital. Todos os direitos reservados.</p>
    </div>
  </footer>

 <script>
  console.log('Loading scanner.html at', new Date().toISOString());

  function initializeParticles() {
    if (typeof particlesJS !== 'undefined') {
      particlesJS('particles-js', {
        particles: {
          number: { value: 100, density: { enable: true, value_area: 800 } },
          color: { value: '#22d3ee' },
          shape: { type: 'circle' },
          opacity: { value: 0.7, random: true },
          size: { value: 3, random: true },
          line_linked: {
            enable: true,
            distance: 120,
            color: '#22d3ee',
            opacity: 0.4,
            width: 1
          },
          move: { speed: 1, direction: 'none', random: true }
        },
        interactivity: {
          detect_on: 'canvas',
          events: {
            onhover: { enable: true, mode: 'repulse' },
            onclick: { enable: true, mode: 'push' }
          }
        },
        retina_detect: true
      });
      console.log('Particles.js loaded successfully with hexagonal effect');
    } else {
      console.error('particlesJS not loaded - showing fallback');
      document.getElementById('particles-fallback').style.display = 'block';
    }
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    initializeParticles();
  } else {
    window.addEventListener('DOMContentLoaded', initializeParticles);
  }

  if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
    particlesJS('particles-js', { particles: { number: { value: 0 } } });
    console.log('Reduced motion detected - particles disabled');
  }

  const apiKey = 'AmoIQKuEFggNsZmeO_Ur50ZZmfSrZ3mX';
  const apiSecret = 'WoRf3C8_IqQhe0Su8coFmOnAB_0nOheY';
  let diagnosisText = '';

  // New function to generate diagnosis
  function generateDiagnosis(primaryEmotion, heartRate, age, isSimulated) {
    const emotionPortuguese = {
      sadness: 'tristeza',
      anger: 'raiva',
      happiness: 'felicidade',
      surprise: 'surpresa',
      neutral: 'neutra',
      fear: 'medo',
      disgust: 'nojo'
    };

    const primaryEmotionInPortuguese = emotionPortuguese[primaryEmotion] || primaryEmotion;
    const ageRangeMin = Math.max(18, age - 5);
    const ageRangeMax = age + 5;
    let diagnosis = '';
    let triggers = '';
    let suggestion = '';
    let personalizedPlan = '';
    let ctaButtons = '';

    switch (primaryEmotion) {
      case 'happiness':
        diagnosis = `Voc√™ est√° radiante, com uma frequ√™ncia card√≠aca de ${heartRate} bpm e tom de voz animado, refletindo felicidade e leveza.`;
        triggers = 'Pode ser resultado de uma conquista recente, uma conex√£o social significativa ou um momento de satisfa√ß√£o pessoal.';
        suggestion = 'Aproveite essa energia positiva para se conectar com amigos ou explorar uma atividade criativa.';
        personalizedPlan = 'Plano: 10 minutos de medita√ß√£o di√°ria e caminhada ao ar livre.';
        break;
      case 'sadness':
        diagnosis = `Sua express√£o reflete tristeza, com frequ√™ncia card√≠aca de ${heartRate} bpm e tom de voz baixo, indicando introspec√ß√£o ou sobrecarga emocional.`;
        triggers = 'Isso pode estar ligado a saudades, estresse acumulado ou uma perda recente.';
        suggestion = 'Experimente medita√ß√£o guiada por 5 minutos ou escreva seus pensamentos.';
        personalizedPlan = 'Plano: 5 minutos de respira√ß√£o consciente e consulta com apoio emocional.';
        ctaButtons = '<div class="mt-6"><button onclick="window.location.href=\'/apoio-emocional.html\'" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Explorar Apoio Emocional</button></div>';
        break;
      case 'anger':
        diagnosis = `Sua express√£o mostra raiva, com frequ√™ncia card√≠aca de ${heartRate} bpm e tom de voz elevado, sugerindo tens√£o ou frustra√ß√£o.`;
        triggers = 'Pode ser devido a um conflito recente, press√£o no trabalho ou uma situa√ß√£o irritante.';
        suggestion = 'Tente uma caminhada r√°pida para liberar a tens√£o ou pratique exerc√≠cios de respira√ß√£o profunda.';
        personalizedPlan = 'Plano: 10 minutos de alongamento e pr√°tica de mindfulness para aliviar a tens√£o.';
        ctaButtons = '<div class="mt-6"><button onclick="window.location.href=\'/apoio-emocional.html\'" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Explorar Apoio Emocional</button></div>';
        break;
      case 'fear':
        diagnosis = `Sua express√£o indica medo, com frequ√™ncia card√≠aca de ${heartRate} bpm e tom de voz tr√™mulo, refletindo ansiedade ou incerteza.`;
        triggers = 'Pode estar relacionado a uma situa√ß√£o de incerteza, preocupa√ß√£o com o futuro ou um evento estressante.';
        suggestion = 'Pratique a t√©cnica de respira√ß√£o 4-7-8 para acalmar o sistema nervoso.';
        personalizedPlan = 'Plano: 5 minutos de respira√ß√£o 4-7-8 e uma sess√£o de relaxamento guiado.';
        ctaButtons = '<div class="mt-6"><button onclick="window.location.href=\'/apoio-emocional.html\'" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Explorar Apoio Emocional</button></div>';
        break;
      case 'surprise':
        diagnosis = `Voc√™ parece surpreso, com frequ√™ncia card√≠aca de ${heartRate} bpm e tom de voz agudo, indicando um momento inesperado.`;
        triggers = 'Pode ser resultado de uma novidade, uma not√≠cia inesperada ou uma mudan√ßa repentina.';
        suggestion = 'Aproveite a energia da surpresa para explorar algo novo ou refletir sobre o que causou essa rea√ß√£o.';
        personalizedPlan = 'Plano: 10 minutos de escrita reflexiva sobre o evento que causou surpresa.';
        break;
      case 'disgust':
        diagnosis = `Sua express√£o reflete nojo, com frequ√™ncia card√≠aca de ${heartRate} bpm e tom de voz de repulsa, indicando desagrado.`;
        triggers = 'Pode estar ligado a uma situa√ß√£o desconfort√°vel, algo que voc√™ considera inaceit√°vel ou um ambiente desagrad√°vel.';
        suggestion = 'Tente se afastar da fonte do desagrado e pratique uma atividade que traga conforto.';
        personalizedPlan = 'Plano: 10 minutos de relaxamento com m√∫sica calma e um ch√° quente.';
        ctaButtons = '<div class="mt-6"><button onclick="window.location.href=\'/apoio-emocional.html\'" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Explorar Apoio Emocional</button></div>';
        break;
      case 'neutral':
        diagnosis = `Sua express√£o √© neutra, com frequ√™ncia card√≠aca de ${heartRate} bpm e tom de voz est√°vel, sugerindo calma ou concentra√ß√£o.`;
        triggers = 'Pode indicar que voc√™ est√° em um estado de equil√≠brio ou focado em uma tarefa.';
        suggestion = 'Continue mantendo esse equil√≠brio com pr√°ticas de mindfulness ou pausas regulares.';
        personalizedPlan = 'Plano: 5 minutos de alongamento leve e hidrata√ß√£o regular.';
        break;
      default:
        diagnosis = `Emo√ß√£o predominante: ${primaryEmotionInPortuguese}, com frequ√™ncia card√≠aca de ${heartRate} bpm.`;
        triggers = 'Estamos analisando poss√≠veis gatilhos para essa emo√ß√£o.';
        suggestion = 'Tente refletir sobre o que pode estar influenciando esse estado.';
        personalizedPlan = 'Plano: 5 minutos de pausa para reflex√£o.';
    }

    if (isSimulated) {
      diagnosis += ' <span class="text-yellow-300"> (Frequ√™ncia card√≠aca estimada devido a falha na medi√ß√£o precisa)</span>';
    }

    return { diagnosis, triggers, suggestion, personalizedPlan, ctaButtons, ageRangeMin, ageRangeMax, primaryEmotionInPortuguese };
  }

  document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM carregado, inicializando scanner...');
    const video = document.getElementById('video');
    const placeholder = document.getElementById('video-placeholder');
    const result = document.getElementById('scanner-result');
    const vrContainer = document.getElementById('vr-container');
    
    if (result) {
      result.style.display = 'none';
      result.innerHTML = '';
      console.log('Resultado inicializado como oculto');
    }

    if (video && placeholder) {
      video.classList.add('hidden');
      placeholder.classList.remove('hidden');
      console.log('Camera and microphone will be initialized on user action');
    } else {
      console.error('Elementos de v√≠deo ou placeholder n√£o encontrados');
    }

    initScrollAnimations();

    const hamburger = document.getElementById('hamburger-menu');
    const mobileMenu = document.getElementById('mobile-menu');
    if (hamburger && mobileMenu) {
      hamburger.addEventListener('click', () => {
        mobileMenu.classList.toggle('hidden');
        console.log('Menu mobile toggled');
      });
    }

    const servicesToggle = document.getElementById('services-toggle');
    const servicesMenu = document.getElementById('services-menu');
    if (servicesToggle && servicesMenu) {
      servicesToggle.addEventListener('click', () => {
        servicesMenu.classList.toggle('hidden');
        console.log('Menu de servi√ßos mobile toggled');
      });
    }

    window.addEventListener('scroll', () => {
      const header = document.querySelector('header');
      if (header) {
        if (window.scrollY > 50) {
          header.classList.add('shadow-lg');
        } else {
          header.classList.remove('shadow-lg');
        }
      }
    });

    const chatBubble = document.getElementById('chat-bubble');
    const chatWindow = document.getElementById('chat-window');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const listeningIndicator = document.getElementById('listening-indicator');
    const synth = window.speechSynthesis;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = SpeechRecognition ? new SpeechRecognition() : null;
    let lastUserMessage = '';

    const speak = (text) => {
      if (!synth) {
        console.error('SpeechSynthesis not supported in this browser');
        return false;
      }
      try {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = text;
        const plainText = tempDiv.textContent || tempDiv.innerText || '';
        const utter = new SpeechSynthesisUtterance(plainText);
        utter.lang = 'pt-BR';
        utter.volume = 1.0;
        utter.rate = 1.0;
        utter.pitch = 1.0;
        synth.cancel();
        synth.speak(utter);
        console.log('Speaking:', plainText);
        return true;
      } catch (error) {
        console.error('Error in speak function:', error);
        return false;
      }
    };

    const addMessage = (message, isUser = false) => {
      const messageDiv = document.createElement('div');
      messageDiv.className = `p-2 mb-2 rounded-lg ${isUser ? 'bg-[#22d3ee] text-white ml-auto' : 'bg-gray-700 text-gray-200'} max-w-[80%]`;
      messageDiv.textContent = message;
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    chatBubble.addEventListener('click', () => {
      chatWindow.style.display = chatWindow.style.display === 'block' ? 'none' : 'block';
      if (chatWindow.style.display === 'block') {
        const welcomeMessage = 'Ol√°! Acabei de fazer seu pr√©-diagn√≥stico emocional. Gostaria de um relat√≥rio avan√ßado ou uma consulta m√©dica?';
        addMessage(welcomeMessage, false);
        speak(welcomeMessage);
      }
    });

    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && chatInput.value.trim()) {
        const userMessage = chatInput.value.trim();
        addMessage(userMessage, true);
        lastUserMessage = userMessage.toLowerCase();
        chatInput.value = '';
        respondToUser(lastUserMessage);
      }
    });

    if (recognition) {
      recognition.lang = 'pt-BR';
      recognition.onstart = () => listeningIndicator.classList.add('active');
      recognition.onend = () => listeningIndicator.classList.remove('active');
      recognition.onresult = (event) => {
        const spokenText = event.results[0][0].transcript;
        chatInput.value = spokenText;
        const eventEnter = new Event('keypress');
        eventEnter.key = 'Enter';
        chatInput.dispatchEvent(eventEnter);
      };
      recognition.onerror = () => {
        listeningIndicator.classList.remove('active');
        addMessage('Desculpe, o reconhecimento de voz n√£o est√° dispon√≠vel.', false);
      };
      chatInput.addEventListener('focus', () => recognition.start());
    } else {
      chatInput.addEventListener('focus', () => {
        addMessage('Reconhecimento de voz n√£o dispon√≠vel neste navegador.', false);
      });
    }

    function respondToUser(message) {
      let response = 'Gostaria de um relat√≥rio avan√ßado, uma consulta m√©dica ou um plano b√°sico?';
      if (message.includes('relat√≥rio') || message.includes('avan√ßado') || message.includes('detalhado')) {
        response = '√ìtimo! Vamos para os relat√≥rios avan√ßados!';
        setTimeout(() => window.location.href = '/relatorios-avancados.html', 1500);
      } else if (message.includes('m√©dico') || message.includes('consulta')) {
        response = 'Conectando voc√™ a um consultor m√©dico...';
        setTimeout(() => initMedicalConsult(), 1500);
      } else if (message.includes('b√°sico') || message.includes('simples')) {
        response = 'Entendido! Vamos para o plano b√°sico.';
        setTimeout(() => window.location.href = '/criar-alibi-basico.html', 1500);
      } else if (message.includes('n√£o') || message.includes('obrigado')) {
        response = 'Tudo bem! Se precisar, estou aqui. Que tal explorar nosso blog?';
        setTimeout(() => window.location.href = '/blog.html', 1500);
      } else if (message.includes('suporte') || message.includes('ajuda')) {
        response = 'Nosso suporte est√° pronto para ajudar!';
        setTimeout(() => window.location.href = '/suporte.html', 1500);
      }
      setTimeout(() => {
        addMessage(response, false);
        speak(response);
      }, 500);
    }

    function changeLanguage() {
      const lang = document.getElementById('language-selector').value;
      const translations = {
        'pt-BR': {
          hero: 'Transforme Sua Vida com o Scanner Emocional',
          subhero: 'Descubra seu estado emocional com IA avan√ßada. Teste gr√°tis agora!',
          emotionTitle: 'Entenda Suas Emo√ß√µes',
          emotionDesc: 'Nosso scanner analisa express√µes faciais, frequ√™ncia card√≠aca e tom de voz para identificar seu estado emocional com precis√£o.',
          scanTitle: 'Seu rosto carrega sinais. Vamos descobrir o que ele diz?',
          scanDesc: 'Ative sua c√¢mera e microfone para um diagn√≥stico emocional detalhado com idade aparente.'
        },
        'en-US': {
          hero: 'Transform Your Life with the Emotional Scanner',
          subhero: 'Discover your emotional state with advanced AI. Try it free now!',
          emotionTitle: 'Understand Your Emotions',
          emotionDesc: 'Our scanner analyzes facial expressions, heart rate, and voice tone to accurately identify your emotional state.',
          scanTitle: 'Your face holds clues. Let‚Äôs uncover what it says?',
          scanDesc: 'Activate your camera and microphone for a detailed emotional diagnosis with apparent age.'
        },
        'es-ES': {
          hero: 'Transforma tu Vida con el Esc√°ner Emocional',
          subhero: 'Descubre tu estado emocional con IA avanzada. ¬°Pru√©balo gratis ahora!',
          emotionTitle: 'Entiende tus Emo√ß√µes',
          emotionDesc: 'Nuestro esc√°ner analiza expresiones faciales, frecuencia card√≠aca y tono de voz para identificar tu estado emocional con precisi√≥n.',
          scanTitle: 'Tu rostro guarda se√±ales. ¬øDescubrimos qu√© dice?',
          scanDesc: 'Activa tu c√°mara y micr√≥fono para un diagn√≥stico emocional detallado con edad aparente.'
        }
      };
      const langData = translations[lang] || translations['pt-BR'];
      document.querySelector('#hero h1').textContent = langData.hero;
      document.querySelector('#hero p').textContent = langData.subhero;
      document.querySelector('#emotion-intro h2').textContent = langData.emotionTitle;
      document.querySelector('#emotion-intro p').textContent = langData.emotionDesc;
      document.querySelector('#scanner h2').textContent = langData.scanTitle;
      document.querySelector('#scanner p').textContent = langData.scanDesc;
    }
  });

  function initScrollAnimations() {
    const animatedElements = document.querySelectorAll('.animate-on-scroll');
    function checkIfInView() {
      const windowHeight = window.innerHeight;
      const windowTopPosition = window.scrollY;
      const windowBottomPosition = windowTopPosition + windowHeight;
      animatedElements.forEach(element => {
        const elementHeight = element.offsetHeight;
        const elementTopPosition = element.offsetTop;
        const elementBottomPosition = elementTopPosition + elementHeight;
        if (elementBottomPosition >= windowTopPosition && elementTopPosition <= windowBottomPosition) {
          element.classList.add('visible');
        }
      });
    }
    checkIfInView();
    window.addEventListener('scroll', checkIfInView);
    window.addEventListener('resize', checkIfInView);
  }

  function fft(signal) {
    const n = signal.length;
    if (n <= 1) return signal;

    const even = [];
    const odd = [];
    for (let i = 0; i < n; i++) {
      if (i % 2 === 0) even.push(signal[i]);
      else odd.push(signal[i]);
    }

    const evenFFT = fft(even);
    const oddFFT = fft(odd);
    const result = new Array(n).fill(0);

    for (let i = 0; i < n / 2; i++) {
      const theta = -2 * Math.PI * i / n;
      const t = {
        re: Math.cos(theta) * oddFFT[i],
        im: Math.sin(theta) * oddFFT[i]
      };
      result[i] = evenFFT[i] + t.re;
      result[i + n / 2] = evenFFT[i] - t.re;
    }
    return result;
  }

  function getDominantFrequency(signal, sampleRate) {
    const n = signal.length;
    const fftResult = fft(signal);
    const magnitudes = fftResult.slice(0, n / 2).map((val, i) => {
      return Math.sqrt(val * val);
    });

    let maxMag = 0;
    let maxIndex = 0;
    for (let i = 1; i < magnitudes.length; i++) {
      if (magnitudes[i] > maxMag) {
        maxMag = magnitudes[i];
        maxIndex = i;
      }
    }

    const freq = maxIndex * sampleRate / n;
    return freq;
  }

  async function captureAndAnalyze() {
    console.log('Iniciando an√°lise facial e biom√©trica...');
    const canvas = document.getElementById('canvas');
    const video = document.getElementById('video');
    const placeholder = document.getElementById('video-placeholder');
    const result = document.getElementById('scanner-result');
    const ppgOverlay = document.getElementById('ppg-overlay');
    const ppgProgressBar = document.getElementById('ppg-progress-bar');
    const micPrompt = document.getElementById('mic-prompt');
    let audioContext = null;
    let analyser = null;
    let videoStream = null;
    let audioStream = null;

    if (!canvas || !video || !result || !placeholder || !ppgOverlay || !ppgProgressBar || !micPrompt) {
      console.error('Elementos necess√°rios n√£o encontrados:', { canvas, video, result, placeholder, ppgOverlay, ppgProgressBar, micPrompt });
      return;
    }

    // Step 1: Request video stream (camera only)
    try {
      videoStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      video.srcObject = videoStream;
      video.classList.remove('hidden');
      placeholder.classList.add('hidden');
      console.log('C√¢mera inicializada com sucesso');
    } catch (error) {
      console.error('Erro ao acessar a c√¢mera:', error);
      video.classList.add('hidden');
      placeholder.classList.remove('hidden');
      result.style.display = 'block';
      let errorMessage = '<p class="fade-in">üö´ Erro: n√£o foi poss√≠vel acessar a c√¢mera. Permita o acesso e tente novamente.</p>';
      if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
        const videoTracks = videoStream ? videoStream.getVideoTracks().length : 0;
        if (videoTracks === 0) {
          errorMessage = '<p class="fade-in">üö´ Por favor, permita o acesso √† c√¢mera para continuar.</p>';
        }
      }
      result.innerHTML = `${errorMessage}<div class="mt-6"><button onclick="captureAndAnalyze()" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Tentar Novamente</button></div>`;
      return;
    }

    window.speechSynthesis.cancel();
    result.style.display = 'block';
    result.innerHTML = '<p class="fade-in">‚è≥ Preparando an√°lise<span class="loading-dots"></span></p>';

    // Step 2: Speech recognition with temporary audio stream
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = SpeechRecognition ? new SpeechRecognition() : null;
    let spokenText = '';
    if (recognition) {
      try {
        // Request audio stream for speech recognition
        audioStream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });
        console.log('Microfone inicializado para reconhecimento de voz');

        recognition.lang = 'pt-BR';
        recognition.continuous = false;
        recognition.interimResults = false;
        micPrompt.style.display = 'flex';
        result.innerHTML = '<p class="fade-in">üéôÔ∏è Leia a frase exibida para iniciar a an√°lise.</p>';
        speak('Leia a frase exibida para iniciar a an√°lise.');

        spokenText = await new Promise((resolve, reject) => {
          recognition.onresult = (event) => {
            const text = event.results[0][0].transcript;
            resolve(text);
          };
          recognition.onerror = (event) => {
            reject(event.error);
          };
          recognition.onend = () => {
            if (!spokenText) reject('No speech detected');
          };
          recognition.start();
          setTimeout(() => {
            if (!spokenText) {
              recognition.stop();
              reject('Timeout: No speech detected within 10 seconds');
            }
          }, 10000);
        });

        // Stop audio stream and add a delay to prevent echo
        if (audioStream) {
          audioStream.getAudioTracks().forEach(track => track.stop());
          audioStream = null;
          await new Promise(resolve => setTimeout(resolve, 200)); // Delay to ensure microphone disengages
          console.log('Microfone desativado ap√≥s captura de voz');
        }

        micPrompt.style.display = 'none';
        const expectedPhrase = 'estou me sentindo bem hoje';
        const spokenLower = spokenText.toLowerCase().trim();
        const containsExpectedPhrase = spokenLower.includes(expectedPhrase);

        if (!containsExpectedPhrase) {
          result.innerHTML = '<p class="fade-in">ü§î Frase n√£o reconhecida. Diga "Estou me sentindo bem hoje" e tente novamente.</p><div class="mt-6"><button onclick="captureAndAnalyze()" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Tentar Novamente</button></div>';
          speak('Frase n√£o reconhecida. Diga "Estou me sentindo bem hoje" e tente novamente.');
          if (videoStream) {
            videoStream.getVideoTracks().forEach(track => track.stop());
            video.classList.add('hidden');
            placeholder.classList.remove('hidden');
          }
          return;
        }
} catch (error) {
  console.error('Erro no reconhecimento de voz:', error);
  micPrompt.style.display = 'none';
  if (audioStream) {
    audioStream.getAudioTracks().forEach(track => track.stop());
    audioStream = null;
    console.log('Microfone desativado devido a erro no reconhecimento de voz');
  }
  let errorMessage = 'üö´ N√£o conseguimos ouvir sua voz. Verifique o microfone e tente novamente.';
  if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
    errorMessage = 'üö´ Permiss√£o para o microfone negada. Por favor, permita o acesso e tente novamente.';
  } else if (error === 'Timeout: No speech detected within 10 seconds') {
    errorMessage = 'üö´ Nenhuma fala detectada em 10 segundos. Fale mais alto ou verifique o microfone.';
  } else if (error.name === 'NotFoundError') {
    errorMessage = 'üö´ Nenhum microfone detectado. Conecte um microfone e tente novamente.';
  }
  result.innerHTML = `<p class="fade-in">${errorMessage}</p><div class="mt-6"><button onclick="captureAndAnalyze()" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Tentar Novamente</button></div>`;
  speak(errorMessage.replace('üö´ ', ''));
  if (videoStream) {
    videoStream.getVideoTracks().forEach(track => track.stop());
    video.classList.add('hidden');
    placeholder.classList.remove('hidden');
  }
  return;
}
    } else {
      result.innerHTML = '<p class="fade-in">üö´ Reconhecimento de voz n√£o dispon√≠vel neste navegador. Ative manualmente para continuar.</p><div class="mt-6"><button onclick="captureAndAnalyze()" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Tentar Novamente</button></div>';
      speak('Reconhecimento de voz n√£o dispon√≠vel. Ative manualmente para continuar.');
      if (videoStream) {
        videoStream.getVideoTracks().forEach(track => track.stop());
        video.classList.add('hidden');
        placeholder.classList.remove('hidden');
      }
      return;
    }

    // Step 3: Check lighting conditions
    const context = canvas.getContext('2d');
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
    let brightnessSum = 0;
    for (let i = 0; i < imageData.data.length; i += 4) {
      const r = imageData.data[i];
      const g = imageData.data[i + 1];
      const b = imageData.data[i + 2];
      brightnessSum += (0.299 * r + 0.587 * g + 0.114 * b);
    }
    const averageBrightness = brightnessSum / (imageData.data.length / 4);
    if (averageBrightness < 50) {
      result.innerHTML = '<p class="fade-in">üåô A ilumina√ß√£o est√° muito baixa. Ajuste a luz para continuar.</p><div class="mt-6"><button onclick="captureAndAnalyze()" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Tentar Novamente</button></div>';
      speak('A ilumina√ß√£o est√° muito baixa. Ajuste a luz e tente novamente.');
      if (videoStream) {
        videoStream.getVideoTracks().forEach(track => track.stop());
        video.classList.add('hidden');
        placeholder.classList.remove('hidden');
      }
      return;
    }

    // Step 4: Face detection (optimized)
    let faceRect = null;
    const tracker = new tracking.ObjectTracker('face');
    tracker.setInitialScale(4);
    tracker.setStepSize(2);
    tracker.setEdgesDensity(0.1);
    tracking.track('#video', tracker);
    tracker.on('track', event => {
      if (event.data.length > 0) {
        faceRect = event.data[0];
      }
    });

    let faceDetected = false;
    for (let i = 0; i < 30; i++) { // Reduced to 30 iterations
      if (faceRect) {
        faceDetected = true;
        break; // Exit early if face is detected
      }
      await new Promise(resolve => setTimeout(resolve, 100));
    }

    if (!faceDetected) {
      result.innerHTML = '<p class="fade-in">ü§î N√£o conseguimos detectar seu rosto. Centralize-se na c√¢mera e tente novamente.</p><div class="mt-6"><button onclick="captureAndAnalyze()" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Tentar Novamente</button></div>';
      speak('N√£o conseguimos detectar seu rosto. Centralize-se na c√¢mera e tente novamente.');
      tracker.stop();
      if (videoStream) {
        videoStream.getVideoTracks().forEach(track => track.stop());
        video.classList.add('hidden');
        placeholder.classList.remove('hidden');
      }
      return;
    }

    // Step 5: PPG (heart rate) measurement
    const PPG_DURATION = 15;
    const FRAME_RATE = 30;
    const TOTAL_FRAMES = PPG_DURATION * FRAME_RATE;
    const greenValues = [];
    let startTime = Date.now();
    result.innerHTML = '<p class="fade-in">‚ù§Ô∏è Fique parado por 15 segundos para medir sua frequ√™ncia card√≠aca.</p>';
    ppgOverlay.classList.add('active');

    while ((Date.now() - startTime) / 1000 < PPG_DURATION) {
      const elapsed = (Date.now() - startTime) / 1000;
      const progress = (elapsed / PPG_DURATION) * 100;
      ppgProgressBar.style.width = `${progress}%`;

      if (!faceRect) {
        result.innerHTML = '<p class="fade-in">üõë Movimenta√ß√£o detectada. Fique parado e tente novamente.</p><div class="mt-6"><button onclick="captureAndAnalyze()" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Tentar Novamente</button></div>';
        speak('Movimenta√ß√£o detectada. Fique parado e tente novamente.');
        ppgOverlay.classList.remove('active');
        tracker.stop();
        if (videoStream) {
          videoStream.getVideoTracks().forEach(track => track.stop());
          video.classList.add('hidden');
          placeholder.classList.remove('hidden');
        }
        return;
      }

      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      const foreheadX = faceRect.x + faceRect.width * 0.3;
      const foreheadY = faceRect.y + faceRect.height * 0.2;
      const foreheadWidth = faceRect.width * 0.4;
      const foreheadHeight = faceRect.height * 0.2;
      const foreheadData = context.getImageData(foreheadX, foreheadY, foreheadWidth, foreheadHeight);
      let greenSum = 0;
      let pixelCount = 0;
      for (let i = 0; i < foreheadData.data.length; i += 4) {
        greenSum += foreheadData.data[i + 1];
        pixelCount++;
      }
      const averageGreen = greenSum / pixelCount;
      greenValues.push(averageGreen);
      await new Promise(resolve => setTimeout(resolve, 1000 / FRAME_RATE));
    }

    ppgOverlay.classList.remove('active');
    tracker.stop();

    let heartRate = 0;
    let isSimulated = false;
    try {
      const mean = greenValues.reduce((a, b) => a + b, 0) / greenValues.length;
      const detrended = greenValues.map(val => val - mean);
      const maxVal = Math.max(...detrended.map(Math.abs));
      const normalized = detrended.map(val => val / maxVal);
      const freq = getDominantFrequency(normalized, FRAME_RATE);
      heartRate = Math.round(freq * 60);
      if (heartRate < 40 || heartRate > 180) {
        throw new Error('Heart rate out of realistic range');
      }
    } catch (error) {
      console.error('PPG analysis failed:', error);
      heartRate = Math.floor(60 + (Math.random() * 40));
      isSimulated = true;
    }

    // Step 6: Facial analysis
    result.innerHTML = '<p class="fade-in">‚è≥ Analisando express√£o facial<span class="loading-dots"></span></p>';
    const captures = [];
    const audioCaptures = [];
    try {
      for (let i = 0; i < 2; i++) {
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageBase64 = canvas.toDataURL('image/jpeg').split(',')[1];
        captures.push(imageBase64);

        const simulatedVoiceTone = 100 + Math.random() * 50; // Arbitrary range
        audioCaptures.push(simulatedVoiceTone);
        await new Promise(resolve => setTimeout(resolve, 100));
      }
    } catch (error) {
      console.error('Erro durante a an√°lise:', error);
      result.innerHTML = '<p class="fade-in">üö´ Erro durante a an√°lise. Tente novamente.</p><div class="mt-6"><button onclick="captureAndAnalyze()" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Tentar Novamente</button></div>';
      if (videoStream) {
        videoStream.getVideoTracks().forEach(track => track.stop());
        video.classList.add('hidden');
        placeholder.classList.remove('hidden');
      }
      return;
    } finally {
      if (videoStream) {
        videoStream.getVideoTracks().forEach(track => track.stop());
        video.classList.add('hidden');
        placeholder.classList.remove('hidden');
        console.log('C√¢mera fechada ap√≥s an√°lise');
      }
      videoStream = null;
    }

    // Step 7: Process results with Face++ API
    let bestResult = null;
    let maxConfidence = 0;

    for (let i = 0; i < captures.length; i++) {
      const formData = new FormData();
      formData.append('api_key', apiKey);
      formData.append('api_secret', apiSecret);
      formData.append('image_base64', captures[i]);
      formData.append('return_attributes', 'emotion,age');

      try {
        const response = await fetch('https://api-us.faceplusplus.com/facepp/v3/detect', {
          method: 'POST',
          body: formData
        });
        const data = await response.json();
        console.log('Resposta da API Face++:', data);

        if (data.faces && data.faces.length > 0) {
          const face = data.faces[0];
          const emotion = face.attributes.emotion;
          const emotionsSorted = Object.entries(emotion).sort((a, b) => b[1] - a[1]);
          const confidence = emotionsSorted[0][1];
          if (confidence > maxConfidence) {
            maxConfidence = confidence;
            bestResult = { emotion, age: face.attributes.age.value, heartRate, voiceTone: audioCaptures[i], isSimulated };
          }
        }
      } catch (error) {
        console.error('Erro ao analisar captura:', error);
      }
    }

    // Step 8: Display diagnosis
    if (bestResult && maxConfidence >= 50) {
      const { emotion, age, heartRate, voiceTone, isSimulated } = bestResult;
      const emotionsSorted = Object.entries(emotion).sort((a, b) => b[1] - a[1]);
      const primaryEmotion = emotionsSorted[0][0];

      // Generate diagnosis using the new function
      const diag = generateDiagnosis(primaryEmotion, heartRate, age, isSimulated);

      // Build and display the diagnosis HTML
      const diagnosisHTML = `
        <h3 class="text-2xl font-bold mb-4 fade-in">Resultado do Diagn√≥stico</h3>
        <p class="fade-in"><strong>Emo√ß√£o Predominante:</strong> ${diag.primaryEmotionInPortuguese.charAt(0).toUpperCase() + diag.primaryEmotionInPortuguese.slice(1)}</p>
        <p class="fade-in"><strong>Idade Aparente:</strong> Entre ${diag.ageRangeMin} e ${diag.ageRangeMax} anos</p>
        <p class="fade-in mt-2">${diag.diagnosis}</p>
        <p class="fade-in mt-2"><strong>Poss√≠veis Gatilhos:</strong> ${diag.triggers}</p>
        <p class="fade-in mt-2"><strong>Sugest√£o:</strong> ${diag.suggestion}</p>
        <p class="fade-in mt-2"><strong>Plano Personalizado:</strong> ${diag.personalizedPlan}</p>
        ${diag.ctaButtons}
      `;

      result.innerHTML = diagnosisHTML;
      speak(`Seu diagn√≥stico est√° pronto. Emo√ß√£o predominante: ${diag.primaryEmotionInPortuguese.charAt(0).toUpperCase() + diag.primaryEmotionInPortuguese.slice(1)}. ${diag.diagnosis}`);
    } else {
      result.innerHTML = '<p class="fade-in">üö´ N√£o foi poss√≠vel determinar uma emo√ß√£o com confian√ßa suficiente. Tente novamente.</p><div class="mt-6"><button onclick="captureAndAnalyze()" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine">Tentar Novamente</button></div>';
      speak('N√£o foi poss√≠vel determinar uma emo√ß√£o com confian√ßa suficiente. Tente novamente.');
    }
  }

  async function initMedicalConsult() {
    const result = document.getElementById('scanner-result');
    if (result) {
      result.style.display = 'block';
      result.innerHTML = '<p class="fade-in">üìû Conectando a um consultor m√©dico<span class="loading-dots"></span></p>';
      speak('Conectando a um consultor m√©dico.');
      setTimeout(() => {
        window.location.href = '/medical-ai.html';
      }, 3000);
    }
  }

  function toggleVR() {
    const vrContainer = document.getElementById('vr-container');
    if (vrContainer) {
      vrContainer.style.display = vrContainer.style.display === 'block' ? 'none' : 'block';
      speak(vrContainer.style.display === 'block' ? 'Bem-vindo ao Relaxamento VR/AR!' : 'Relaxamento VR/AR desativado.');
    }
  }
</script>
