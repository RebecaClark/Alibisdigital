<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scanner Emocional - √Ålibis Digital</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    html { scroll-behavior: smooth; }
    body { 
      position: relative; 
      overflow-x: hidden; 
      min-height: 100vh; 
      color: #e5e7eb; 
      text-shadow: 0 0 5px rgba(0, 0, 0, 0.5); 
    }
    #particles-js {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: -1;
      background: linear-gradient(135deg, #0b1120, #1e1b4b, #2e1065);
    }
    .fade-in { animation: fadeIn 1s ease-in-out; }
    .slide-in-left { animation: slideInLeft 1.2s ease-in-out; }
    .slide-in-right { animation: slideInRight 1.2s ease-in-out; }
    .bounce-in { animation: bounceIn 1.2s ease-in-out; }
    .pulse { animation: pulse 2s infinite ease-in-out; }
    .float { animation: float 4s infinite ease-in-out; }
    .scale-up { animation: scaleUp 0.8s ease-in-out; }
    .scale-in { animation: scaleIn 0.8s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideInLeft { from { opacity: 0; transform: translateX(-60px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes slideInRight { from { opacity: 0; transform: translateX(60px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes bounceIn { 0% { opacity: 0; transform: scale(0.5); } 50% { opacity: 1; transform: scale(1.1); } 75% { transform: scale(0.9); } 100% { transform: scale(1); } }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    @keyframes float { 0% { transform: translateY(0); } 50% { transform: translateY(-15px); } 100% { transform: translateY(0); } }
    @keyframes scaleUp { from { opacity: 0; transform: scale(0.7); } to { opacity: 1; transform: scale(1); } }
    @keyframes scaleIn { from { opacity: 0; transform: scale(0.7); } to { opacity: 1; transform: scale(1); } }
    .shine { position: relative; overflow: hidden; }
    .shine::after { content: ''; position: absolute; top: -60%; left: -60%; width: 220%; height: 220%; background: linear-gradient(45deg, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0)); transform: rotate(20deg); animation: shine 4s infinite linear; }
    @keyframes shine { 0% { transform: translateX(-120%) rotate(20deg); } 100% { transform: translateX(120%) rotate(20deg); } }
    .futuristic-btn { background: linear-gradient(45deg, #7C3AED, #22d3ee); box-shadow: 0 0 15px #22d3ee; transition: transform 0.3s ease, box-shadow 0.3s ease; animation: neonPulse 1.5s infinite alternate; }
    .futuristic-btn:hover { transform: translateY(-5px); box-shadow: 0 0 25px #22d3ee, 0 0 35px #22d3ee; }
    @keyframes neonPulse { 0% { box-shadow: 0 0 5px #22d3ee, 0 0 10px #22d3ee; } 100% { box-shadow: 0 0 15px #22d3ee, 0 0 25px #22d3ee; } }
    .holo-nav {
      background: rgba(17, 24, 39, 0.8);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      animation: holoGlow 2s infinite alternate;
    }
    @keyframes holoGlow {
      0% { box-shadow: 0 0 10px #22d3ee, 0 0 20px #22d3ee, 0 0 30px #22d3ee; }
      100% { box-shadow: 0 0 20px #22d3ee, 0 0 30px #22d3ee, 0 0 40px #22d3ee; }
    }
    .holo-nav a, .holo-nav button {
      position: relative;
      transition: color 0.3s ease;
    }
    .holo-nav a:hover, .holo-nav button:hover {
      color: #22d3ee;
      text-shadow: 0 0 5px #22d3ee;
    }
    .dropdown-menu {
      background: rgba(31, 41, 55, 0.9);
      border: 1px solid #22d3ee;
      box-shadow: 0 0 10px #22d3ee;
      border-radius: 8px;
      padding: 8px 0;
      position: absolute;
      top: 100%;
      left: 0;
      display: none;
      width: 200px;
    }
    .dropdown-menu a {
      display: block;
      padding: 8px 16px;
      color: #e5e7eb;
      transition: all 0.3s ease;
    }
    .dropdown-menu a:hover {
      background: rgba(55, 65, 81, 0.8);
      color: #22d3ee;
      text-shadow: 0 0 5px #22d3ee;
    }
    .dropdown:hover .dropdown-menu {
      display: block;
    }
    .dropdown-menu-mobile {
      background: rgba(31, 41, 55, 0.9);
      border: 1px solid #22d3ee;
      box-shadow: 0 0 10px #22d3ee;
      border-radius: 8px;
      padding: 8px 0;
      width: 100%;
      position: static;
    }
    .dropdown-menu-mobile a {
      display: block;
      padding: 8px 16px;
      color: #e5e7eb;
      transition: all 0.3s ease;
    }
    .dropdown-menu-mobile a:hover {
      background: rgba(55, 65, 81, 0.8);
      color: #22d3ee;
      text-shadow: 0 0 5px #22d3ee;
    }
    .animate-on-scroll {
      opacity: 0;
      transform: translateY(50px);
      transition: opacity 0.9s ease-out, transform 0.9s ease-out;
    }
    .animate-on-scroll.visible {
      opacity: 1;
      transform: translateY(0);
    }
    .neon-box {
      background: linear-gradient(45deg, #1e1b4b, #22d3ee);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 0 10px #22d3ee;
      animation: fadeIn 1s ease-in-out;
      max-width: 600px;
      margin: 0 auto;
      text-align: left;
    }
    .loading-dots::after {
      content: '';
      display: inline-block;
      width: 1em;
      height: 1em;
      animation: dots 1.5s steps(3, end) infinite;
    }
    @keyframes dots {
      0% { content: '.'; }
      33% { content: '..'; }
      66% { content: '...'; }
      100% { content: '.'; }
    }
    @media (max-width: 768px) {
      h1 { font-size: 2.5rem; }
      h2 { font-size: 1.8rem; }
      .max-w-4xl { max-width: 100%; padding: 0 1rem; }
      .grid { grid-template-columns: 1fr; }
      .flex { flex-direction: column; }
      .futuristic-btn { width: 100%; margin-bottom: 0.5rem; }
      video { width: 100%; height: auto; }
      .neon-box { padding: 15px; }
    }
  </style>
</head>
<body class="bg-transparent text-white font-sans">
  <!-- Fundo com Part√≠culas -->
  <div id="particles-js"></div>

  <!-- Cabe√ßalho com Efeito Hologr√°fico -->
  <header class="holo-nav fixed top-0 left-0 w-full z-50 transition-shadow duration-300">
    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-3">
        <a href="/">
          <img src="/assets/logo.png" alt="Logo da √Ålibis Digital" class="h-10 w-auto" onerror="console.error('Erro ao carregar logo.png')">
        </a>
      </div>
      <div class="flex items-center space-x-3">
        <select id="language-selector" class="bg-gray-800 text-white p-1 rounded" aria-label="Selecionar idioma">
          <option value="pt-BR">Portugu√™s</option>
          <option value="en-US">English</option>
        </select>
        <div class="md:hidden">
          <button id="hamburger-menu" class="text-white focus:outline-none p-2 rounded" aria-label="Abrir menu de navega√ß√£o">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </div>
      </div>
      <nav id="navbar" class="hidden md:flex space-x-6 text-sm items-center">
        <div class="dropdown relative">
          <button class="hover:text-[#22d3ee] transition flex items-center" aria-label="Abrir menu de servi√ßos">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path>
            </svg>
            <span data-i18n="services">Servi√ßos</span>
            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div class="dropdown-menu">
            <a href="/scanner.html" class="hover:text-[#22d3ee] transition" data-i18n="scanner">Scanner com IA</a>
            <a href="/emotional-evaluation.html" class="hover:text-[#22d3ee] transition" data-i18n="emotional-evaluation">Avalia√ß√£o Emocional</a>
            <a href="/medical-ai.html" class="hover:text-[#22d3ee] transition" data-i18n="medical-ai">Diagn√≥stico M√©dico</a>
            <a href="/alibi.html" class="hover:text-[#22d3ee] transition" data-i18n="alibi">Criar √Ålibi</a>
          </div>
        </div>
        <a href="/blog.html" class="hover:text-[#22d3ee] transition" data-i18n="blog">Blog</a>
        <a href="#checkout" class="hover:text-[#22d3ee] transition" data-i18n="plans">Planos</a>
        <a href="#suporte" class="hover:text-[#22d3ee] transition" data-i18n="support">Suporte</a>
        <a href="/scanner.html" class="futuristic-btn text-white py-2 px-4 rounded-full text-sm font-semibold" aria-label="Teste o scanner emocional gr√°tis" data-i18n="test-free">
          üîç Teste Gr√°tis
        </a>
      </nav>
    </div>
    <div id="mobile-menu" class="md:hidden bg-gray-800 bg-opacity-95 w-full hidden py-4">
      <nav class="flex flex-col items-center space-y-4">
        <div class="w-full">
          <button id="services-toggle" class="text-white py-2 px-4 text-lg w-full text-center hover:bg-gray-700 rounded flex justify-between items-center">
            <span data-i18n="services">Servi√ßos</span>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <div id="services-menu" class="dropdown-menu-mobile">
            <a href="/scanner.html" class="hover:bg-gray-700" data-i18n="scanner">Scanner com IA</a>
            <a href="/emotional-evaluation.html" class="hover:bg-gray-700" data-i18n="emotional-evaluation">Avalia√ß√£o Emocional</a>
            <a href="/medical-ai.html" class="hover:bg-gray-700" data-i18n="medical-ai">Diagn√≥stico M√©dico</a>
            <a href="/alibi.html" class="hover:bg-gray-700" data-i18n="alibi">Criar √Ålibi</a>
          </div>
        </div>
        <a href="/blog.html" class="text-white py-2 px-4 text-lg w-full text-center hover:bg-gray-700 rounded" data-i18n="blog">Blog</a>
        <a href="#checkout" class="text-white py-2 px-4 text-lg w-full text-center hover:bg-gray-700 rounded" data-i18n="plans">Planos</a>
        <a href="#suporte" class="text-white py-2 px-4 text-lg w-full text-center hover:bg-gray-700 rounded" data-i18n="support">Suporte</a>
        <a href="/scanner.html" class="futuristic-btn text-white py-2 px-4 rounded-full text-lg w-full text-center" aria-label="Teste o scanner emocional gr√°tis" data-i18n="test-free">
          üîç Teste Gr√°tis
        </a>
      </nav>
    </div>
  </header>
  <div class="h-20"></div>

  <!-- Se√ß√£o do Scanner -->
  <section class="py-20 px-6 text-center animate-on-scroll" id="scanner">
    <h2 class="text-4xl font-bold mb-6 text-white shine" data-i18n="scanner-title">Seu rosto carrega sinais. Vamos descobrir o que ele diz?</h2>
    <p class="text-lg mb-8 text-gray-300 fade-in" data-i18n="scanner-subtitle">Ative sua c√¢mera e receba um pr√©-diagn√≥stico emocional como se estivesse diante de um cl√≠nico experiente.</p>
    <div class="flex justify-center mb-12 scale-in">
      <video id="video" width="320" height="240" autoplay class="rounded-xl shadow-md border-4 border-[#22C55E] pulse" aria-label="V√≠deo da c√¢mera para an√°lise emocional"></video>
    </div>
    <div class="flex justify-center mb-12">
      <button onclick="captureAndAnalyze()" class="futuristic-btn text-white font-bold px-8 py-3 rounded-full text-lg shine" aria-label="Iniciar an√°lise emocional" data-i18n="analyze-emotion">
        Analisar Estado Emocional
      </button>
    </div>
    <div id="scanner-result" class="neon-box" style="display: none;"></div>
    <canvas id="canvas" width="320" height="240" style="display: none;"></canvas>
  </section>

  <!-- Rodap√© -->
  <footer class="bg-[rgba(11,17,32,0.8)] text-gray-400 py-12 animate-on-scroll">
    <div class="max-w-6xl mx-auto px-6 grid grid-cols-1 md:grid-cols-3 gap-10 text-sm">
      <div class="slide-in-left">
        <h3 class="text-white text-2xl font-bold mb-4 shine">√Ålibis Digital</h3>
        <p class="fade-in" data-i18n="footer-about">Solu√ß√µes de bem-estar com tecnologia avan√ßada.</p>
      </div>
      <div class="fade-in">
        <h4 class="text-white font-semibold mb-4" data-i18n="footer-navigate">Navegue</h4>
        <ul class="space-y-2">
          <li><a href="/" class="hover:text-white transition" data-i18n="home">In√≠cio</a></li>
          <li><a href="/scanner.html" class="hover:text-white transition" data-i18n="scanner">Scanner</a></li>
          <li><a href="/blog.html" class="hover:text-white transition" data-i18n="blog">Blog</a></li>
          <li><a href="/medical-ai.html" class="hover:text-white transition" data-i18n="medical-ai">Diagn√≥stico M√©dico</a></li>
          <li><a href="/emotional-evaluation.html" class="hover:text-white transition" data-i18n="emotional-evaluation">Avalia√ß√£o Emocional</a></li>
          <li><a href="/alibi.html" class="hover:text-white transition" data-i18n="alibi">Criar √Ålibi</a></li>
          <li><a href="#checkout" class="hover:text-white transition" data-i18n="plans">Planos</a></li>
          <li><a href="#suporte" class="hover:text-white transition" data-i18n="support">Suporte</a></li>
          <li><a href="/politica-privacidade" class="hover:text-white transition" data-i18n="privacy">Privacidade</a></li>
        </ul>
      </div>
      <div class="slide-in-right">
        <h4 class="text-white font-semibold mb-4" data-i18n="footer-contact">Contato</h4>
        <ul class="space-y-2">
          <li class="fade-in">E-mail: contato@alibisdigital.com</li>
          <li class="fade-in">WhatsApp: (11) 91234-5678</li>
        </ul>
      </div>
    </div>
    <div class="text-center mt-8">
      <p class="text-sm">¬© 2025 √Ålibis Digital. <span data-i18n="footer-rights">Todos os direitos reservados.</span></p>
    </div>
  </footer>

  <script>
    // Inicializar Part√≠culas com mais densidade
    particlesJS('particles-js', {
      "particles": {
        "number": { "value": 120, "density": { "enable": true, "value_area": 800 } },
        "color": { "value": "#22d3ee" },
        "shape": { "type": "circle" },
        "opacity": { "value": 0.5, "random": true },
        "size": { "value": 3, "random": true },
        "line_linked": { "enable": true, "distance": 150, "color": "#22d3ee", "opacity": 0.4, "width": 1 },
        "move": { "enable": true, "speed": 2, "direction": "none", "random": false, "straight": false, "out_mode": "out", "bounce": false }
      },
      "interactivity": {
        "detect_on": "canvas",
        "events": { "onhover": { "enable": true, "mode": "repulse" }, "onclick": { "enable": true, "mode": "push" }, "resize": true },
        "modes": { "repulse": { "distance": 100, "duration": 0.4 }, "push": { "particles_nb": 4 } }
      },
      "retina_detect": true
    });

    const apiKey = 'AmoIQKuEFggNsZmeO_Ur50ZZmfSrZ3mX';
    const apiSecret = 'WoRf3C8_IqQhe0Su8coFmOnAB_0nOheY';

    // Textos para internacionaliza√ß√£o
    const translations = {
      "pt-BR": {
        "services": "Servi√ßos",
        "scanner": "Scanner com IA",
        "emotional-evaluation": "Avalia√ß√£o Emocional",
        "medical-ai": "Diagn√≥stico M√©dico",
        "alibi": "Criar √Ålibi",
        "blog": "Blog",
        "plans": "Planos",
        "support": "Suporte",
        "test-free": "üîç Teste Gr√°tis",
        "scanner-title": "Seu rosto carrega sinais. Vamos descobrir o que ele diz?",
        "scanner-subtitle": "Ative sua c√¢mera e receba um pr√©-diagn√≥stico emocional como se estivesse diante de um cl√≠nico experiente.",
        "analyze-emotion": "Analisar Estado Emocional",
        "analyzing": "‚è≥ Analisando sua express√£o facial",
        "no-face-detected": "ü§î N√£o conseguimos detectar um rosto. Tente ajustar a ilumina√ß√£o ou a posi√ß√£o do rosto.",
        "error-analyzing": "üö´ Erro ao analisar a express√£o facial. Tente novamente.",
        "camera-error": "üö´ Erro: n√£o foi poss√≠vel acessar a c√¢mera. Permita o uso e recarregue a p√°gina.",
        "try-again": "Tentar Novamente",
        "disclaimer": "Nota: Estas sugest√µes s√£o baseadas em pesquisas preliminares e n√£o substituem avalia√ß√£o m√©dica ou psicol√≥gica profissional.",
        "emotional-support": "Ter Apoio Emocional",
        "footer-about": "Solu√ß√µes de bem-estar com tecnologia avan√ßada.",
        "footer-navigate": "Navegue",
        "home": "In√≠cio",
        "privacy": "Privacidade",
        "footer-contact": "Contato",
        "footer-rights": "Todos os direitos reservados."
      },
      "en-US": {
        "services": "Services",
        "scanner": "AI Scanner",
        "emotional-evaluation": "Emotional Evaluation",
        "medical-ai": "Medical Diagnosis",
        "alibi": "Create Alibi",
        "blog": "Blog",
        "plans": "Plans",
        "support": "Support",
        "test-free": "üîç Try Free",
        "scanner-title": "Your face carries signals. Let's find out what it says.",
        "scanner-subtitle": "Activate your camera and receive an emotional pre-diagnosis as if you were with an experienced clinician.",
        "analyze-emotion": "Analyze Emotional State",
        "analyzing": "‚è≥ Analyzing your facial expression",
        "no-face-detected": "ü§î We couldn't detect a face. Try adjusting the lighting or your position.",
        "error-analyzing": "üö´ Error analyzing facial expression. Please try again.",
        "camera-error": "üö´ Error: Could not access the camera. Allow access and reload the page.",
        "try-again": "Try Again",
        "disclaimer": "Note: These suggestions are based on preliminary research and do not replace professional medical or psychological evaluation.",
        "emotional-support": "Get Emotional Support",
        "footer-about": "Well-being solutions with advanced technology.",
        "footer-navigate": "Navigate",
        "home": "Home",
        "privacy": "Privacy",
        "footer-contact": "Contact",
        "footer-rights": "All rights reserved."
      }
    };

    // Fun√ß√£o para obter tradu√ß√µes com fallback
    function getTranslation(lang, key) {
      const trans = translations[lang] || translations['pt-BR'];
      return trans[key] || translations['pt-BR'][key] || key;
    }

    document.addEventListener('DOMContentLoaded', () => {
      const video = document.getElementById('video');
      if (video) {
        navigator.mediaDevices.getUserMedia({ video: true })
          .then(stream => {
            video.srcObject = stream;
          })
          .catch(error => {
            console.error("Erro ao acessar a c√¢mera:", error);
            const result = document.getElementById('scanner-result');
            if (result) {
              const lang = document.getElementById('language-selector')?.value || 'pt-BR';
              result.style.display = 'block';
              result.innerHTML = `<p class="fade-in">${getTranslation(lang, 'camera-error')}</p>`;
            }
          });
      } else {
        console.error("Elemento 'video' n√£o encontrado no DOM.");
      }

      initScrollAnimations();
      updateLanguage();

      const hamburger = document.getElementById('hamburger-menu');
      const mobileMenu = document.getElementById('mobile-menu');
      if (hamburger && mobileMenu) {
        hamburger.addEventListener('click', () => {
          mobileMenu.classList.toggle('hidden');
        });
      }

      const servicesToggle = document.getElementById('services-toggle');
      const servicesMenu = document.getElementById('services-menu');
      if (servicesToggle && servicesMenu) {
        servicesToggle.addEventListener('click', () => {
          servicesMenu.classList.toggle('hidden');
        });
      }

      window.addEventListener('scroll', () => {
        const header = document.querySelector('header');
        if (header) {
          if (window.scrollY > 50) {
            header.classList.add('shadow-lg');
          } else {
            header.classList.remove('shadow-lg');
          }
        }
      });

      const languageSelector = document.getElementById('language-selector');
      if (languageSelector) {
        languageSelector.addEventListener('change', updateLanguage);
      }
    });

    function initScrollAnimations() {
      const animatedElements = document.querySelectorAll('.animate-on-scroll');
      function checkIfInView() {
        const windowHeight = window.innerHeight;
        const windowTopPosition = window.scrollY;
        const windowBottomPosition = windowTopPosition + windowHeight;
        animatedElements.forEach(element => {
          const elementHeight = element.offsetHeight;
          const elementTopPosition = element.offsetTop;
          const elementBottomPosition = elementTopPosition + elementHeight;
          if (elementBottomPosition >= windowTopPosition && elementTopPosition <= windowBottomPosition) {
            element.classList.add('visible');
          }
        });
      }
      checkIfInView();
      window.addEventListener('scroll', checkIfInView);
      window.addEventListener('resize', checkIfInView);
    }

    function speak(text) {
      if (!window.speechSynthesis) {
        console.warn("API de s√≠ntese de voz n√£o suportada neste navegador.");
        return;
      }
      const synth = window.speechSynthesis;
      const utter = new SpeechSynthesisUtterance(text);
      const lang = document.getElementById('language-selector')?.value || 'pt-BR';
      utter.lang = lang;
      synth.speak(utter);
    }

    function updateLanguage() {
      const lang = document.getElementById('language-selector')?.value || 'pt-BR';
      document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        element.textContent = getTranslation(lang, key);
      });
    }

    function captureAndAnalyze() {
      const canvas = document.getElementById('canvas');
      const video = document.getElementById('video');
      const result = document.getElementById('scanner-result');
      const lang = document.getElementById('language-selector')?.value || 'pt-BR';

      if (!canvas || !video || !result) {
        console.error("Elementos necess√°rios n√£o encontrados: canvas, video ou scanner-result.");
        return;
      }

      result.style.display = 'block';
      result.innerHTML = `<p class="fade-in">${getTranslation(lang, 'analyzing')}<span class="loading-dots"></span></p>`;

      const context = canvas.getContext('2d');
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageBase64 = canvas.toDataURL('image/jpeg').split(',')[1];

      const formData = new FormData();
      formData.append('api_key', apiKey);
      formData.append('api_secret', apiSecret);
      formData.append('image_base64', imageBase64);
      formData.append('return_attributes', 'age,gender,emotion');

      fetch('https://api-us.faceplusplus.com/facepp/v3/detect', {
        method: 'POST',
        body: formData
      })
        .then(res => res.json())
        .then(data => {
          if (data.faces && data.faces.length > 0) {
            const face = data.faces[0];
            const age = face.attributes.age.value;
            const gender = face.attributes.gender.value;
            const emotion = face.attributes.emotion;
            const emotionSorted = Object.entries(emotion).sort((a, b) => b[1] - a[1])[0][0];

            const emotionPortuguese = {
              'sadness': lang === 'pt-BR' ? 'tristeza' : 'sadness',
              'anger': lang === 'pt-BR' ? 'raiva' : 'anger',
              'happiness': lang === 'pt-BR' ? 'felicidade' : 'happiness',
              'surprise': lang === 'pt-BR' ? 'surpresa' : 'surprise',
              'neutral': lang === 'pt-BR' ? 'neutra' : 'neutral',
              'fear': lang === 'pt-BR' ? 'medo' : 'fear',
              'disgust': lang === 'pt-BR' ? 'desgosto' : 'disgust'
            };

            const emotionInPortuguese = emotionPortuguese[emotionSorted] || emotionSorted;
            let diagnosis = '';
            let suggestion = '';
            let additionalButton = '';

            switch (emotionSorted) {
              case 'sadness':
                diagnosis = lang === 'pt-BR' 
                  ? "Detectamos sinais de tristeza em sua express√£o. Isso pode indicar que voc√™ est√° passando por um momento de melancolia ou saudade, talvez devido a uma situa√ß√£o recente que mexeu com seus sentimentos."
                  : "We detected signs of sadness in your expression. This may indicate that you are going through a moment of melancholy or longing, perhaps due to a recent situation that affected your feelings.";
                suggestion = lang === 'pt-BR'
                  ? "Que tal tirar um momento para relaxar? Escrever sobre o que est√° sentindo ou conversar com algu√©m de confian√ßa pode ajudar a aliviar. Se quiser, voc√™ tamb√©m pode explorar nosso artigo com dicas para melhorar o sono, que pode ajudar no seu bem-estar: <a href='/blog/melhorar-qualidade-sono.html' class='text-[#22d3ee] hover:underline'>Como Melhorar a Qualidade do Sono</a>."
                  : "How about taking a moment to relax? Writing about how you feel or talking to someone you trust can help. If you‚Äôd like, you can also check out our article with tips to improve your sleep, which can support your well-being: <a href='/blog/melhorar-qualidade-sono.html' class='text-[#22d3ee] hover:underline'>How to Improve Sleep Quality</a>.";
                additionalButton = `<div class="mt-4"><button onclick="window.location.href='/apoio-emocional'" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine" data-i18n="emotional-support" aria-label="${lang === 'pt-BR' ? 'Obter apoio emocional' : 'Get emotional support'}">${getTranslation(lang, 'emotional-support')}</button></div>`;
                break;
              case 'anger':
                diagnosis = lang === 'pt-BR'
                  ? "Sua express√£o mostra tra√ßos de raiva ou frustra√ß√£o. Isso pode ser um reflexo de algo que te irritou profundamente ou de um ac√∫mulo de tens√µes do dia a dia."
                  : "Your expression shows signs of anger or frustration. This may reflect something that deeply irritated you or an accumulation of daily tensions.";
                suggestion = lang === 'pt-BR'
                  ? "Respire fundo algumas vezes: inspire por 4 segundos, segure por 4, e expire por 8. Isso pode ajudar a acalmar os √¢nimos. Se precisar de mais ideias para lidar com o estresse, confira nosso artigo: <a href='/blog/reduzir-estresse-trabalho.html' class='text-[#22d3ee] hover:underline'>5 Dicas para Reduzir o Estresse no Trabalho</a>."
                  : "Take a few deep breaths: inhale for 4 seconds, hold for 4, and exhale for 8. This can help calm you down. If you need more ideas to manage stress, check out our article: <a href='/blog/reduzir-estresse-trabalho.html' class='text-[#22d3ee] hover:underline'>5 Tips to Reduce Workplace Stress</a>.";
                break;
              case 'happiness':
                diagnosis = lang === 'pt-BR'
                  ? "Voc√™ est√° com uma express√£o de felicidade! Isso √© maravilhoso e indica que voc√™ est√° em um momento de leveza e alegria, talvez por algo que aconteceu recentemente e te trouxe satisfa√ß√£o."
                  : "You have a happy expression! That‚Äôs wonderful and indicates you‚Äôre in a moment of lightness and joy, perhaps due to something recent that brought you satisfaction.";
                suggestion = lang === 'pt-BR'
                  ? "Aproveite esse momento para espalhar positividade! Que tal compartilhar algo que te fez sorrir com um amigo ou fazer uma atividade que voc√™ ama, como ouvir m√∫sica ou sair para um passeio?"
                  : "Take this moment to spread positivity! How about sharing something that made you smile with a friend or doing an activity you love, like listening to music or going for a walk?";
                break;
              case 'surprise':
                diagnosis = lang === 'pt-BR'
                  ? "Sua express√£o mostra surpresa. Voc√™ pode ter se deparado com algo inesperado, que te deixou curioso ou intrigado."
                  : "Your expression shows surprise. You may have encountered something unexpected that left you curious or intrigued.";
                suggestion = lang === 'pt-BR'
                  ? "Surpresas podem ser √≥timas para sair da rotina! Se for algo positivo, aproveite para explorar essa novidade. Caso tenha sido algo desafiador, respire fundo e avalie com calma antes de agir."
                  : "Surprises can be great for breaking the routine! If it‚Äôs something positive, take the chance to explore this novelty. If it was challenging, take a deep breath and assess calmly before acting.";
                break;
              case 'neutral':
                diagnosis = lang === 'pt-BR'
                  ? "Sua express√£o est√° neutra, o que pode indicar que voc√™ est√° concentrado ou talvez um pouco cansado. √Äs vezes, isso reflete um momento de introspec√ß√£o ou foco."
                  : "Your expression is neutral, which may indicate that you‚Äôre focused or perhaps a bit tired. Sometimes, this reflects a moment of introspection or focus.";
                suggestion = lang === 'pt-BR'
                  ? "Se sentir que precisa de uma pausa, que tal fazer um alongamento r√°pido ou tomar um copo d‚Äô√°gua? Pequenas a√ß√µes podem ajudar a recarregar. Se estiver cansado, nosso artigo sobre sono pode te ajudar: <a href='/blog/melhorar-qualidade-sono.html' class='text-[#22d3ee] hover:underline'>Como Melhorar a Qualidade do Sono</a>."
                  : "If you feel you need a break, how about a quick stretch or a glass of water? Small actions can help recharge. If you‚Äôre tired, our article on sleep might help: <a href='/blog/melhorar-qualidade-sono.html' class='text-[#22d3ee] hover:underline'>How to Improve Sleep Quality</a>.";
                break;
              case 'fear':
                diagnosis = lang === 'pt-BR'
                  ? "Detectamos sinais de medo ou preocupa√ß√£o em sua express√£o. Isso pode indicar que voc√™ est√° enfrentando uma situa√ß√£o que te deixa inseguro ou ansioso."
                  : "We detected signs of fear or concern in your expression. This may indicate that you‚Äôre facing a situation that makes you feel insecure or anxious.";
                suggestion = lang === 'pt-BR'
                  ? "Tente focar em algo que te traga conforto, como ouvir uma m√∫sica calma ou praticar a respira√ß√£o profunda. Se precisar de mais suporte, confira nosso artigo sobre redu√ß√£o de estresse: <a href='/blog/reduzir-estresse-trabalho.html' class='text-[#22d3ee] hover:underline'>5 Dicas para Reduzir o Estresse no Trabalho</a>."
                  : "Try focusing on something that brings you comfort, like listening to calm music or practicing deep breathing. If you need more support, check out our article on stress reduction: <a href='/blog/reduzir-estresse-trabalho.html' class='text-[#22d3ee] hover:underline'>5 Tips to Reduce Workplace Stress</a>.";
                additionalButton = `<div class="mt-4"><button onclick="window.location.href='/apoio-emocional'" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine" data-i18n="emotional-support" aria-label="${lang === 'pt-BR' ? 'Obter apoio emocional' : 'Get emotional support'}">${getTranslation(lang, 'emotional-support')}</button></div>`;
                break;
              case 'disgust':
                diagnosis = lang === 'pt-BR'
                  ? "Sua express√£o sugere desgosto, o que pode indicar que voc√™ est√° reagindo a algo que te incomodou ou que n√£o est√° alinhado aos seus valores."
                  : "Your expression suggests disgust, which may indicate that you‚Äôre reacting to something that bothered you or isn‚Äôt aligned with your values.";
                suggestion = lang === 'pt-BR'
                  ? "Se poss√≠vel, afaste-se daquilo que est√° te incomodando e foque em algo que te traga bem-estar. Um pequeno intervalo pode fazer diferen√ßa!"
                  : "If possible, step away from what‚Äôs bothering you and focus on something that brings you well-being. A short break can make a difference!";
                break;
              default:
                diagnosis = lang === 'pt-BR'
                  ? `Detectamos uma emo√ß√£o predominante de ${emotionInPortuguese}.`
                  : `We detected a predominant emotion of ${emotionInPortuguese}.`;
                suggestion = lang === 'pt-BR'
                  ? "Continue explorando como voc√™ se sente e o que pode estar causando essa emo√ß√£o."
                  : "Continue exploring how you feel and what might be causing this emotion.";
            }

            result.innerHTML = `<p class="fade-in">Pr√©-diagn√≥stico emocional: ${diagnosis}</p><p class="fade-in mt-2">${suggestion}</p><p class="text-sm mt-2 text-gray-300" data-i18n="disclaimer">${getTranslation(lang, 'disclaimer')}</p>${additionalButton}`;
            speak(diagnosis + " " + suggestion);
          } else {
            result.innerHTML = `<p class="fade-in" data-i18n="no-face-detected">${getTranslation(lang, 'no-face-detected')}</p><div class="mt-4"><button onclick="captureAndAnalyze()" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine" data-i18n="try-again" aria-label="${lang === 'pt-BR' ? 'Tentar novamente a an√°lise' : 'Try analyzing again'}">${getTranslation(lang, 'try-again')}</button></div>`;
            speak(getTranslation(lang, 'no-face-detected'));
          }
        })
        .catch(error => {
          console.error("Erro ao analisar:", error);
          result.innerHTML = `<p class="fade-in" data-i18n="error-analyzing">${getTranslation(lang, 'error-analyzing')}</p><div class="mt-4"><button onclick="captureAndAnalyze()" class="futuristic-btn text-white font-bold px-6 py-2 rounded-full text-sm shine" data-i18n="try-again" aria-label="${lang === 'pt-BR' ? 'Tentar novamente a an√°lise' : 'Try analyzing again'}">${getTranslation(lang, 'try-again')}</button></div>`;
          speak(getTranslation(lang, 'error-analyzing'));
        });
    }
  </script>
</body>
</html>
